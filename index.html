<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Utility Manager — Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #root { width: 100%; height: 100%; }
    body { background: #f2f6fc; font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f2f6fc; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    select option { background: #fff; color: #1f2937; }
    kbd { font-family: 'Inter', monospace !important; }
  </style>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-is/18.2.0/umd/react-is.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.15.3/Recharts.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useMemo, useCallback, useEffect, createContext, useContext } = React;
const { BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart, Area } = Recharts;



const LOGO_SRC = "data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCABgArwDASIAAhEBAxEB/8QAHAABAAMBAQEBAQAAAAAAAAAAAAIDBAEFBwgG/8QAPhAAAgICAAMEBAwEBgMBAAAAAAECAwQREiExBRNBUQYiYXEHFCMyM4GRobGywdFCUmJzCBU0Q3LhNVOC8f/EABsBAQEAAgMBAAAAAAAAAAAAAAABBAUDBgcC/8QAKREBAAEEAgAEBQUAAAAAAAAAAAECAwQRBTEGEoGREyJBYeFRcaHw8f/aAAwDAQACEQMRAD8A/GQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAX5sYxsgopLdUHyXsRQaM/wClr/tQ/KgM4AAAAAAAAB1Jt6XNgcLoUPhU7ZKqD6N9X7kSajjdUp3eT5qH7sgo2XOU5S29OW5Pm/cBLjx4fMqdj87HpfYv3OPIn0VdMV/ai/xRKddMI/SJtxT9qfLkO/rUJRVXWXF11p8v+/tAisia/hqfvqj+x3vapfSY8ffBuL/Ym8qMpuU6ltxcXp+bbb9/MygX9zCz/T2cT/klyl9XgylpptNNNdUy6zHnGbjHcmtvXjpeJ2NsbUoZD59I2eK9/mgM4J21yqm4SXP7mvMgAAAAFltFtUITnBqM1uL8yyOHkOnveDUdbW5JNrz0BnBohh5E6laoLha2tySbRHHxb705Vw3FdW3pAUgssptrt7qcGp+XmWW4WRVDjnBJct+stoDOCyVFsb+4cPlN64d+J10WrI7hx1ZvWtgVA024OTXXKydaUY9XxJkHjXq9Ud23Y1vS5gUgvvxL6IcdkPV6bTTWyFtFtUoqcGnNJx9oFYNEMLJlbOtVrihriXEuWyNuLfVLhnBJ6385MCkAAAAAAAAAAAAAAAAAAAD+++BD0Nj6W+lXHnUufZeClbkp9LG/mV/W02/YmJnTEz821g49eRen5aY3+P3nqH8CD6l8M3wXy9Ft9tdid5b2POWrK5PiljN9Nvxi+ifh0fm/lpInbj43ksfkseMjHq3TPvE/pP3AAVngAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGjP+lr/tQ/KjOaM/6Wv+1D8qAzgAAAAAAAGiv5CpW/7s/mf0rz/Yrx6+8tjFvUesn5JdSUnLIyNqMtPoorekBW4SUVNp6fidjOfCoLfXa112XZNiS7mpvg8d/p4r3HW/ikeGP+okub/kXkvaBHuK6ueTY1L/1w5y+vwRzvqY/MxYP2zk2/u0XY+HVKmFuRf3bteoLW9+8zZFUqL51S5uL0BPv6387Fp1/TtfqdUMa36Obpl5Te4/b4Gc9GPZ1b4ankJZMo8Shw8vdsDHKM6ZuFkWk9cS817yVsOP14Ja5dPFvwS9h2myMo9xe/U/hl4wf7ewg1Oi5xelJct9de1ATpffQ+Lzfrf7bfg/L3P8Shpp6fJk7+HvNwnxb5t+3xJ5XrqF6/j5S/5Lr+j+sCguw6u/ya6vBvn7vEpJQnOD3CTi9a2noD1cpQyaL4xurscX3lcY9YpcmvsK64LNUa7qbK7Y16jZ4NLptHnQnOD3CUovptPRN5OQ6+7d1jh5cRBtpisyNdN9NkJxhqFqXLWuWyGTCU+zsbuk5Ri5KXDz9bZl+MX933ffWcHTXEcqutqbdVkob66ZR6tLULsGFzStUJdfDfzTzXVfG7dlc01JcTafmUylKUuKUnKT8W+ZZPJyJwUJXWOK8HID03BLtLKyJSjBQSUZS6KTXIpzqHfHHnVONspfJylHo2v+jBK22aalZOSk9vb6sV221rULJxW98pa5kGvPjOutY9Vdipr5ylwvUpeZst28vKhD6WVC4NdenM8qeRkTi4zvslF9U5PRF2WOam7JOa6S3zA2YkZ14WU7YyjW46Sly3LwNN84WWU4trSTrjKuXlL/s8u2663Xe2TnrptkZTnJpynKTS0m30A9iaTyO0E65WLUfVT5s8y+tufyeNbWtdHt/oQjffGcpxusUpdWpPbEr75PcrrG/bJlFYAAAAAAAAAAAAAAAPa9EfRntX0n7QeH2ZVF8C3bbN6hWvNv8ARcz+8yfgW7RhiOeP23i25CW+7nTKEW/Li2/wP674B8Wij0DrvqS73IyLJWvx2nwpfYl9p/fHc+O4LGuY1Nd2NzVG++mZbsUzTuX5I7W7Ozeye0buz+0KJUZNMtThL8favaf3XwL/AAhWeiHaS7OzVCXY+Xcnc+FcVMnpd4n1a5La8unPr6v+I7Fohndj5kUlfbXbXN+LjFxcfzSPkp1fkMWMXIqs73Ef61PJ8dYzbNeNfjdM/wBiY+8P3Fn4mL2l2ddhZVcL8XJrddkXzUoyWmfjL0v7Hs9H/SftHsa1uTxL5Vxk/wCKPWMvri0/rP1j8F+RdlfB32DdkNux4NabfV6Wk/sSPz9/iLqhX8KGXKCW7MemU/fwJfgkYNPenlvgK7cxeTv4UzuNT70zrftM/wAPnQAPt64AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaM/wClr/tQ/KjOaM/6Wv8AtQ/KgM4AAAAAAAL6fVxrp+L1BfXzf4feMeLVcpuLcXuPTaeufPntHJcsKH9VkvuS/clDhjiSknYpvl/TrYDGe7Z5FnPgTm/a/D7yiUnKTlJ7be2y6Pq4E34ysS+pJ/uUAbcfLnTRCFmPGyKbdbkuj9hmyZWTvnK5NTb201o9C2mVnYtFkOcq9v6tvZHIqefFZOPp2aSshvnvzIPNPRjm3rhh8WTyFHhjNx9bXuIY+BYpd5lJVUx5ycn19hPFv+Mdtxt1pNvS9mmUec+vM0WfK4kZ/wAVT4H/AMX0/VfYUz+fL3luJzhfB9HW39jTArhVZOMpRi2orbZZV62NdD+XU19un+P3EsPbrtinWlpNua5f/pDE52Tj51z/ACt/oBSaOzoxlnVRlFSTlzTRnLcW3uMiFvDxcL3retgbsGcXbdTKihqEZyTcFvkyGJKM52ZdtFbjBKKhGHJt+wz4+T3V1tnBvjjKOt9Nkq8yyrGjTTutptykn84g0VY8K+0ra3FShwSlHa3y1yKOyYRnmKM4xkuF8mt+BOPaHr12W1Oc4wcJPi1xJ/URryqKbo2U4ri0mn8pve17gJ9m11RqlfdXxxlJVxTW/eyeHRVVkZVeRDijXB+HPXmij49bCmuqhupQXPT+c/MlPP4uNyq9edXdyfF19oFlmNGnCyHqMluLrnrrFkq8at4ix3X8tOt2qWua8l9hmrzGsN4048ceJNPfRb3osl2lkfGO8jJqG993vlryAwgndKM7ZzjHhUm2lveiBQAAAAAAAAAAAAAAAAAAAAAfQfgl9PK/RiVvZvacZy7OvnxqcFuVM9ab14p6W/cfVcn4RvQ2jEeR/nVdq1tQrhJzfs1rl9ej80g3OJzmTi2vhU6mI639HNReqpjT+k+EP0pu9LO3nmut041Ue7x6m+cY73t+1vr9S8DH6HejvaHpR2/j9kdnVuU7Zbss16tUPGcvYvv5Lqzxz7N/hj9JcbD7Vy/RrJhVCeb8tj28KUpTiucG+r5c0vDT8zU371d2ublc7mWj57OyMPAu5FinzVUxv8+nen3vsrCo7N7LxezsVONGLTCmtP8Alikl+B+SPha7Zr7d+EPtftCianR33c1ST5ONaUE17Hw7+s+2fDn8IuP2D2Zf6P8AZOQp9r5MHC2UH/pYNc234Ta6Lw6+W/zScNMfV0vwDw9635+Qvxqa41TvuY3uZ9Z1r1AAfb0oAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0Z/0tf9qH5UZzRn/S1/2oflQGcAAAAAAAF0ueFD+myX3pfsdSTxm1Gb0tPly3ve/sFPrY10PFamvq5P8AH7juK04yjKcYRW+bXPmtPX3Acj62BNeMbE/qaf7FBoxNd5Oib0rFw8/B+H3lEouMnGS009NAei77KMTBnXzeppp9GtrkcnXiWWNwtlh2rrCS5J+xkMj/AEWB75fiiHa//kbvevwRBbKnHT4sntB2pfwx22y6MIV9uUwrjwxUeS/+WeSexL/z1X/FflYHkz+fL3luJyhfN9FW19rSKp/Pl7y6z5LEjD+K18b/AOK6fq/sKGJpRsm4caS/lUtfUyOJysnLyrn+Vr9Sf0eLw8dkJyW3Hmt8/vWiNXq410/5tQX27f4feBQW4tXf5EKuLh4nret6Ki7BsjVl1WT5RUuYEqMbvJ3x49d1CUunXRdHExZUO744+GLSb7p9ftLFGGMsq2V1UlZCUYKMtt7KKpRXZl0HJcTsi0t82QIYakqHG3atm4p8PTT6lUad5ix+L/c4OLXt1s2Y9lapwU7Ipxsblz6c/Ei6VXnRveRQ4u5PlPb1sCNOFTZfOh5LVkZSWu78F49SCxarO8VGQ7JQhxJOGt+ZdjWVrte2bnFRbnqTfLxMmHN15VU1Lh1Jbfs8QO20d3jV2yn61nNQ14eZQaO0bO8zLGpKUU9R100ZygAAAAAAAAAAAAAAAAAAAAAAAAAABbi5F+Lk15ONdZTfVJTrsrk4yhJdGmujKgEmImNSlZOdtkrLJynOTcpSk9tt9W2RAC9AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaM/6Wv+1D8qM5oz/pa/7UPyoDOAAAAAAACzHs7u6Mmtx6SXmn1JSTxsnklLh5rfRrwZSaK/l6lV/uw+Z/UvL9gOZSi+GfexnNpcSXgTcXlw4or5eK9Zfzrz95nhFylwpcyduoxjwSaSe0/P2gdnfOVdVbS1Vvh5c+b8SORbK+6Vs0lKXXXQs7+u3lk1ty/9kOUvr8Gc7mmXzMqC9k4tP7tgUGl5lry45OoccVpLXLpoj3Fa+dlU6/p2/wBDqnjVfRwd0vOa1H7PEDtNSUfjN8X3e+Uf53+3tK3NW5HHc9KT56XQ7Gydt3HZJyeta11XkQthwva5xfR/oBZlWOUu7jNzgntfWMr1FChfwc5f8n1/RfUdpXcw+MSXrf7afi/P3L8Shtt7fNgcOxTlJRim23pJeJw0dmrefSv6gKXCSnwOL4t64dc9jgn3nd8EuPeuHXPZ6rdfef5i9clwtf19Pw5hUv8AzPKuSW6/m7elxNcibHlcE+87vglx71w657Ea5ym4RhJyXglzPUtqku0MS963Y0p6e1xLqW46hdnTvilGytyhYvNc9MbHjQhOe+CEpaW3pb0jkYylJRjFyb6JLmer2bXOrGjbFR3ZP1uJpeoveRjU8ZZ3d/SRS4Guqi34FHnzovhJRnVOLlyScep2ePfCLlOmyMV1bi0jTixtlLFunbKUXckott65o72jZW7bYRuyHLje4y+b194GSdF8I8U6bIx83FpFZ7174MrItV0p8EPWpSfijwQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGjP+lr/tQ/KjOX5soysg4tPVUFyfsQFAAAAAAAAB1Np7XJnABqU1kR1tV3+L6Kf7P8Slrhu1dGS0/WSWmVl0L3wqFsVbBdE+q9zAv4MfJzYxraqrcfdp6KoYrsrushNcNXn4nODHn8y11vysX6r9h3FiTUbamn11alv7WAhjuU6o8S3ZFyj9/L7i2qvGpypQyW3GMU17+T1op7ix6TnVpdN2x5fed7qqP0mRH3QTk/2AhfKuV8pVRag3tJ+HsLku6XHk89r1avF+W/JEO+hX/p6+F/zy5y+rwRS222222+rYErbJWzc5Pn9yXkQAAE6bJ1WKyt6lHo9EABJyk97b03vXtLLsq+2Mo2T2pSUpcktvWikAW15F1cIwjPSjLijyT0xXkXV3SthPU5b29ddlQAnbbZYoKctqEeGPLoixZeQrI2Kx8UY8Kel08n5lAA0WZl9koNyiuCXFHUUtM7bnZNsHCdiafX1V+xmAF3xq/4w8jj+Ua03pc+WuhS+bAAAAAAAP/Z";

// ─── DEMO DATA ────────────────────────────────────────────────────────────────

const MONTHS = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
const FULL_MONTHS = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
const YEARS = [2022, 2023, 2024, 2025, 2026];

// Build chronological month labels from filtered data (e.g. "Gen 24", "Feb 24", ...)
function buildTimeline(data, monthKey, aggFn) {
 const map = {};
 data.forEach(d => {
 const key = `${d.anno}-${String(d[monthKey]).padStart(2, "0")}`;
 if (!map[key]) map[key] = { anno: d.anno, mese: d[monthKey], rows: [] };
 map[key].rows.push(d);
 });
 return Object.keys(map).sort().map(k => {
 const { anno, mese, rows } = map[k];
 return { name: `${MONTHS[mese]} ${String(anno).slice(2)}`, ...aggFn(rows) };
 });
}

// ─── COMPANIES ────────────────────────────────────────────────────────────────
const COMPANIES = [
 { id: "all", name: " Tutte le Aziende (Aggregato)", short: "Aggregato" },
 { id: "edison", name: "EDISON ENERGIA — P.IVA 07760860010", short: "Edison", color: "#E85D04" },
];

const PODS = [
 { id: "IT001E00041140", site: "Edison — P.IVA 07760860010", city: "—", power: 28, client: "Edison Energia", company: "edison", cdc: "CC-EDI-001", person: "Energy Manager", dept: "Facility" },
 { id: "IT001E01241520", site: "Edison — P.IVA 07760860010", city: "—", power: 3, client: "Edison Energia", company: "edison", cdc: "CC-EDI-001", person: "Energy Manager", dept: "Facility" },
 { id: "IT001E02167194", site: "Edison — P.IVA 07760860010", city: "—", power: 14, client: "Edison Energia", company: "edison", cdc: "CC-EDI-001", person: "Energy Manager", dept: "Facility" },
 { id: "IT001E04005339", site: "Edison — P.IVA 07760860010", city: "—", power: 8, client: "Edison Energia", company: "edison", cdc: "CC-EDI-001", person: "Energy Manager", dept: "Facility" },
 { id: "IT002E0093090A", site: "Edison — P.IVA 07760860010", city: "—", power: 12, client: "Edison Energia", company: "edison", cdc: "CC-EDI-001", person: "Energy Manager", dept: "Facility" },
 { id: "IT012E00967743", site: "Edison — P.IVA 07760860010", city: "—", power: 19, client: "Edison Energia", company: "edison", cdc: "CC-EDI-001", person: "Energy Manager", dept: "Facility" },
 { id: "IT020E00010073", site: "Edison — P.IVA 07760860010", city: "—", power: 16, client: "Edison Energia", company: "edison", cdc: "CC-EDI-001", person: "Energy Manager", dept: "Facility" },
 { id: "IT020E13004335", site: "Edison — P.IVA 07760860010", city: "—", power: 16, client: "Edison Energia", company: "edison", cdc: "CC-EDI-001", person: "Energy Manager", dept: "Facility" },
 { id: "IT024E00189331", site: "Edison — P.IVA 07760860010", city: "—", power: 29, client: "Edison Energia", company: "edison", cdc: "CC-EDI-001", person: "Energy Manager", dept: "Facility" },
 { id: "IT253E16163274", site: "Edison — P.IVA 07760860010", city: "—", power: 12, client: "Edison Energia", company: "edison", cdc: "CC-EDI-001", person: "Energy Manager", dept: "Facility" },
];

const PDRS = [];
const MOBILE_LINES = [];
const FIXED_LINES = [];
const CONNECTIVITY = [];
const BUILDINGS = [];

// Generators removed — using real Edison data only
// ─── EDISON REAL DATA (imported from CSV) ───
const EDISON_ENERGY = [
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 0, meseEmissione: 1, consumoTotale: 5680, consumoF1: 2848, consumoF2: 1075, consumoF3: 1757, potenzaMax: 6.2, prezzoF1: 0.184241, prezzoF2: 0.184241, prezzoF3: 0.184241, importoEnergia: 1046.49, dispacciamento: 127.69, distribuzione: 0, oneriSistema: 290.25, accise: 71.00, iva: 337.79, conguaglio: 0.00, totaleNettoIVA: 1535.43, totaleFattura: 1873.22, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 1, meseEmissione: 2, consumoTotale: 5024, consumoF1: 2621, consumoF2: 1028, consumoF3: 1375, potenzaMax: 5.5, prezzoF1: 0.188664, prezzoF2: 0.188664, prezzoF3: 0.188664, importoEnergia: 947.85, dispacciamento: 116.28, distribuzione: 0, oneriSistema: 258.60, accise: 62.80, iva: 304.82, conguaglio: 0.00, totaleNettoIVA: 1385.53, totaleFattura: 1690.35, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 2, meseEmissione: 3, consumoTotale: 4499, consumoF1: 2198, consumoF2: 1014, consumoF3: 1287, potenzaMax: 4.9, prezzoF1: 0.154877, prezzoF2: 0.154877, prezzoF3: 0.154877, importoEnergia: 696.79, dispacciamento: 106.94, distribuzione: 0, oneriSistema: 232.98, accise: 56.24, iva: 240.45, conguaglio: 0.00, totaleNettoIVA: 1092.95, totaleFattura: 1333.40, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 3, meseEmissione: 4, consumoTotale: 2913, consumoF1: 1337, consumoF2: 616, consumoF3: 960, potenzaMax: 3.2, prezzoF1: 0.133371, prezzoF2: 0.133371, prezzoF3: 0.133371, importoEnergia: 388.51, dispacciamento: 84.09, distribuzione: 0, oneriSistema: 33.08, accise: 36.41, iva: 119.26, conguaglio: 0.00, totaleNettoIVA: 542.09, totaleFattura: 661.35, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 4, meseEmissione: 5, consumoTotale: 1852, consumoF1: 749, consumoF2: 439, consumoF3: 664, potenzaMax: 2.0, prezzoF1: 0.128413, prezzoF2: 0.128413, prezzoF3: 0.128413, importoEnergia: 237.82, dispacciamento: 47.31, distribuzione: 0, oneriSistema: 17.72, accise: 23.15, iva: 71.72, conguaglio: 0.00, totaleNettoIVA: 326.00, totaleFattura: 397.72, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 5, meseEmissione: 6, consumoTotale: 5578, consumoF1: 2902, consumoF2: 1092, consumoF3: 1584, potenzaMax: 6.1, prezzoF1: 0.145450, prezzoF2: 0.145450, prezzoF3: 0.145450, importoEnergia: 811.32, dispacciamento: 147.60, distribuzione: 0, oneriSistema: 56.36, accise: 69.72, iva: 238.70, conguaglio: 0.00, totaleNettoIVA: 1085.00, totaleFattura: 1323.70, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 6, meseEmissione: 7, consumoTotale: 3203, consumoF1: 1720, consumoF2: 617, consumoF3: 866, potenzaMax: 3.5, prezzoF1: 0.146791, prezzoF2: 0.146791, prezzoF3: 0.146791, importoEnergia: 470.17, dispacciamento: 78.80, distribuzione: 0, oneriSistema: 29.46, accise: 40.04, iva: 136.06, conguaglio: 0.00, totaleNettoIVA: 618.47, totaleFattura: 754.53, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 7, meseEmissione: 8, consumoTotale: 2890, consumoF1: 1424, consumoF2: 570, consumoF3: 896, potenzaMax: 3.2, prezzoF1: 0.140080, prezzoF2: 0.140080, prezzoF3: 0.140080, importoEnergia: 404.83, dispacciamento: 77.98, distribuzione: 0, oneriSistema: 30.00, accise: 36.13, iva: 120.77, conguaglio: 0.00, totaleNettoIVA: 548.94, totaleFattura: 669.71, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 8, meseEmissione: 9, consumoTotale: 2433, consumoF1: 1233, consumoF2: 492, consumoF3: 708, potenzaMax: 2.7, prezzoF1: 0.141587, prezzoF2: 0.141587, prezzoF3: 0.141587, importoEnergia: 344.48, dispacciamento: 63.38, distribuzione: 0, oneriSistema: 24.06, accise: 30.41, iva: 101.71, conguaglio: 0.00, totaleNettoIVA: 462.33, totaleFattura: 564.04, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 9, meseEmissione: 10, consumoTotale: 3517, consumoF1: 1469, consumoF2: 780, consumoF3: 1268, potenzaMax: 3.9, prezzoF1: 0.146363, prezzoF2: 0.146363, prezzoF3: 0.146363, importoEnergia: 514.76, dispacciamento: 94.38, distribuzione: 0, oneriSistema: 185.20, accise: 43.96, iva: 184.43, conguaglio: 0.00, totaleNettoIVA: 838.30, totaleFattura: 1022.73, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 10, meseEmissione: 11, consumoTotale: 4803, consumoF1: 1575, consumoF2: 897, consumoF3: 2331, potenzaMax: 5.3, prezzoF1: 0.152078, prezzoF2: 0.152078, prezzoF3: 0.152078, importoEnergia: 730.43, dispacciamento: 110.51, distribuzione: 0, oneriSistema: 243.57, accise: 60.04, iva: 251.80, conguaglio: 0.00, totaleNettoIVA: 1144.55, totaleFattura: 1396.35, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E00041140", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 11, meseEmissione: 0, consumoTotale: 5410, consumoF1: 2550, consumoF2: 998, consumoF3: 1862, potenzaMax: 5.9, prezzoF1: 0.153932, prezzoF2: 0.153932, prezzoF3: 0.153932, importoEnergia: 832.77, dispacciamento: 121.36, distribuzione: 0, oneriSistema: 272.64, accise: 67.63, iva: 284.77, conguaglio: 0.00, totaleNettoIVA: 1294.40, totaleFattura: 1579.17, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 0, meseEmissione: 1, consumoTotale: 446, consumoF1: 196, consumoF2: 87, consumoF3: 163, potenzaMax: 0.5, prezzoF1: 0.190605, prezzoF2: 0.190605, prezzoF3: 0.190605, importoEnergia: 85.01, dispacciamento: 16.09, distribuzione: 0, oneriSistema: 26.41, accise: 5.58, iva: 29.28, conguaglio: 0.00, totaleNettoIVA: 133.09, totaleFattura: 162.37, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 1, meseEmissione: 2, consumoTotale: 365, consumoF1: 170, consumoF2: 79, consumoF3: 116, potenzaMax: 0.4, prezzoF1: 0.195151, prezzoF2: 0.195151, prezzoF3: 0.195151, importoEnergia: 71.23, dispacciamento: 15.07, distribuzione: 0, oneriSistema: 22.71, accise: 4.56, iva: 24.99, conguaglio: 0.00, totaleNettoIVA: 113.57, totaleFattura: 138.56, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 2, meseEmissione: 3, consumoTotale: 384, consumoF1: 170, consumoF2: 87, consumoF3: 127, potenzaMax: 0.4, prezzoF1: 0.153229, prezzoF2: 0.153229, prezzoF3: 0.153229, importoEnergia: 58.84, dispacciamento: 15.31, distribuzione: 0, oneriSistema: 23.57, accise: 4.80, iva: 22.55, conguaglio: 0.00, totaleNettoIVA: 102.52, totaleFattura: 125.07, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 3, meseEmissione: 4, consumoTotale: 365, consumoF1: 157, consumoF2: 76, consumoF3: 132, potenzaMax: 0.4, prezzoF1: 0.128767, prezzoF2: 0.128767, prezzoF3: 0.128767, importoEnergia: 47.00, dispacciamento: 15.07, distribuzione: 0, oneriSistema: 22.26, accise: 4.56, iva: 19.56, conguaglio: 0.00, totaleNettoIVA: 88.89, totaleFattura: 108.45, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 4, meseEmissione: 5, consumoTotale: 380, consumoF1: 165, consumoF2: 85, consumoF3: 130, potenzaMax: 0.4, prezzoF1: 0.121158, prezzoF2: 0.121158, prezzoF3: 0.121158, importoEnergia: 46.04, dispacciamento: 15.26, distribuzione: 0, oneriSistema: 22.93, accise: 4.75, iva: 19.58, conguaglio: 0.00, totaleNettoIVA: 88.98, totaleFattura: 108.56, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 5, meseEmissione: 6, consumoTotale: 512, consumoF1: 287, consumoF2: 84, consumoF3: 141, potenzaMax: 0.6, prezzoF1: 0.150527, prezzoF2: 0.150527, prezzoF3: 0.150527, importoEnergia: 77.07, dispacciamento: 16.92, distribuzione: 0, oneriSistema: 28.93, accise: 6.40, iva: 28.45, conguaglio: 0.00, totaleNettoIVA: 129.32, totaleFattura: 157.77, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 6, meseEmissione: 7, consumoTotale: 683, consumoF1: 379, consumoF2: 125, consumoF3: 179, potenzaMax: 0.7, prezzoF1: 0.166369, prezzoF2: 0.166369, prezzoF3: 0.166369, importoEnergia: 113.63, dispacciamento: 19.08, distribuzione: 0, oneriSistema: 36.70, accise: 8.54, iva: 39.15, conguaglio: 0.00, totaleNettoIVA: 177.95, totaleFattura: 217.10, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 7, meseEmissione: 8, consumoTotale: 462, consumoF1: 237, consumoF2: 86, consumoF3: 139, potenzaMax: 0.5, prezzoF1: 0.142511, prezzoF2: 0.142511, prezzoF3: 0.142511, importoEnergia: 65.84, dispacciamento: 16.29, distribuzione: 0, oneriSistema: 26.66, accise: 5.78, iva: 25.21, conguaglio: 0.00, totaleNettoIVA: 114.57, totaleFattura: 139.78, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 8, meseEmissione: 9, consumoTotale: 413, consumoF1: 216, consumoF2: 79, consumoF3: 118, potenzaMax: 0.5, prezzoF1: 0.140000, prezzoF2: 0.140000, prezzoF3: 0.140000, importoEnergia: 57.82, dispacciamento: 15.67, distribuzione: 0, oneriSistema: 24.43, accise: 5.16, iva: 22.68, conguaglio: 0.00, totaleNettoIVA: 103.08, totaleFattura: 125.76, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 9, meseEmissione: 10, consumoTotale: 363, consumoF1: 172, consumoF2: 79, consumoF3: 112, potenzaMax: 0.4, prezzoF1: 0.144711, prezzoF2: 0.144711, prezzoF3: 0.144711, importoEnergia: 52.53, dispacciamento: 15.04, distribuzione: 0, oneriSistema: 22.17, accise: 4.54, iva: 20.74, conguaglio: 0.00, totaleNettoIVA: 94.28, totaleFattura: 115.02, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 10, meseEmissione: 11, consumoTotale: 386, consumoF1: 167, consumoF2: 81, consumoF3: 138, potenzaMax: 0.4, prezzoF1: 0.153601, prezzoF2: 0.153601, prezzoF3: 0.153601, importoEnergia: 59.29, dispacciamento: 15.33, distribuzione: 0, oneriSistema: 23.21, accise: 4.83, iva: 22.59, conguaglio: 0.00, totaleNettoIVA: 102.66, totaleFattura: 125.25, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E01241520", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 11, meseEmissione: 0, consumoTotale: 501, consumoF1: 207, consumoF2: 100, consumoF3: 194, potenzaMax: 0.5, prezzoF1: 0.155329, prezzoF2: 0.155329, prezzoF3: 0.155329, importoEnergia: 77.82, dispacciamento: 16.79, distribuzione: 0, oneriSistema: 28.43, accise: 6.26, iva: 28.45, conguaglio: 0.00, totaleNettoIVA: 129.30, totaleFattura: 157.75, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 0, meseEmissione: 1, consumoTotale: 1219, consumoF1: 492, consumoF2: 240, consumoF3: 487, potenzaMax: 1.3, prezzoF1: 0.186202, prezzoF2: 0.186202, prezzoF3: 0.186202, importoEnergia: 226.98, dispacciamento: 32.38, distribuzione: 0, oneriSistema: 63.65, accise: 15.24, iva: 74.41, conguaglio: 0.00, totaleNettoIVA: 338.25, totaleFattura: 412.66, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 1, meseEmissione: 2, consumoTotale: 1103, consumoF1: 476, consumoF2: 228, consumoF3: 399, potenzaMax: 1.2, prezzoF1: 0.190798, prezzoF2: 0.190798, prezzoF3: 0.190798, importoEnergia: 210.45, dispacciamento: 30.41, distribuzione: 0, oneriSistema: 58.34, accise: 13.79, iva: 68.86, conguaglio: 0.00, totaleNettoIVA: 312.99, totaleFattura: 381.85, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 2, meseEmissione: 3, consumoTotale: 1136, consumoF1: 473, consumoF2: 240, consumoF3: 423, potenzaMax: 1.2, prezzoF1: 0.150810, prezzoF2: 0.150810, prezzoF3: 0.150810, importoEnergia: 171.32, dispacciamento: 31.18, distribuzione: 0, oneriSistema: 59.84, accise: 14.20, iva: 60.84, conguaglio: 0.00, totaleNettoIVA: 276.54, totaleFattura: 337.38, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 3, meseEmissione: 4, consumoTotale: 1664, consumoF1: 605, consumoF2: 338, consumoF3: 721, potenzaMax: 1.8, prezzoF1: 0.125962, prezzoF2: 0.125962, prezzoF3: 0.125962, importoEnergia: 209.60, dispacciamento: 56.99, distribuzione: 0, oneriSistema: 23.17, accise: 20.80, iva: 68.32, conguaglio: 0.00, totaleNettoIVA: 310.56, totaleFattura: 378.88, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 4, meseEmissione: 5, consumoTotale: 1972, consumoF1: 684, consumoF2: 454, consumoF3: 834, potenzaMax: 2.2, prezzoF1: 0.120735, prezzoF2: 0.120735, prezzoF3: 0.120735, importoEnergia: 238.09, dispacciamento: 45.04, distribuzione: 0, oneriSistema: 16.58, accise: 24.65, iva: 71.36, conguaglio: 0.00, totaleNettoIVA: 324.36, totaleFattura: 395.72, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 5, meseEmissione: 6, consumoTotale: 2375, consumoF1: 1031, consumoF2: 467, consumoF3: 877, potenzaMax: 2.6, prezzoF1: 0.150219, prezzoF2: 0.150219, prezzoF3: 0.150219, importoEnergia: 356.77, dispacciamento: 73.53, distribuzione: 0, oneriSistema: 29.92, accise: 29.69, iva: 107.78, conguaglio: 0.00, totaleNettoIVA: 489.91, totaleFattura: 597.69, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 6, meseEmissione: 7, consumoTotale: 2759, consumoF1: 1132, consumoF2: 606, consumoF3: 1021, potenzaMax: 3.0, prezzoF1: 0.162360, prezzoF2: 0.162360, prezzoF3: 0.162360, importoEnergia: 447.95, dispacciamento: 75.33, distribuzione: 0, oneriSistema: 29.59, accise: 34.49, iva: 129.22, conguaglio: 0.00, totaleNettoIVA: 587.36, totaleFattura: 716.58, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 7, meseEmissione: 8, consumoTotale: 2846, consumoF1: 960, consumoF2: 657, consumoF3: 1229, potenzaMax: 3.1, prezzoF1: 0.140777, prezzoF2: 0.140777, prezzoF3: 0.140777, importoEnergia: 400.65, dispacciamento: 67.63, distribuzione: 0, oneriSistema: 25.34, accise: 35.58, iva: 116.42, conguaglio: 0.00, totaleNettoIVA: 529.20, totaleFattura: 645.62, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 8, meseEmissione: 9, consumoTotale: 2274, consumoF1: 850, consumoF2: 517, consumoF3: 907, potenzaMax: 2.5, prezzoF1: 0.139947, prezzoF2: 0.139947, prezzoF3: 0.139947, importoEnergia: 318.24, dispacciamento: 57.48, distribuzione: 0, oneriSistema: 22.05, accise: 28.43, iva: 93.76, conguaglio: 0.00, totaleNettoIVA: 426.20, totaleFattura: 519.96, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 9, meseEmissione: 10, consumoTotale: 1224, consumoF1: 507, consumoF2: 256, consumoF3: 461, potenzaMax: 1.3, prezzoF1: 0.141895, prezzoF2: 0.141895, prezzoF3: 0.141895, importoEnergia: 173.68, dispacciamento: 31.34, distribuzione: 0, oneriSistema: 62.99, accise: 15.30, iva: 62.33, conguaglio: 0.00, totaleNettoIVA: 283.31, totaleFattura: 345.64, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 10, meseEmissione: 11, consumoTotale: 1089, consumoF1: 448, consumoF2: 211, consumoF3: 430, potenzaMax: 1.2, prezzoF1: 0.151341, prezzoF2: 0.151341, prezzoF3: 0.151341, importoEnergia: 164.81, dispacciamento: 30.47, distribuzione: 0, oneriSistema: 56.86, accise: 13.61, iva: 58.47, conguaglio: 0.00, totaleNettoIVA: 265.75, totaleFattura: 324.22, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E02167194", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 11, meseEmissione: 0, consumoTotale: 1086, consumoF1: 424, consumoF2: 205, consumoF3: 457, potenzaMax: 1.2, prezzoF1: 0.153527, prezzoF2: 0.153527, prezzoF3: 0.153527, importoEnergia: 166.73, dispacciamento: 30.64, distribuzione: 0, oneriSistema: 56.72, accise: 13.58, iva: 58.89, conguaglio: 0.00, totaleNettoIVA: 267.67, totaleFattura: 326.56, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 0, meseEmissione: 1, consumoTotale: 1213, consumoF1: 506, consumoF2: 235, consumoF3: 472, potenzaMax: 1.3, prezzoF1: 0.187461, prezzoF2: 0.187461, prezzoF3: 0.187461, importoEnergia: 227.39, dispacciamento: 76.14, distribuzione: 0, oneriSistema: 88.84, accise: 15.16, iva: 89.66, conguaglio: 0.00, totaleNettoIVA: 407.53, totaleFattura: 497.19, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 1, meseEmissione: 2, consumoTotale: 1124, consumoF1: 500, consumoF2: 227, consumoF3: 397, potenzaMax: 1.2, prezzoF1: 0.191192, prezzoF2: 0.191192, prezzoF3: 0.191192, importoEnergia: 214.90, dispacciamento: 75.02, distribuzione: 0, oneriSistema: 84.78, accise: 14.05, iva: 85.53, conguaglio: 0.00, totaleNettoIVA: 388.75, totaleFattura: 474.28, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 2, meseEmissione: 3, consumoTotale: 1202, consumoF1: 507, consumoF2: 252, consumoF3: 443, potenzaMax: 1.3, prezzoF1: 0.151223, prezzoF2: 0.151223, prezzoF3: 0.151223, importoEnergia: 181.77, dispacciamento: 76.00, distribuzione: 0, oneriSistema: 88.35, accise: 15.03, iva: 79.45, conguaglio: 0.00, totaleNettoIVA: 361.15, totaleFattura: 440.60, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 3, meseEmissione: 4, consumoTotale: 1122, consumoF1: 466, consumoF2: 216, consumoF3: 440, potenzaMax: 1.2, prezzoF1: 0.128030, prezzoF2: 0.128030, prezzoF3: 0.128030, importoEnergia: 143.65, dispacciamento: 75.00, distribuzione: 0, oneriSistema: 35.06, accise: 14.03, iva: 58.90, conguaglio: 0.00, totaleNettoIVA: 267.74, totaleFattura: 326.64, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 4, meseEmissione: 5, consumoTotale: 1076, consumoF1: 458, consumoF2: 223, consumoF3: 395, potenzaMax: 1.2, prezzoF1: 0.120362, prezzoF2: 0.120362, prezzoF3: 0.120362, importoEnergia: 129.51, dispacciamento: 74.41, distribuzione: 0, oneriSistema: 34.92, accise: 13.45, iva: 55.50, conguaglio: 0.00, totaleNettoIVA: 252.29, totaleFattura: 307.79, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 5, meseEmissione: 6, consumoTotale: 1075, consumoF1: 456, consumoF2: 205, consumoF3: 414, potenzaMax: 1.2, prezzoF1: 0.146140, prezzoF2: 0.146140, prezzoF3: 0.146140, importoEnergia: 157.10, dispacciamento: 74.40, distribuzione: 0, oneriSistema: 34.92, accise: 13.44, iva: 61.57, conguaglio: 0.00, totaleNettoIVA: 279.86, totaleFattura: 341.43, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 6, meseEmissione: 7, consumoTotale: 1212, consumoF1: 552, consumoF2: 242, consumoF3: 418, potenzaMax: 1.3, prezzoF1: 0.161205, prezzoF2: 0.161205, prezzoF3: 0.161205, importoEnergia: 195.38, dispacciamento: 76.13, distribuzione: 0, oneriSistema: 35.33, accise: 15.15, iva: 70.84, conguaglio: 0.00, totaleNettoIVA: 321.99, totaleFattura: 392.83, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 7, meseEmissione: 8, consumoTotale: 1497, consumoF1: 583, consumoF2: 325, consumoF3: 589, potenzaMax: 1.6, prezzoF1: 0.141423, prezzoF2: 0.141423, prezzoF3: 0.141423, importoEnergia: 211.71, dispacciamento: 79.72, distribuzione: 0, oneriSistema: 36.23, accise: 18.71, iva: 76.20, conguaglio: 0.00, totaleNettoIVA: 346.37, totaleFattura: 422.57, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 8, meseEmissione: 9, consumoTotale: 1678, consumoF1: 704, consumoF2: 356, consumoF3: 618, potenzaMax: 1.8, prezzoF1: 0.139785, prezzoF2: 0.139785, prezzoF3: 0.139785, importoEnergia: 234.56, dispacciamento: 82.00, distribuzione: 0, oneriSistema: 36.80, accise: 20.98, iva: 82.35, conguaglio: 0.00, totaleNettoIVA: 374.34, totaleFattura: 456.69, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 9, meseEmissione: 10, consumoTotale: 1722, consumoF1: 729, consumoF2: 363, consumoF3: 630, potenzaMax: 1.9, prezzoF1: 0.143235, prezzoF2: 0.143235, prezzoF3: 0.143235, importoEnergia: 246.65, dispacciamento: 82.55, distribuzione: 0, oneriSistema: 109.74, accise: 21.53, iva: 101.30, conguaglio: 0.00, totaleNettoIVA: 460.47, totaleFattura: 561.77, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 10, meseEmissione: 11, consumoTotale: 1665, consumoF1: 643, consumoF2: 335, consumoF3: 687, potenzaMax: 1.8, prezzoF1: 0.150955, prezzoF2: 0.150955, prezzoF3: 0.150955, importoEnergia: 251.34, dispacciamento: 81.84, distribuzione: 0, oneriSistema: 107.16, accise: 20.81, iva: 101.45, conguaglio: 0.00, totaleNettoIVA: 461.15, totaleFattura: 562.60, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT001E04005339", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 11, meseEmissione: 0, consumoTotale: 1794, consumoF1: 638, consumoF2: 361, consumoF3: 795, potenzaMax: 2.0, prezzoF1: 0.152776, prezzoF2: 0.152776, prezzoF3: 0.152776, importoEnergia: 274.08, dispacciamento: 83.46, distribuzione: 0, oneriSistema: 113.02, accise: 22.43, iva: 108.46, conguaglio: 0.00, totaleNettoIVA: 492.99, totaleFattura: 601.45, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 0, meseEmissione: 1, consumoTotale: 1878, consumoF1: 632, consumoF2: 417, consumoF3: 829, potenzaMax: 2.1, prezzoF1: 0.178924, prezzoF2: 0.178924, prezzoF3: 0.178924, importoEnergia: 336.02, dispacciamento: 103.90, distribuzione: 0, oneriSistema: 135.24, accise: 23.48, iva: 131.70, conguaglio: 0.00, totaleNettoIVA: 598.64, totaleFattura: 730.34, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 1, meseEmissione: 2, consumoTotale: 1841, consumoF1: 639, consumoF2: 439, consumoF3: 763, potenzaMax: 2.0, prezzoF1: 0.185986, prezzoF2: 0.185986, prezzoF3: 0.185986, importoEnergia: 342.40, dispacciamento: 103.44, distribuzione: 0, oneriSistema: 133.54, accise: 23.01, iva: 132.53, conguaglio: 0.00, totaleNettoIVA: 602.39, totaleFattura: 734.92, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 2, meseEmissione: 3, consumoTotale: 2251, consumoF1: 785, consumoF2: 531, consumoF3: 935, potenzaMax: 2.5, prezzoF1: 0.151853, prezzoF2: 0.151853, prezzoF3: 0.151853, importoEnergia: 341.82, dispacciamento: 108.57, distribuzione: 0, oneriSistema: 152.32, accise: 28.14, iva: 138.79, conguaglio: 0.00, totaleNettoIVA: 630.85, totaleFattura: 769.64, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 3, meseEmissione: 4, consumoTotale: 1988, consumoF1: 696, consumoF2: 418, consumoF3: 874, potenzaMax: 2.2, prezzoF1: 0.129668, prezzoF2: 0.129668, prezzoF3: 0.129668, importoEnergia: 257.78, dispacciamento: 105.28, distribuzione: 0, oneriSistema: 52.85, accise: 24.85, iva: 96.97, conguaglio: 0.00, totaleNettoIVA: 440.76, totaleFattura: 537.73, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 4, meseEmissione: 5, consumoTotale: 2054, consumoF1: 710, consumoF2: 466, consumoF3: 878, potenzaMax: 2.3, prezzoF1: 0.121977, prezzoF2: 0.121977, prezzoF3: 0.121977, importoEnergia: 250.54, dispacciamento: 107.05, distribuzione: 0, oneriSistema: 53.05, accise: 25.68, iva: 95.99, conguaglio: 0.00, totaleNettoIVA: 436.32, totaleFattura: 532.31, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 5, meseEmissione: 6, consumoTotale: 1802, consumoF1: 699, consumoF2: 347, consumoF3: 756, potenzaMax: 2.0, prezzoF1: 0.142542, prezzoF2: 0.142542, prezzoF3: 0.142542, importoEnergia: 256.86, dispacciamento: 102.96, distribuzione: 0, oneriSistema: 52.28, accise: 22.53, iva: 95.62, conguaglio: 0.00, totaleNettoIVA: 434.63, totaleFattura: 530.25, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 6, meseEmissione: 7, consumoTotale: 2022, consumoF1: 712, consumoF2: 448, consumoF3: 862, potenzaMax: 2.2, prezzoF1: 0.148907, prezzoF2: 0.148907, prezzoF3: 0.148907, importoEnergia: 301.09, dispacciamento: 106.64, distribuzione: 0, oneriSistema: 52.95, accise: 25.28, iva: 106.91, conguaglio: 0.00, totaleNettoIVA: 485.96, totaleFattura: 592.87, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 7, meseEmissione: 8, consumoTotale: 1922, consumoF1: 805, consumoF2: 379, consumoF3: 738, potenzaMax: 2.1, prezzoF1: 0.140239, prezzoF2: 0.140239, prezzoF3: 0.140239, importoEnergia: 269.54, dispacciamento: 104.45, distribuzione: 0, oneriSistema: 52.65, accise: 24.03, iva: 99.15, conguaglio: 0.00, totaleNettoIVA: 450.67, totaleFattura: 549.82, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 8, meseEmissione: 9, consumoTotale: 1978, consumoF1: 769, consumoF2: 434, consumoF3: 775, potenzaMax: 2.2, prezzoF1: 0.140091, prezzoF2: 0.140091, prezzoF3: 0.140091, importoEnergia: 277.10, dispacciamento: 115.16, distribuzione: 0, oneriSistema: 52.83, accise: 24.73, iva: 103.36, conguaglio: 0.00, totaleNettoIVA: 469.82, totaleFattura: 573.18, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 9, meseEmissione: 10, consumoTotale: 2162, consumoF1: 856, consumoF2: 473, consumoF3: 833, potenzaMax: 2.4, prezzoF1: 0.144505, prezzoF2: 0.144505, prezzoF3: 0.144505, importoEnergia: 312.42, dispacciamento: 117.49, distribuzione: 0, oneriSistema: 144.80, accise: 27.03, iva: 132.38, conguaglio: 0.00, totaleNettoIVA: 601.74, totaleFattura: 734.12, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 10, meseEmissione: 11, consumoTotale: 2101, consumoF1: 748, consumoF2: 444, consumoF3: 909, potenzaMax: 2.3, prezzoF1: 0.151761, prezzoF2: 0.151761, prezzoF3: 0.151761, importoEnergia: 318.85, dispacciamento: 116.71, distribuzione: 0, oneriSistema: 142.05, accise: 26.26, iva: 132.85, conguaglio: 0.00, totaleNettoIVA: 603.87, totaleFattura: 736.72, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT002E0093090A", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 11, meseEmissione: 0, consumoTotale: 2060, consumoF1: 687, consumoF2: 437, consumoF3: 936, potenzaMax: 2.3, prezzoF1: 0.149757, prezzoF2: 0.149757, prezzoF3: 0.149757, importoEnergia: 308.50, dispacciamento: 116.19, distribuzione: 0, oneriSistema: 140.18, accise: 25.75, iva: 129.94, conguaglio: 0.00, totaleNettoIVA: 590.62, totaleFattura: 720.56, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 0, meseEmissione: 1, consumoTotale: 3827, consumoF1: 2084, consumoF2: 566, consumoF3: 1177, potenzaMax: 4.2, prezzoF1: 0.191779, prezzoF2: 0.191779, prezzoF3: 0.191779, importoEnergia: 733.94, dispacciamento: 93.26, distribuzione: 0, oneriSistema: 200.62, accise: 47.84, iva: 236.65, conguaglio: 0.00, totaleNettoIVA: 1075.66, totaleFattura: 1312.31, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 1, meseEmissione: 2, consumoTotale: 3507, consumoF1: 1952, consumoF2: 564, consumoF3: 991, potenzaMax: 3.8, prezzoF1: 0.192466, prezzoF2: 0.192466, prezzoF3: 0.192466, importoEnergia: 674.98, dispacciamento: 89.04, distribuzione: 0, oneriSistema: 185.96, accise: 43.84, iva: 218.64, conguaglio: 0.00, totaleNettoIVA: 993.82, totaleFattura: 1212.46, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 2, meseEmissione: 3, consumoTotale: 3395, consumoF1: 1770, consumoF2: 590, consumoF3: 1035, potenzaMax: 3.7, prezzoF1: 0.151835, prezzoF2: 0.151835, prezzoF3: 0.151835, importoEnergia: 515.48, dispacciamento: 85.05, distribuzione: 0, oneriSistema: 179.23, accise: 42.44, iva: 180.88, conguaglio: 0.00, totaleNettoIVA: 822.20, totaleFattura: 1003.08, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 3, meseEmissione: 4, consumoTotale: 3296, consumoF1: 1620, consumoF2: 541, consumoF3: 1135, potenzaMax: 3.6, prezzoF1: 0.128486, prezzoF2: 0.128486, prezzoF3: 0.128486, importoEnergia: 423.49, dispacciamento: 78.83, distribuzione: 0, oneriSistema: 29.75, accise: 41.20, iva: 126.12, conguaglio: 0.00, totaleNettoIVA: 573.27, totaleFattura: 699.39, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 4, meseEmissione: 5, consumoTotale: 3046, consumoF1: 1432, consumoF2: 576, consumoF3: 1038, potenzaMax: 3.3, prezzoF1: 0.120630, prezzoF2: 0.120630, prezzoF3: 0.120630, importoEnergia: 367.44, dispacciamento: 78.52, distribuzione: 0, oneriSistema: 30.48, accise: 38.08, iva: 113.19, conguaglio: 0.00, totaleNettoIVA: 514.52, totaleFattura: 627.71, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 5, meseEmissione: 6, consumoTotale: 3018, consumoF1: 1418, consumoF2: 525, consumoF3: 1075, potenzaMax: 3.3, prezzoF1: 0.146981, prezzoF2: 0.146981, prezzoF3: 0.146981, importoEnergia: 443.59, dispacciamento: 67.79, distribuzione: 0, oneriSistema: 24.36, accise: 37.73, iva: 126.16, conguaglio: 0.00, totaleNettoIVA: 573.47, totaleFattura: 699.63, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 6, meseEmissione: 7, consumoTotale: 2926, consumoF1: 1624, consumoF2: 490, consumoF3: 812, potenzaMax: 3.2, prezzoF1: 0.162884, prezzoF2: 0.162884, prezzoF3: 0.162884, importoEnergia: 476.60, dispacciamento: 66.04, distribuzione: 0, oneriSistema: 24.06, accise: 36.58, iva: 132.72, conguaglio: 0.00, totaleNettoIVA: 603.28, totaleFattura: 736.00, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 7, meseEmissione: 8, consumoTotale: 2641, consumoF1: 1320, consumoF2: 465, consumoF3: 856, potenzaMax: 2.9, prezzoF1: 0.140617, prezzoF2: 0.140617, prezzoF3: 0.140617, importoEnergia: 371.37, dispacciamento: 62.69, distribuzione: 0, oneriSistema: 23.18, accise: 33.01, iva: 107.86, conguaglio: 0.00, totaleNettoIVA: 490.25, totaleFattura: 598.11, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 8, meseEmissione: 9, consumoTotale: 2706, consumoF1: 1441, consumoF2: 475, consumoF3: 790, potenzaMax: 3.0, prezzoF1: 0.139010, prezzoF2: 0.139010, prezzoF3: 0.139010, importoEnergia: 376.16, dispacciamento: 63.22, distribuzione: 0, oneriSistema: 23.39, accise: 33.83, iva: 109.25, conguaglio: 0.00, totaleNettoIVA: 496.60, totaleFattura: 605.85, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 9, meseEmissione: 10, consumoTotale: 2893, consumoF1: 1730, consumoF2: 436, consumoF3: 727, potenzaMax: 3.2, prezzoF1: 0.143709, prezzoF2: 0.143709, prezzoF3: 0.143709, importoEnergia: 415.75, dispacciamento: 80.24, distribuzione: 0, oneriSistema: 152.33, accise: 36.16, iva: 150.59, conguaglio: 0.00, totaleNettoIVA: 684.48, totaleFattura: 835.07, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 10, meseEmissione: 11, consumoTotale: 2997, consumoF1: 1687, consumoF2: 443, consumoF3: 867, potenzaMax: 3.3, prezzoF1: 0.154481, prezzoF2: 0.154481, prezzoF3: 0.154481, importoEnergia: 462.98, dispacciamento: 82.05, distribuzione: 0, oneriSistema: 157.07, accise: 37.46, iva: 162.70, conguaglio: 0.00, totaleNettoIVA: 739.56, totaleFattura: 902.26, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT012E00967743", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 11, meseEmissione: 0, consumoTotale: 3422, consumoF1: 1904, consumoF2: 465, consumoF3: 1053, potenzaMax: 3.8, prezzoF1: 0.157490, prezzoF2: 0.157490, prezzoF3: 0.157490, importoEnergia: 538.93, dispacciamento: 93.35, distribuzione: 0, oneriSistema: 179.38, accise: 42.78, iva: 187.98, conguaglio: 0.00, totaleNettoIVA: 854.44, totaleFattura: 1042.42, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 0, meseEmissione: 1, consumoTotale: 1361, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 1.5, prezzoF1: 0.180904, prezzoF2: 0.180904, prezzoF3: 0.180904, importoEnergia: 246.21, dispacciamento: 97.43, distribuzione: 0, oneriSistema: 111.56, accise: 17.01, iva: 103.89, conguaglio: 0.00, totaleNettoIVA: 472.21, totaleFattura: 576.10, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 1, meseEmissione: 2, consumoTotale: 1460, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 1.6, prezzoF1: 0.187212, prezzoF2: 0.187212, prezzoF3: 0.187212, importoEnergia: 273.33, dispacciamento: 98.67, distribuzione: 0, oneriSistema: 116.09, accise: 18.25, iva: 111.39, conguaglio: 0.00, totaleNettoIVA: 506.34, totaleFattura: 617.73, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 2, meseEmissione: 3, consumoTotale: 976, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 1.1, prezzoF1: 0.152951, prezzoF2: 0.152951, prezzoF3: 0.152951, importoEnergia: 149.28, dispacciamento: 92.60, distribuzione: 0, oneriSistema: 93.93, accise: 12.20, iva: 76.56, conguaglio: 0.00, totaleNettoIVA: 348.01, totaleFattura: 424.57, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 3, meseEmissione: 4, consumoTotale: 1033, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 1.1, prezzoF1: 0.130833, prezzoF2: 0.130833, prezzoF3: 0.130833, importoEnergia: 135.15, dispacciamento: 93.32, distribuzione: 0, oneriSistema: 49.88, accise: 12.91, iva: 64.08, conguaglio: 0.00, totaleNettoIVA: 291.26, totaleFattura: 355.34, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 4, meseEmissione: 5, consumoTotale: 810, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 0.9, prezzoF1: 0.123679, prezzoF2: 0.123679, prezzoF3: 0.123679, importoEnergia: 100.18, dispacciamento: 90.53, distribuzione: 0, oneriSistema: 49.19, accise: 10.13, iva: 55.01, conguaglio: 0.00, totaleNettoIVA: 250.03, totaleFattura: 305.04, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 5, meseEmissione: 6, consumoTotale: 1499, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 1.6, prezzoF1: 0.145170, prezzoF2: 0.145170, prezzoF3: 0.145170, importoEnergia: 217.61, dispacciamento: 99.15, distribuzione: 0, oneriSistema: 51.33, accise: 18.74, iva: 85.10, conguaglio: 0.00, totaleNettoIVA: 386.83, totaleFattura: 471.93, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 6, meseEmissione: 7, consumoTotale: 1619, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 1.8, prezzoF1: 0.149592, prezzoF2: 0.149592, prezzoF3: 0.149592, importoEnergia: 242.19, dispacciamento: 100.66, distribuzione: 0, oneriSistema: 51.71, accise: 20.24, iva: 91.26, conguaglio: 0.00, totaleNettoIVA: 414.80, totaleFattura: 506.06, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 7, meseEmissione: 8, consumoTotale: 2168, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 2.4, prezzoF1: 0.141158, prezzoF2: 0.141158, prezzoF3: 0.141158, importoEnergia: 306.03, dispacciamento: 107.54, distribuzione: 0, oneriSistema: 53.41, accise: 27.10, iva: 108.70, conguaglio: 0.00, totaleNettoIVA: 494.08, totaleFattura: 602.78, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 8, meseEmissione: 9, consumoTotale: 1200, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 1.3, prezzoF1: 0.141308, prezzoF2: 0.141308, prezzoF3: 0.141308, importoEnergia: 169.57, dispacciamento: 105.36, distribuzione: 0, oneriSistema: 50.40, accise: 15.00, iva: 74.87, conguaglio: 0.00, totaleNettoIVA: 340.33, totaleFattura: 415.20, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 9, meseEmissione: 10, consumoTotale: 1189, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 1.3, prezzoF1: 0.145660, prezzoF2: 0.145660, prezzoF3: 0.145660, importoEnergia: 173.19, dispacciamento: 105.23, distribuzione: 0, oneriSistema: 100.69, accise: 14.88, iva: 86.68, conguaglio: 0.00, totaleNettoIVA: 393.99, totaleFattura: 480.67, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 10, meseEmissione: 11, consumoTotale: 754, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 0.8, prezzoF1: 0.153647, prezzoF2: 0.153647, prezzoF3: 0.153647, importoEnergia: 115.85, dispacciamento: 99.75, distribuzione: 0, oneriSistema: 80.90, accise: 9.43, iva: 67.30, conguaglio: 0.00, totaleNettoIVA: 305.93, totaleFattura: 373.23, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E00010073", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 11, meseEmissione: 0, consumoTotale: 1821, consumoF1: 0, consumoF2: 0, consumoF3: 0, potenzaMax: 2.0, prezzoF1: 0.150428, prezzoF2: 0.150428, prezzoF3: 0.150428, importoEnergia: 273.93, dispacciamento: 113.18, distribuzione: 0, oneriSistema: 129.34, accise: 22.76, iva: 118.63, conguaglio: 0.00, totaleNettoIVA: 539.21, totaleFattura: 657.84, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 0, meseEmissione: 1, consumoTotale: 3185, consumoF1: 1178, consumoF2: 639, consumoF3: 1368, potenzaMax: 3.5, prezzoF1: 0.178980, prezzoF2: 0.178980, prezzoF3: 0.178980, importoEnergia: 570.05, dispacciamento: 107.20, distribuzione: 0, oneriSistema: 187.12, accise: 39.81, iva: 198.92, conguaglio: 0.00, totaleNettoIVA: 904.18, totaleFattura: 1103.10, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 1, meseEmissione: 2, consumoTotale: 2888, consumoF1: 1122, consumoF2: 621, consumoF3: 1145, potenzaMax: 3.2, prezzoF1: 0.185478, prezzoF2: 0.185478, prezzoF3: 0.185478, importoEnergia: 535.66, dispacciamento: 103.48, distribuzione: 0, oneriSistema: 173.54, accise: 36.10, iva: 186.73, conguaglio: 0.00, totaleNettoIVA: 848.78, totaleFattura: 1035.51, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 2, meseEmissione: 3, consumoTotale: 2866, consumoF1: 1104, consumoF2: 634, consumoF3: 1128, potenzaMax: 3.1, prezzoF1: 0.151249, prezzoF2: 0.151249, prezzoF3: 0.151249, importoEnergia: 433.48, dispacciamento: 103.21, distribuzione: 0, oneriSistema: 172.52, accise: 35.83, iva: 163.91, conguaglio: 0.00, totaleNettoIVA: 745.04, totaleFattura: 908.95, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 3, meseEmissione: 4, consumoTotale: 2434, consumoF1: 944, consumoF2: 488, consumoF3: 1002, potenzaMax: 2.7, prezzoF1: 0.129441, prezzoF2: 0.129441, prezzoF3: 0.129441, importoEnergia: 315.06, dispacciamento: 99.73, distribuzione: 0, oneriSistema: 46.69, accise: 30.43, iva: 108.22, conguaglio: 0.00, totaleNettoIVA: 491.91, totaleFattura: 600.13, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 4, meseEmissione: 5, consumoTotale: 2344, consumoF1: 881, consumoF2: 529, consumoF3: 934, potenzaMax: 2.6, prezzoF1: 0.121621, prezzoF2: 0.121621, prezzoF3: 0.121621, importoEnergia: 285.08, dispacciamento: 98.89, distribuzione: 0, oneriSistema: 46.41, accise: 29.31, iva: 101.13, conguaglio: 0.00, totaleNettoIVA: 459.69, totaleFattura: 560.82, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 5, meseEmissione: 6, consumoTotale: 3049, consumoF1: 1112, consumoF2: 652, consumoF3: 1285, potenzaMax: 3.3, prezzoF1: 0.147261, prezzoF2: 0.147261, prezzoF3: 0.147261, importoEnergia: 449.00, dispacciamento: 106.47, distribuzione: 0, oneriSistema: 48.61, accise: 38.11, iva: 141.28, conguaglio: 0.00, totaleNettoIVA: 642.19, totaleFattura: 783.47, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 6, meseEmissione: 7, consumoTotale: 3304, consumoF1: 1304, consumoF2: 733, consumoF3: 1267, potenzaMax: 3.6, prezzoF1: 0.161828, prezzoF2: 0.161828, prezzoF3: 0.161828, importoEnergia: 534.68, dispacciamento: 108.84, distribuzione: 0, oneriSistema: 49.37, accise: 41.30, iva: 161.52, conguaglio: 0.00, totaleNettoIVA: 734.19, totaleFattura: 895.71, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 7, meseEmissione: 8, consumoTotale: 3036, consumoF1: 1049, consumoF2: 679, consumoF3: 1308, potenzaMax: 3.3, prezzoF1: 0.141864, prezzoF2: 0.141864, prezzoF3: 0.141864, importoEnergia: 430.70, dispacciamento: 105.45, distribuzione: 0, oneriSistema: 48.57, accise: 37.95, iva: 136.99, conguaglio: 0.00, totaleNettoIVA: 622.67, totaleFattura: 759.66, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 8, meseEmissione: 9, consumoTotale: 2736, consumoF1: 1083, consumoF2: 602, consumoF3: 1051, potenzaMax: 3.0, prezzoF1: 0.139890, prezzoF2: 0.139890, prezzoF3: 0.139890, importoEnergia: 382.74, dispacciamento: 102.21, distribuzione: 0, oneriSistema: 47.63, accise: 34.20, iva: 124.69, conguaglio: 0.00, totaleNettoIVA: 566.78, totaleFattura: 691.47, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 9, meseEmissione: 10, consumoTotale: 2682, consumoF1: 1200, consumoF2: 540, consumoF3: 942, potenzaMax: 2.9, prezzoF1: 0.143207, prezzoF2: 0.143207, prezzoF3: 0.143207, importoEnergia: 384.08, dispacciamento: 110.83, distribuzione: 0, oneriSistema: 160.87, accise: 33.53, iva: 151.65, conguaglio: 0.00, totaleNettoIVA: 689.31, totaleFattura: 840.96, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 10, meseEmissione: 11, consumoTotale: 2798, consumoF1: 1007, consumoF2: 587, consumoF3: 1204, potenzaMax: 3.1, prezzoF1: 0.151129, prezzoF2: 0.151129, prezzoF3: 0.151129, importoEnergia: 422.86, dispacciamento: 112.27, distribuzione: 0, oneriSistema: 166.13, accise: 34.98, iva: 161.97, conguaglio: 0.00, totaleNettoIVA: 736.24, totaleFattura: 898.21, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT020E13004335", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 11, meseEmissione: 0, consumoTotale: 3175, consumoF1: 1074, consumoF2: 642, consumoF3: 1459, potenzaMax: 3.5, prezzoF1: 0.152441, prezzoF2: 0.152441, prezzoF3: 0.152441, importoEnergia: 484.00, dispacciamento: 117.22, distribuzione: 0, oneriSistema: 183.24, accise: 39.69, iva: 181.31, conguaglio: 0.00, totaleNettoIVA: 824.15, totaleFattura: 1005.46, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 0, meseEmissione: 1, consumoTotale: 5709, consumoF1: 2206, consumoF2: 1125, consumoF3: 2378, potenzaMax: 6.3, prezzoF1: 0.178888, prezzoF2: 0.178888, prezzoF3: 0.178888, importoEnergia: 1021.27, dispacciamento: 127.62, distribuzione: 0, oneriSistema: 294.76, accise: 71.36, iva: 333.30, conguaglio: 0.00, totaleNettoIVA: 1515.01, totaleFattura: 1848.31, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 1, meseEmissione: 2, consumoTotale: 4499, consumoF1: 1848, consumoF2: 945, consumoF3: 1706, potenzaMax: 4.9, prezzoF1: 0.186368, prezzoF2: 0.186368, prezzoF3: 0.186368, importoEnergia: 838.47, dispacciamento: 112.49, distribuzione: 0, oneriSistema: 239.34, accise: 56.24, iva: 274.24, conguaglio: 0.00, totaleNettoIVA: 1246.54, totaleFattura: 1520.78, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 2, meseEmissione: 3, consumoTotale: 3314, consumoF1: 1351, consumoF2: 698, consumoF3: 1265, potenzaMax: 3.6, prezzoF1: 0.152858, prezzoF2: 0.152858, prezzoF3: 0.152858, importoEnergia: 506.57, dispacciamento: 99.12, distribuzione: 0, oneriSistema: 185.07, accise: 41.43, iva: 183.08, conguaglio: 0.00, totaleNettoIVA: 832.19, totaleFattura: 1015.27, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 3, meseEmissione: 4, consumoTotale: 2240, consumoF1: 1098, consumoF2: 388, consumoF3: 754, potenzaMax: 2.5, prezzoF1: 0.136679, prezzoF2: 0.136679, prezzoF3: 0.136679, importoEnergia: 306.16, dispacciamento: 86.40, distribuzione: 0, oneriSistema: 38.54, accise: 28.00, iva: 101.00, conguaglio: 0.00, totaleNettoIVA: 459.10, totaleFattura: 560.10, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 4, meseEmissione: 5, consumoTotale: 2498, consumoF1: 1148, consumoF2: 518, consumoF3: 832, potenzaMax: 2.7, prezzoF1: 0.133311, prezzoF2: 0.133311, prezzoF3: 0.133311, importoEnergia: 333.01, dispacciamento: 93.37, distribuzione: 0, oneriSistema: 39.34, accise: 31.23, iva: 109.33, conguaglio: 0.00, totaleNettoIVA: 496.95, totaleFattura: 606.28, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 5, meseEmissione: 6, consumoTotale: 4811, consumoF1: 2029, consumoF2: 1030, consumoF3: 1752, potenzaMax: 5.3, prezzoF1: 0.153282, prezzoF2: 0.153282, prezzoF3: 0.153282, importoEnergia: 737.44, dispacciamento: 120.60, distribuzione: 0, oneriSistema: 46.55, accise: 60.14, iva: 212.24, conguaglio: 0.00, totaleNettoIVA: 964.73, totaleFattura: 1176.97, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 6, meseEmissione: 7, consumoTotale: 4012, consumoF1: 1689, consumoF2: 878, consumoF3: 1445, potenzaMax: 4.4, prezzoF1: 0.146882, prezzoF2: 0.146882, prezzoF3: 0.146882, importoEnergia: 589.29, dispacciamento: 104.48, distribuzione: 0, oneriSistema: 44.05, accise: 50.15, iva: 173.35, conguaglio: 0.00, totaleNettoIVA: 787.97, totaleFattura: 961.32, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 7, meseEmissione: 8, consumoTotale: 4127, consumoF1: 1679, consumoF2: 972, consumoF3: 1476, potenzaMax: 4.5, prezzoF1: 0.141410, prezzoF2: 0.141410, prezzoF3: 0.141410, importoEnergia: 583.60, dispacciamento: 109.86, distribuzione: 0, oneriSistema: 44.41, accise: 51.59, iva: 173.68, conguaglio: 0.00, totaleNettoIVA: 789.46, totaleFattura: 963.14, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 8, meseEmissione: 9, consumoTotale: 4114, consumoF1: 1763, consumoF2: 887, consumoF3: 1464, potenzaMax: 4.5, prezzoF1: 0.138415, prezzoF2: 0.138415, prezzoF3: 0.138415, importoEnergia: 569.44, dispacciamento: 108.54, distribuzione: 0, oneriSistema: 44.37, accise: 51.43, iva: 170.23, conguaglio: 0.00, totaleNettoIVA: 773.78, totaleFattura: 944.01, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 9, meseEmissione: 10, consumoTotale: 2435, consumoF1: 1268, consumoF2: 462, consumoF3: 705, potenzaMax: 2.7, prezzoF1: 0.143055, prezzoF2: 0.143055, prezzoF3: 0.143055, importoEnergia: 348.34, dispacciamento: 94.94, distribuzione: 0, oneriSistema: 142.11, accise: 30.44, iva: 135.48, conguaglio: 0.00, totaleNettoIVA: 615.83, totaleFattura: 751.31, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 10, meseEmissione: 11, consumoTotale: 3385, consumoF1: 1447, consumoF2: 669, consumoF3: 1269, potenzaMax: 3.7, prezzoF1: 0.154582, prezzoF2: 0.154582, prezzoF3: 0.154582, importoEnergia: 523.26, dispacciamento: 107.47, distribuzione: 0, oneriSistema: 185.23, accise: 42.31, iva: 188.82, conguaglio: 0.00, totaleNettoIVA: 858.27, totaleFattura: 1047.09, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT024E00189331", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 11, meseEmissione: 0, consumoTotale: 5937, consumoF1: 2203, consumoF2: 1160, consumoF3: 2574, potenzaMax: 6.5, prezzoF1: 0.153509, prezzoF2: 0.153509, prezzoF3: 0.153509, importoEnergia: 911.38, dispacciamento: 139.73, distribuzione: 0, oneriSistema: 301.08, accise: 74.21, iva: 313.81, conguaglio: 0.00, totaleNettoIVA: 1426.40, totaleFattura: 1740.21, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 0, meseEmissione: 1, consumoTotale: 2060, consumoF1: 934, consumoF2: 397, consumoF3: 729, potenzaMax: 2.3, prezzoF1: 0.190675, prezzoF2: 0.190675, prezzoF3: 0.190675, importoEnergia: 392.79, dispacciamento: 50.97, distribuzione: 0, oneriSistema: 106.95, accise: 25.75, iva: 126.82, conguaglio: 0.00, totaleNettoIVA: 576.46, totaleFattura: 703.28, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 1, meseEmissione: 2, consumoTotale: 1971, consumoF1: 915, consumoF2: 413, consumoF3: 643, potenzaMax: 2.2, prezzoF1: 0.192993, prezzoF2: 0.192993, prezzoF3: 0.192993, importoEnergia: 380.39, dispacciamento: 51.75, distribuzione: 0, oneriSistema: 104.46, accise: 24.64, iva: 123.47, conguaglio: 0.00, totaleNettoIVA: 561.24, totaleFattura: 684.71, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 2, meseEmissione: 3, consumoTotale: 2396, consumoF1: 1015, consumoF2: 531, consumoF3: 850, potenzaMax: 2.6, prezzoF1: 0.152124, prezzoF2: 0.152124, prezzoF3: 0.152124, importoEnergia: 364.49, dispacciamento: 52.38, distribuzione: 0, oneriSistema: 120.74, accise: 29.95, iva: 124.86, conguaglio: 0.00, totaleNettoIVA: 567.56, totaleFattura: 692.42, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 3, meseEmissione: 4, consumoTotale: 2262, consumoF1: 947, consumoF2: 447, consumoF3: 868, potenzaMax: 2.5, prezzoF1: 0.128705, prezzoF2: 0.128705, prezzoF3: 0.128705, importoEnergia: 291.13, dispacciamento: 53.47, distribuzione: 0, oneriSistema: 19.00, accise: 28.28, iva: 86.21, conguaglio: 0.00, totaleNettoIVA: 391.88, totaleFattura: 478.09, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 4, meseEmissione: 5, consumoTotale: 2168, consumoF1: 942, consumoF2: 460, consumoF3: 766, potenzaMax: 2.4, prezzoF1: 0.120148, prezzoF2: 0.120148, prezzoF3: 0.120148, importoEnergia: 260.48, dispacciamento: 49.35, distribuzione: 0, oneriSistema: 17.18, accise: 27.10, iva: 77.90, conguaglio: 0.00, totaleNettoIVA: 354.11, totaleFattura: 432.01, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 5, meseEmissione: 6, consumoTotale: 2407, consumoF1: 1011, consumoF2: 479, consumoF3: 917, potenzaMax: 2.6, prezzoF1: 0.147241, prezzoF2: 0.147241, prezzoF3: 0.147241, importoEnergia: 354.41, dispacciamento: 54.70, distribuzione: 0, oneriSistema: 19.44, accise: 30.09, iva: 100.90, conguaglio: 0.00, totaleNettoIVA: 458.64, totaleFattura: 559.54, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 6, meseEmissione: 7, consumoTotale: 2496, consumoF1: 1162, consumoF2: 501, consumoF3: 833, potenzaMax: 2.7, prezzoF1: 0.163213, prezzoF2: 0.163213, prezzoF3: 0.163213, importoEnergia: 407.38, dispacciamento: 55.50, distribuzione: 0, oneriSistema: 19.72, accise: 31.20, iva: 113.04, conguaglio: 0.00, totaleNettoIVA: 513.80, totaleFattura: 626.84, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 7, meseEmissione: 8, consumoTotale: 2161, consumoF1: 898, consumoF2: 432, consumoF3: 831, potenzaMax: 2.4, prezzoF1: 0.141902, prezzoF2: 0.141902, prezzoF3: 0.141902, importoEnergia: 306.65, dispacciamento: 52.32, distribuzione: 0, oneriSistema: 18.68, accise: 27.01, iva: 89.03, conguaglio: 0.00, totaleNettoIVA: 404.66, totaleFattura: 493.69, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 8, meseEmissione: 9, consumoTotale: 2240, consumoF1: 933, consumoF2: 485, consumoF3: 822, potenzaMax: 2.5, prezzoF1: 0.140179, prezzoF2: 0.140179, prezzoF3: 0.140179, importoEnergia: 314.00, dispacciamento: 50.31, distribuzione: 0, oneriSistema: 17.41, accise: 28.00, iva: 90.14, conguaglio: 0.00, totaleNettoIVA: 409.72, totaleFattura: 499.86, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 9, meseEmissione: 10, consumoTotale: 2208, consumoF1: 984, consumoF2: 465, consumoF3: 759, potenzaMax: 2.4, prezzoF1: 0.144230, prezzoF2: 0.144230, prezzoF3: 0.144230, importoEnergia: 318.46, dispacciamento: 51.71, distribuzione: 0, oneriSistema: 110.66, accise: 27.60, iva: 111.85, conguaglio: 0.00, totaleNettoIVA: 508.43, totaleFattura: 620.28, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 10, meseEmissione: 11, consumoTotale: 2009, consumoF1: 863, consumoF2: 391, consumoF3: 755, potenzaMax: 2.2, prezzoF1: 0.152882, prezzoF2: 0.152882, prezzoF3: 0.152882, importoEnergia: 307.14, dispacciamento: 49.44, distribuzione: 0, oneriSistema: 101.64, accise: 25.11, iva: 106.33, conguaglio: 0.00, totaleNettoIVA: 483.33, totaleFattura: 589.66, consumiDefinitivi: true, tipoDocumento: "Fattura" },
 { pod: "IT253E16163274", site: "Edison", city: "—", client: "Edison Energia", company: "edison", anno: 2025, meseConsumi: 11, meseEmissione: 0, consumoTotale: 2242, consumoF1: 954, consumoF2: 408, consumoF3: 880, potenzaMax: 2.5, prezzoF1: 0.155219, prezzoF2: 0.155219, prezzoF3: 0.155219, importoEnergia: 348.00, dispacciamento: 55.78, distribuzione: 0, oneriSistema: 113.74, accise: 28.03, iva: 120.02, conguaglio: 0.00, totaleNettoIVA: 545.55, totaleFattura: 665.57, consumiDefinitivi: true, tipoDocumento: "Fattura" },
];
const ENERGY_DATA = [...EDISON_ENERGY];
const GAS_DATA = [];
const MOBILE_DATA = [];
const FIXED_DATA = [];
const CONN_DATA = [];

// ─── CONTRACTS DATA ──────────────────────────────────────────────────────────

const CONTRACTS = [];

function ContractTab({ utility }) {
 const { co } = useCompanyFilter();
 const contracts = CONTRACTS.filter(c => c.utility === utility && (co === "all" || c.company === co));
 const active = contracts.filter(c => c.status === "Attivo");
 const expiring = active.filter(c => { const end = new Date(c.end); const now = new Date(); const diff = (end - now) / (1000*60*60*24); return diff < 180; });

 return (
 <div>
 <SectionTitle sub="Gestione contratti di fornitura">Contratti — {UTILITY_META[utility]?.label || utility}</SectionTitle>
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="Contratti Totali" value={contracts.length} color={C.accent} />
 <KPICard label="Attivi" value={active.length} color={C.success} />
 <KPICard label="In Scadenza (<6 mesi)" value={expiring.length} color={expiring.length > 0 ? C.warn : C.success} warning={expiring.length > 0} />
 <KPICard label="Scaduti" value={contracts.filter(c => c.status === "Scaduto").length} color={C.danger} />
 </div>

 <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
 {contracts.map(c => {
 const end = new Date(c.end);
 const now = new Date();
 const daysLeft = Math.round((end - now) / (1000*60*60*24));
 const co = COMPANIES.find(x => x.id === c.company);
 const isExpiring = c.status === "Attivo" && daysLeft < 180;
 return (
 <div key={c.id} style={{
 background: C.card, borderRadius: 8, border: `1px solid ${isExpiring ? C.warn : c.status === "Scaduto" ? C.danger : C.border}`,
 borderLeft: `4px solid ${isExpiring ? C.warn : c.status === "Scaduto" ? C.danger : C.success}`,
 padding: "16px 20px", boxShadow: "0 1px 3px rgba(0,0,0,0.06)",
 }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 10 }}>
 <div>
 <div style={{ fontSize: 14, fontWeight: 700, color: C.text }}>{c.provider}</div>
 <div style={{ fontSize: 11, color: C.textDim, marginTop: 2 }}>{c.id} · {c.type}</div>
 </div>
 <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
 {co && <Badge color={co.color}>{co.short}</Badge>}
 <Badge color={c.status === "Attivo" ? C.success : C.danger}>{c.status}</Badge>
 {isExpiring && <Badge color={C.warn}> Scade tra {daysLeft}gg</Badge>}
 </div>
 </div>
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12, fontSize: 12 }}>
 <div><span style={{ color: C.textDim }}>Periodo:</span> <span style={{ fontWeight: 600, color: C.text }}>{c.start} → {c.end}</span></div>
 <div><span style={{ color: C.textDim }}>Rinnovo:</span> <span style={{ fontWeight: 600, color: C.text }}>{c.renewalType}</span></div>
 <div><span style={{ color: C.textDim }}>Penale:</span> <span style={{ fontWeight: 600, color: C.text }}>{c.penalty}</span></div>
 </div>
 <div style={{ marginTop: 8, fontSize: 12, color: C.text, background: C.bg, borderRadius: 6, padding: "8px 12px" }}>
 <strong style={{ color: C.textMuted }}>Condizioni:</strong> {c.conditions}
 </div>
 {c.notes && <div style={{ marginTop: 6, fontSize: 11, color: C.accent, fontWeight: 600 }}> {c.notes}</div>}
 {c.pods.length > 0 && <div style={{ marginTop: 6, fontSize: 11, color: C.textDim }}>Punti fornitura: {c.pods.join(", ")}</div>}
 </div>
 );
 })}
 {contracts.length === 0 && <div style={{ textAlign: "center", padding: 40, color: C.textDim }}>Nessun contratto trovato.</div>}
 </div>
 </div>
 );
}

// ─── TICKET SYSTEM ───────────────────────────────────────────────────────────

const TICKET_CATEGORIES = [
 { key: "anomalia_fattura", label: "Anomalia Fattura", desc: "Errore importo, doppia fatturazione, conguaglio anomalo" },
 { key: "guasto_fornitura", label: "Guasto / Interruzione", desc: "Interruzione fornitura energia, gas, rete o linea" },
 { key: "variazione_contratto", label: "Variazione Contrattuale", desc: "Modifica condizioni, voltura, subentro, cessazione" },
 { key: "nuovo_allacciamento", label: "Nuovo Allacciamento / Attivazione", desc: "Richiesta nuova fornitura o linea" },
 { key: "variazione_potenza", label: "Variazione Potenza / Portata", desc: "Aumento o riduzione potenza impegnata o portata gas" },
 { key: "lettura_consumi", label: "Lettura / Consumi", desc: "Lettura errata, stima contestata, autolettura" },
 { key: "richiesta_info", label: "Richiesta Informazioni", desc: "Documentazione, certificati, chiarimenti" },
 { key: "altro", label: "Altro", desc: "Altra tipologia di richiesta" },
];

const TICKET_PRIORITIES = [
 { key: "alta", label: "Alta", color: "#e74a3b" },
 { key: "media", label: "Media", color: "#f6c23e" },
 { key: "bassa", label: "Bassa", color: "#1cc88a" },
];

function TicketCenter() {
 const [tickets, setTickets] = useState([]);
 const [showNewTicket, setShowNewTicket] = useState(false);
 const [newTicket, setNewTicket] = useState({ category: "", priority: "media", subject: "", device: "", deviceType: "", company: "edison", notes: "" });
 const [filterStatus, setFilterStatus] = useState("all");

 const filteredTickets = filterStatus === "all" ? tickets : tickets.filter(t => t.status === filterStatus);
 const statusCounts = { Aperto: tickets.filter(t => t.status === "Aperto").length, "In lavorazione": tickets.filter(t => t.status === "In lavorazione").length, Risolto: tickets.filter(t => t.status === "Risolto").length };

 const handleSubmit = () => {
 if (!newTicket.category || !newTicket.subject) return;
 const t = { ...newTicket, id: `TKT-2025-${String(tickets.length + 43).padStart(4, "0")}`, status: "Aperto", created: new Date().toISOString().slice(0, 10), assignedTo: "Back Office" };
 setTickets(prev => [t, ...prev]);
 setShowNewTicket(false);
 setNewTicket({ category: "", priority: "media", subject: "", device: "", deviceType: "", company: "edison", notes: "" });
 };

 return (
 <div>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
 <SectionTitle sub="Gestione richieste e segnalazioni verso il back office">Ticket & Assistenza</SectionTitle>
 <button onClick={() => setShowNewTicket(true)} style={{
 padding: "10px 20px", borderRadius: 8, border: "none", cursor: "pointer",
 background: `linear-gradient(135deg, ${C.accent}, #224abe)`, color: "#fff",
 fontSize: 13, fontWeight: 700, fontFamily: "inherit", boxShadow: "0 2px 8px rgba(78,115,223,0.35)",
 }}>+ Apri Nuovo Ticket</button>
 </div>

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(160px, 1fr))", gap: 14, marginBottom: 20 }}>
 <KPICard label="Ticket Aperti" value={statusCounts.Aperto} color={C.danger} />
 <KPICard label="In Lavorazione" value={statusCounts["In lavorazione"]} color={C.warn} />
 <KPICard label="Risolti" value={statusCounts.Risolto} color={C.success} />
 <KPICard label="Totale" value={tickets.length} color={C.accent} />
 </div>

 <div style={{ display: "flex", gap: 4, marginBottom: 16 }}>
 {["all","Aperto","In lavorazione","Risolto"].map(s => (
 <button key={s} onClick={() => setFilterStatus(s)} style={{
 padding: "6px 14px", borderRadius: 6, border: `1px solid ${filterStatus === s ? C.accent : C.border}`,
 background: filterStatus === s ? C.accent : C.card, color: filterStatus === s ? "#fff" : C.textMuted,
 fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
 }}>{s === "all" ? "Tutti" : s}</button>
 ))}
 </div>

 <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
 {filteredTickets.map(t => {
 const cat = TICKET_CATEGORIES.find(c => c.key === t.category);
 const pri = TICKET_PRIORITIES.find(p => p.key === t.priority);
 const co = COMPANIES.find(c => c.id === t.company);
 const statusColor = t.status === "Aperto" ? C.danger : t.status === "In lavorazione" ? C.warn : C.success;
 return (
 <div key={t.id} style={{ background: C.card, borderRadius: 8, padding: "14px 18px", border: `1px solid ${C.border}`, borderLeft: `4px solid ${statusColor}`, boxShadow: "0 1px 3px rgba(0,0,0,0.06)" }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
 <div style={{ flex: 1 }}>
 <div style={{ display: "flex", gap: 6, alignItems: "center", marginBottom: 4 }}>
 <span style={{ fontSize: 11, fontWeight: 700, color: C.textDim, fontFamily: "monospace" }}>{t.id}</span>
 <Badge color={statusColor}>{t.status}</Badge>
 {pri && <Badge color={pri.color}>{pri.label}</Badge>}
 {co && <Badge color={co.color}>{co.short}</Badge>}
 </div>
 <div style={{ fontSize: 13, fontWeight: 700, color: C.text }}>{t.subject}</div>
 </div>
 <div style={{ fontSize: 11, color: C.textDim, whiteSpace: "nowrap" }}>{t.created}</div>
 </div>
 <div style={{ display: "flex", gap: 16, marginTop: 8, fontSize: 11, color: C.textDim }}>
 {t.device && <span>Dispositivo: <strong style={{ color: C.text }}>{t.device}</strong></span>}
 <span>Assegnato a: <strong style={{ color: C.text }}>{t.assignedTo}</strong></span>
 </div>
 {t.notes && <div style={{ marginTop: 6, fontSize: 11, color: C.textMuted, background: C.bg, padding: "6px 10px", borderRadius: 4 }}>{t.notes}</div>}
 </div>
 );
 })}
 </div>

 {/* NEW TICKET MODAL */}
 {showNewTicket && (
 <div onClick={() => setShowNewTicket(false)} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.4)", zIndex: 999, display: "flex", alignItems: "center", justifyContent: "center" }}>
 <div onClick={e => e.stopPropagation()} style={{ background: "#fff", borderRadius: 12, border: `1px solid ${C.border}`, padding: 28, width: 560, maxHeight: "85vh", overflowY: "auto", boxShadow: "0 10px 40px rgba(0,0,0,0.2)" }}>
 <h3 style={{ margin: "0 0 18px", fontSize: 18, fontWeight: 700, color: C.text }}> Nuovo Ticket</h3>

 <div style={{ fontSize: 12, fontWeight: 600, color: C.textMuted, marginBottom: 6 }}>CATEGORIA *</div>
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginBottom: 14 }}>
 {TICKET_CATEGORIES.map(cat => (
 <button key={cat.key} onClick={() => setNewTicket(p => ({ ...p, category: cat.key }))} style={{
 padding: "8px 10px", borderRadius: 6, border: `1px solid ${newTicket.category === cat.key ? C.accent : C.border}`,
 background: newTicket.category === cat.key ? `${C.accent}11` : C.card,
 color: C.text, fontSize: 11, cursor: "pointer", fontFamily: "inherit", textAlign: "left",
 }}>
 <div style={{ fontWeight: 600 }}>{cat.label}</div>
 <div style={{ fontSize: 10, color: C.textDim, marginTop: 2 }}>{cat.desc}</div>
 </button>
 ))}
 </div>

 <div style={{ fontSize: 12, fontWeight: 600, color: C.textMuted, marginBottom: 6 }}>PRIORITÀ</div>
 <div style={{ display: "flex", gap: 6, marginBottom: 14 }}>
 {TICKET_PRIORITIES.map(p => (
 <button key={p.key} onClick={() => setNewTicket(prev => ({ ...prev, priority: p.key }))} style={{
 padding: "6px 16px", borderRadius: 6, border: `1px solid ${newTicket.priority === p.key ? p.color : C.border}`,
 background: newTicket.priority === p.key ? p.color : C.card,
 color: newTicket.priority === p.key ? "#fff" : C.text,
 fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
 }}> {p.label}</button>
 ))}
 </div>

 <div style={{ fontSize: 12, fontWeight: 600, color: C.textMuted, marginBottom: 6 }}>AZIENDA</div>
 <select value={newTicket.company} onChange={e => setNewTicket(p => ({ ...p, company: e.target.value }))} style={{ width: "100%", padding: "8px 12px", borderRadius: 6, border: `1px solid ${C.border}`, fontSize: 12, fontFamily: "inherit", marginBottom: 14, color: C.text }}>
 {COMPANIES.filter(c => c.id !== "all").map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
 </select>

 <div style={{ fontSize: 12, fontWeight: 600, color: C.textMuted, marginBottom: 6 }}>DISPOSITIVO / PUNTO FORNITURA (opzionale)</div>
 <div style={{ display: "flex", gap: 8, marginBottom: 14 }}>
 <select value={newTicket.deviceType} onChange={e => setNewTicket(p => ({ ...p, deviceType: e.target.value }))} style={{ padding: "8px 12px", borderRadius: 6, border: `1px solid ${C.border}`, fontSize: 12, fontFamily: "inherit", color: C.text }}>
 <option value="">— Tipo —</option>
 <option value="energia"> Energia (POD)</option>
 <option value="gas"> Gas (PDR)</option>
 <option value="mobile"> Mobile</option>
 <option value="fisso"> Fisso</option>
 <option value="connettivita"> Connettività</option>
 </select>
 <input value={newTicket.device} onChange={e => setNewTicket(p => ({ ...p, device: e.target.value }))} placeholder="ID dispositivo (es. IT001E00012345)" style={{ flex: 1, padding: "8px 12px", borderRadius: 6, border: `1px solid ${C.border}`, fontSize: 12, fontFamily: "inherit", color: C.text }} />
 </div>

 <div style={{ fontSize: 12, fontWeight: 600, color: C.textMuted, marginBottom: 6 }}>OGGETTO *</div>
 <input value={newTicket.subject} onChange={e => setNewTicket(p => ({ ...p, subject: e.target.value }))} placeholder="Descrivi brevemente il problema..." style={{ width: "100%", padding: "8px 12px", borderRadius: 6, border: `1px solid ${C.border}`, fontSize: 12, fontFamily: "inherit", marginBottom: 14, color: C.text }} />

 <div style={{ fontSize: 12, fontWeight: 600, color: C.textMuted, marginBottom: 6 }}>NOTE / DETTAGLI</div>
 <textarea value={newTicket.notes} onChange={e => setNewTicket(p => ({ ...p, notes: e.target.value }))} rows={3} placeholder="Aggiungi dettagli, riferimenti fattura, date..." style={{ width: "100%", padding: "8px 12px", borderRadius: 6, border: `1px solid ${C.border}`, fontSize: 12, fontFamily: "inherit", marginBottom: 18, resize: "vertical", color: C.text }} />

 <div style={{ display: "flex", gap: 10, justifyContent: "flex-end" }}>
 <button onClick={() => setShowNewTicket(false)} style={{ padding: "8px 20px", borderRadius: 6, border: `1px solid ${C.border}`, background: C.card, color: C.textMuted, fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: "inherit" }}>Annulla</button>
 <button onClick={handleSubmit} disabled={!newTicket.category || !newTicket.subject} style={{ padding: "8px 20px", borderRadius: 6, border: "none", background: (!newTicket.category || !newTicket.subject) ? C.textDim : C.accent, color: "#fff", fontSize: 12, fontWeight: 700, cursor: (!newTicket.category || !newTicket.subject) ? "default" : "pointer", fontFamily: "inherit", opacity: (!newTicket.category || !newTicket.subject) ? 0.5 : 1 }}>Invia Ticket</button>
 </div>
 </div>
 </div>
 )}
 </div>
 );
}
const CompanyContext = createContext({ selectedCompany: "all" });

function useCompanyFilter() {
 const { selectedCompany } = React.useContext(CompanyContext);
 return useMemo(() => {
 const f = (arr) => selectedCompany === "all" ? arr : arr.filter(d => d.company === selectedCompany);
 return {
 co: selectedCompany,
 isAll: selectedCompany === "all",
 companyName: COMPANIES.find(c => c.id === selectedCompany)?.short || "Aggregato",
 energyData: f(ENERGY_DATA),
 gasData: f(GAS_DATA),
 mobileData: f(MOBILE_DATA),
 fixedData: f(FIXED_DATA),
 connData: f(CONN_DATA),
 pods: selectedCompany === "all" ? PODS : PODS.filter(p => p.company === selectedCompany),
 pdrs: selectedCompany === "all" ? PDRS : PDRS.filter(p => p.company === selectedCompany),
 mobileLines: selectedCompany === "all" ? MOBILE_LINES : MOBILE_LINES.filter(l => l.company === selectedCompany),
 fixedLines: selectedCompany === "all" ? FIXED_LINES : FIXED_LINES.filter(l => l.company === selectedCompany),
 connectivity: selectedCompany === "all" ? CONNECTIVITY : CONNECTIVITY.filter(c => c.company === selectedCompany),
 };
 }, [selectedCompany]);
}

// ─── LOCAL PERIOD FILTER (used inside each section) ──────────────────────────

const PERIOD_PRESETS = [
 { label: "2026", value: "2026" },
 { label: "2025", value: "2025" },
 { label: "2024", value: "2024" },
 { label: "2023", value: "2023" },
 { label: "2022", value: "2022" },
 { label: "Ultimi 12 mesi", value: "last12" },
 { label: "Ultimi 24 mesi", value: "last24" },
 { label: "Tutto", value: "all" },
 { label: "Custom", value: "custom" },
];

function usePeriodFilter(data) {
 const [preset, setPreset] = useState("2025");
 const [customFrom, setCustomFrom] = useState({ y: 2024, m: 0 });
 const [customTo, setCustomTo] = useState({ y: 2026, m: 11 });
 const filtered = useMemo(() => {
 if (["2022","2023","2024","2025","2026"].includes(preset)) {
 return data.filter(d => d.anno === parseInt(preset));
 }
 if (preset === "last12") return data.filter(d => d.anno >= 2025);
 if (preset === "last24") return data.filter(d => d.anno >= 2024);
 if (preset === "custom") {
 const fromYM = customFrom.y * 12 + customFrom.m;
 const toYM = customTo.y * 12 + customTo.m;
 return data.filter(d => {
 const ym = d.anno * 12 + (d.meseConsumi != null ? d.meseConsumi : d.meseEmissione || 0);
 return ym >= fromYM && ym <= toYM;
 });
 }
 return data; // "all"
 }, [data, preset, customFrom, customTo]);
 return { preset, setPreset, filtered, customFrom, setCustomFrom, customTo, setCustomTo };
}

function PeriodFilterBar({ preset, setPreset, customFrom, setCustomFrom, customTo, setCustomTo }) {
 const monthOpts = MONTHS.map((m, i) => ({ label: m, value: i }));
 const yearOpts = YEARS.map(y => ({ label: String(y), value: y }));
 return (
 <div style={{ marginBottom: 16 }}>
 <div style={{ display: "flex", gap: 4, flexWrap: "wrap", alignItems: "center" }}>
 {PERIOD_PRESETS.map(p => (
 <button key={p.value} onClick={() => setPreset(p.value)} style={{
 padding: "6px 14px", borderRadius: 6, border: `1px solid ${preset === p.value ? C.accent : C.border}`,
 background: preset === p.value ? C.accent : C.card,
 color: preset === p.value ? "#fff" : C.textMuted,
 fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
 boxShadow: preset === p.value ? "0 1px 4px rgba(78,115,223,0.3)" : "none",
 transition: "all 0.15s",
 }}>{p.label}</button>
 ))}
 </div>
 {preset === "custom" && (
 <div style={{ display: "flex", gap: 8, alignItems: "center", marginTop: 8, padding: "10px 14px", background: C.card, borderRadius: 8, border: `1px solid ${C.accent}33`, flexWrap: "wrap" }}>
 <span style={{ fontSize: 11, fontWeight: 600, color: C.textMuted }}>Da:</span>
 <select value={customFrom.m} onChange={e => setCustomFrom(p => ({ ...p, m: parseInt(e.target.value) }))} style={{ padding: "5px 8px", borderRadius: 5, border: `1px solid ${C.border}`, fontSize: 11, fontFamily: "inherit", color: C.text }}>
 {monthOpts.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}
 </select>
 <select value={customFrom.y} onChange={e => setCustomFrom(p => ({ ...p, y: parseInt(e.target.value) }))} style={{ padding: "5px 8px", borderRadius: 5, border: `1px solid ${C.border}`, fontSize: 11, fontFamily: "inherit", color: C.text }}>
 {yearOpts.map(y => <option key={y.value} value={y.value}>{y.label}</option>)}
 </select>
 <span style={{ fontSize: 11, fontWeight: 600, color: C.textMuted, marginLeft: 8 }}>A:</span>
 <select value={customTo.m} onChange={e => setCustomTo(p => ({ ...p, m: parseInt(e.target.value) }))} style={{ padding: "5px 8px", borderRadius: 5, border: `1px solid ${C.border}`, fontSize: 11, fontFamily: "inherit", color: C.text }}>
 {monthOpts.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}
 </select>
 <select value={customTo.y} onChange={e => setCustomTo(p => ({ ...p, y: parseInt(e.target.value) }))} style={{ padding: "5px 8px", borderRadius: 5, border: `1px solid ${C.border}`, fontSize: 11, fontFamily: "inherit", color: C.text }}>
 {yearOpts.map(y => <option key={y.value} value={y.value}>{y.label}</option>)}
 </select>
 </div>
 )}
 </div>
 );
}

// ─── TABLE FILTER BAR (reusable inline filters above tables) ─────────────────

function useTableFilters(data, filterDefs) {
 const [vals, setVals] = useState(() => {
 const init = {};
 filterDefs.forEach(f => { init[f.key] = "all"; });
 return init;
 });
 const set = useCallback((key, val) => setVals(prev => ({ ...prev, [key]: val })), []);
 const filtered = useMemo(() => {
 let d = data;
 filterDefs.forEach(f => {
 if (vals[f.key] !== "all") {
 d = d.filter(row => String(f.accessor(row)) === vals[f.key]);
 }
 });
 return d;
 }, [data, vals, filterDefs]);
 const options = useMemo(() => {
 const o = {};
 filterDefs.forEach(f => {
 o[f.key] = [...new Set(data.map(row => String(f.accessor(row))))].sort();
 });
 return o;
 }, [data, filterDefs]);
 return { vals, set, filtered, options };
}

function TableFilterBar({ filterDefs, vals, set, options, count, total }) {
 return (
 <div style={{ display: "flex", gap: 8, marginBottom: 12, flexWrap: "wrap", alignItems: "center" }}>
 {filterDefs.map(f => (
 <select key={f.key} value={vals[f.key]} onChange={e => set(f.key, e.target.value)} style={{
 padding: "7px 10px", borderRadius: 6, border: `1px solid ${C.border}`, background: C.card,
 color: vals[f.key] !== "all" ? C.accent : C.text, fontSize: 11, fontFamily: "inherit", fontWeight: vals[f.key] !== "all" ? 600 : 400,
 }}>
 <option value="all">{f.label}</option>
 {(options[f.key] || []).map(v => <option key={v} value={v}>{f.format ? f.format(v) : v}</option>)}
 </select>
 ))}
 {count != null && total != null && <span style={{ fontSize: 11, color: C.textDim, marginLeft: 4 }}>{count} di {total}</span>}
 </div>
 );
}

function FilteredTable({ data, columns, maxHeight, filters }) {
 const { vals, set, filtered, options } = useTableFilters(data, filters);
 return (
 <>
 <TableFilterBar filterDefs={filters} vals={vals} set={set} options={options} count={filtered.length} total={data.length} />
 <DataTable columns={columns} data={filtered} maxHeight={maxHeight} />
 </>
 );
}

// ─── COLORS & THEME (SB Admin Pro Style - Light) ────────────────────────────

const C = {
 bg: "#f2f6fc", card: "#ffffff", cardHover: "#f8fafc", border: "#e0e5ec",
 text: "#1f2937", textMuted: "#6b7280", textDim: "#9ca3af",
 sidebar: "#212529", sidebarText: "#adb5bd", sidebarActive: "#ffffff",
 energy: "#f6c23e", energyLight: "#fce8a6",
 gas: "#e74a3b", gasLight: "#f5b7b1",
 mobile: "#6f42c1", mobileLight: "#c4b5fd",
 fixed: "#36b9cc", fixedLight: "#9eeaf9",
 conn: "#1cc88a", connLight: "#a3e4c1",
 accent: "#4e73df", accentLight: "#6e8ef7",
 warn: "#f6c23e", danger: "#e74a3b", success: "#1cc88a",
 f1: "#4e73df", f2: "#6f42c1", f3: "#36b9cc",
 materia: "#f6c23e", dispacc: "#e74a3b", distrib: "#6f42c1", oneri: "#4e73df", imposte: "#858796",
};

const UTILITY_META = {
 energia: { label: "Energia Elettrica", color: C.energy, lightColor: C.energyLight },
 gas: { label: "Gas Naturale", color: C.gas, lightColor: C.gasLight },
 mobile: { label: "Telefonia Mobile", color: C.mobile, lightColor: C.mobileLight },
 fisso: { label: "Telefonia Fissa", color: C.fixed, lightColor: C.fixedLight },
 connettivita: { label: "Connettività", color: C.conn, lightColor: C.connLight },
};

// ─── UTILITY COMPONENTS ───────────────────────────────────────────────────────

const fmt = (n, dec = 0) => {
 if (n == null) return "—";
 const fixed = Math.abs(n).toFixed(dec);
 const [intPart, decPart] = fixed.split(".");
 const withDots = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
 const sign = n < 0 ? "-" : "";
 return decPart !== undefined ? `${sign}${withDots},${decPart}` : `${sign}${withDots}`;
};
const fmtEuro = (n, dec = 2) => n != null ? `€${fmt(n, dec)}` : "—";
const fmtPct = (n) => n != null ? `${n >= 0 ? "+" : ""}${fmt(n, 1)}%` : "—";

function KPICard({ label, value, sub, color, change, warning }) {
 return (
 <div style={{ background: C.card, borderRadius: 8, padding: "14px 16px", border: `1px solid ${C.border}`, borderLeft: `4px solid ${color || C.accent}`, position: "relative", overflow: "hidden", minWidth: 0, boxShadow: "0 1px 3px rgba(0,0,0,0.08)" }}>
 <div style={{ fontSize: 10, color: C.textMuted, marginBottom: 4, display: "flex", alignItems: "center", gap: 5, textTransform: "uppercase", letterSpacing: 0.5, fontWeight: 700 }}>
 {label}
 {warning && <span style={{ color: C.warn, fontSize: 12 }} title="Dato stimato">!</span>}
 </div>
 <div style={{ fontSize: 18, fontWeight: 800, color: C.text, fontFamily: "'Inter', sans-serif", letterSpacing: -0.3 }}>{value}</div>
 <div style={{ display: "flex", justifyContent: "space-between", marginTop: 3, fontSize: 10 }}>
 <span style={{ color: C.textDim }}>{sub || ""}</span>
 {change != null && (
 <span style={{ color: change > 0 ? C.danger : C.success, fontWeight: 600 }}>{fmtPct(change)}</span>
 )}
 </div>
 </div>
 );
}

function Badge({ children, color = C.accent, bg }) {
 return (
 <span style={{
 display: "inline-flex", alignItems: "center", fontSize: 11, fontWeight: 600,
 padding: "2px 8px", borderRadius: 6,
 color: "#fff", background: bg || color,
 }}>{children}</span>
 );
}

function TabBar({ tabs, active, onChange, style }) {
 return (
 <div style={{ display: "flex", gap: 2, background: C.bg, borderRadius: 8, padding: 3, border: `1px solid ${C.border}`, ...style }}>
 {tabs.map(t => (
 <button key={t.key} onClick={() => onChange(t.key)} style={{
 padding: "8px 16px", borderRadius: 6, border: "none", cursor: "pointer",
 fontSize: 13, fontWeight: 600, fontFamily: "inherit", transition: "all 0.2s",
 background: active === t.key ? C.accent : "transparent",
 color: active === t.key ? "#fff" : C.textMuted,
 }}>
 {t.label}
 </button>
 ))}
 </div>
 );
}

function DataTable({ columns, data, maxHeight = 400 }) {
 const [sortCol, setSortCol] = useState(null);
 const [sortDir, setSortDir] = useState("asc");
 const sorted = useMemo(() => {
 if (!sortCol) return data;
 return [...data].sort((a, b) => {
 const va = a[sortCol], vb = b[sortCol];
 if (typeof va === "number") return sortDir === "asc" ? va - vb : vb - va;
 return sortDir === "asc" ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
 });
 }, [data, sortCol, sortDir]);

 const handleSort = (key) => {
 if (sortCol === key) setSortDir(d => d === "asc" ? "desc" : "asc");
 else { setSortCol(key); setSortDir("asc"); }
 };

 return (
 <div style={{ overflowX: "auto", overflowY: "auto", maxHeight, borderRadius: 8, border: `1px solid ${C.border}`, boxShadow: "0 1px 3px rgba(0,0,0,0.06)" }}>
 <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
 <thead>
 <tr>
 {columns.map(col => (
 <th key={col.key} onClick={() => col.sortable !== false && handleSort(col.key)} style={{
 position: "sticky", top: 0, zIndex: 2, padding: "10px 12px",
 textAlign: col.align || "left", background: "#e9ecf1", color: "#5a5c69",
 borderBottom: `2px solid ${C.border}`, cursor: col.sortable !== false ? "pointer" : "default",
 fontWeight: 700, whiteSpace: "nowrap", fontSize: 11, letterSpacing: 0.5, textTransform: "uppercase",
 }}>
 {col.label} {sortCol === col.key ? (sortDir === "asc" ? "↑" : "↓") : ""}
 </th>
 ))}
 </tr>
 </thead>
 <tbody>
 {sorted.map((row, i) => (
 <tr key={i} style={{ background: i % 2 === 0 ? C.card : "#f8f9fc" }}>
 {columns.map(col => (
 <td key={col.key} style={{
 padding: "8px 12px", borderBottom: `1px solid ${C.border}`,
 color: C.text, textAlign: col.align || "left", whiteSpace: "nowrap",
 }}>
 {col.render ? col.render(row[col.key], row) : row[col.key]}
 </td>
 ))}
 </tr>
 ))}
 </tbody>
 </table>
 </div>
 );
}

function SectionTitle({ children, sub }) {
 return (
 <div style={{ marginBottom: 16, marginTop: 8 }}>
 <h3 style={{ margin: 0, fontSize: 16, fontWeight: 700, color: C.text, fontFamily: "'Inter', sans-serif" }}>{children}</h3>
 {sub && <p style={{ margin: "4px 0 0", fontSize: 12, color: C.textDim }}>{sub}</p>}
 </div>
 );
}

function ChartCard({ title, children, style }) {
 return (
 <div style={{ background: C.card, borderRadius: 8, padding: 20, border: `1px solid ${C.border}`, boxShadow: "0 1px 3px rgba(0,0,0,0.08)", ...style }}>
 {title && <div style={{ fontSize: 13, fontWeight: 700, color: C.accent, marginBottom: 14, textTransform: "uppercase", letterSpacing: 0.3 }}>{title}</div>}
 {children}
 </div>
 );
}

function ViewToggle({ view, onChange }) {
 return (
 <TabBar
 tabs={[
 { key: "contabilita", label: "Contabilità" },
 { key: "competenza", label: "Competenza / Gestione" },
 ]}
 active={view}
 onChange={onChange}
 />
 );
}

const customTooltipStyle = { background: "#fff", border: `1px solid ${C.border}`, borderRadius: 8, padding: "8px 12px", fontSize: 12, color: C.text, boxShadow: "0 2px 8px rgba(0,0,0,0.1)" };

// ─── OVERVIEW DASHBOARD ───────────────────────────────────────────────────────

function OverviewDashboard() {
 const { co, energyData, gasData, mobileData, fixedData, connData, mobileLines, fixedLines, connectivity, companyName, isAll } = useCompanyFilter();
 const totalEnergy = energyData.reduce((s, d) => s + d.totaleFattura, 0);
 const totalGas = gasData.reduce((s, d) => s + d.totaleFattura, 0);
 const totalMobile = mobileData.reduce((s, d) => s + d.totaleFattura, 0);
 const totalFixed = fixedData.reduce((s, d) => s + d.totaleFattura, 0);
 const totalConn = connData.reduce((s, d) => s + d.totaleFattura, 0);
 const grandTotal = totalEnergy + totalGas + totalMobile + totalFixed + totalConn;

 // Site KPIs
 const buildingStats = useMemo(() => {
 const filtered = isAll ? BUILDINGS : BUILDINGS.filter(b => b.company === co);
 const bldData = filtered.map(bld => {
 const eCost = energyData.filter(d => bld.devices.pods.includes(d.pod)).reduce((s, d) => s + d.totaleFattura, 0);
 const gCost = gasData.filter(d => bld.devices.pdrs.includes(d.pdr)).reduce((s, d) => s + d.totaleFattura, 0);
 const fCost = FIXED_LINES.filter(l => bld.devices.fixedLines.includes(l.id)).reduce((s, l) => s + l.monthlyCost * 12, 0);
 const cCost = CONNECTIVITY.filter(c => bld.devices.connectivity.includes(c.id)).reduce((s, c) => s + c.monthlyCost * 12, 0);
 const mCost = MOBILE_LINES.filter(l => bld.devices.mobileLines.includes(l.id)).reduce((s, l) => s + l.fixedCost * 12, 0);
 const totalCost = eCost + gCost + fCost + cCost + mCost;
 const numDevices = bld.devices.pods.length + bld.devices.pdrs.length + bld.devices.fixedLines.length + bld.devices.connectivity.length + bld.devices.mobileLines.length;
 return { ...bld, eCost, gCost, totalCost, numDevices };
 });
 const totalBldCost = bldData.reduce((s, b) => s + b.totalCost, 0);
 const totalDevices = bldData.reduce((s, b) => s + b.numDevices, 0);
 const topBuildings = [...bldData].sort((a, b) => b.totalCost - a.totalCost).slice(0, 5);
 const costliest = topBuildings[0] || null;
 return { count: filtered.length, totalCost: totalBldCost, totalDevices, topBuildings, costliest };
 }, [co, isAll, energyData, gasData]);

 const monthlyTrend = Array.from({ length: 12 }, (_, m) => ({
 name: MONTHS[m],
 energia: +energyData.filter(d => d.meseEmissione === m).reduce((s, d) => s + d.totaleFattura, 0).toFixed(0),
 gas: +gasData.filter(d => d.meseEmissione === m).reduce((s, d) => s + d.totaleFattura, 0).toFixed(0),
 mobile: +mobileData.filter(d => d.meseConsumi === m).reduce((s, d) => s + d.totaleFattura, 0).toFixed(0),
 fisso: +fixedData.filter(d => d.meseConsumi === m).reduce((s, d) => s + d.totaleFattura, 0).toFixed(0),
 conn: +connData.filter(d => d.meseConsumi === m).reduce((s, d) => s + d.totaleFattura, 0).toFixed(0),
 }));

 const donutData = [
 { name: "Energia", value: +totalEnergy.toFixed(0), color: C.energy },
 { name: "Gas", value: +totalGas.toFixed(0), color: C.gas },
 { name: "Mobile", value: +totalMobile.toFixed(0), color: C.mobile },
 { name: "Fisso", value: +totalFixed.toFixed(0), color: C.fixed },
 { name: "Connettività", value: +totalConn.toFixed(0), color: C.conn },
 ];

 return (
 <div>
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label={`Spesa Totale ${companyName}`} value={fmtEuro(grandTotal, 0)} color={C.accent} change={-3.2} sub="vs anno precedente" />
 <KPICard label="Energia Elettrica" value={fmtEuro(totalEnergy, 0)} color={C.energy} sub={`${fmt(totalEnergy/grandTotal*100, 1)}% del totale`} />
 <KPICard label="Gas Naturale" value={fmtEuro(totalGas, 0)} color={C.gas} sub={`${fmt(totalGas/grandTotal*100, 1)}%`} />
 <KPICard label="Telefonia Mobile" value={fmtEuro(totalMobile, 0)} color={C.mobile} sub={`${mobileLines.length} linee attive`} />
 <KPICard label="Telefonia Fissa" value={fmtEuro(totalFixed, 0)} color={C.fixed} sub={`${fixedLines.length} linee`} />
 <KPICard label="Connettività" value={fmtEuro(totalConn, 0)} color={C.conn} sub={`${connectivity.length} collegamenti`} />
 </div>

 <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr", gap: 16, marginBottom: 20 }}>
 <ChartCard title=" Trend Spesa Mensile per Utility">
 <ResponsiveContainer width="100%" height={300}>
 <BarChart data={monthlyTrend} margin={{ top: 5, right: 10, bottom: 5, left: 10 }}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${(v/1000).toFixed(0)}k`} />
 <Tooltip contentStyle={customTooltipStyle} formatter={(v) => fmtEuro(v, 0)} />
 <Legend wrapperStyle={{ fontSize: 11 }} />
 <Bar dataKey="energia" stackId="a" fill={C.energy} name="Energia" radius={[0,0,0,0]} />
 <Bar dataKey="gas" stackId="a" fill={C.gas} name="Gas" />
 <Bar dataKey="mobile" stackId="a" fill={C.mobile} name="Mobile" />
 <Bar dataKey="fisso" stackId="a" fill={C.fixed} name="Fisso" />
 <Bar dataKey="conn" stackId="a" fill={C.conn} name="Connettività" radius={[4,4,0,0]} />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>

 <ChartCard title=" Distribuzione per Utility">
 <ResponsiveContainer width="100%" height={300}>
 <PieChart>
 <Pie data={donutData} cx="50%" cy="50%" innerRadius={60} outerRadius={100} paddingAngle={3} dataKey="value" stroke="none">
 {donutData.map((entry, i) => <Cell key={i} fill={entry.color} />)}
 </Pie>
 <Tooltip contentStyle={customTooltipStyle} formatter={(v) => fmtEuro(v, 0)} />
 <Legend wrapperStyle={{ fontSize: 11 }} />
 </PieChart>
 </ResponsiveContainer>
 </ChartCard>
 </div>

 {/* Site KPI row */}
 <div style={{
 background: `linear-gradient(135deg, #8B5CF608, ${C.card})`,
 borderRadius: 14, border: `1px solid #8B5CF622`, padding: 18, marginBottom: 20,
 }}>
 <div style={{ fontSize: 13, fontWeight: 700, color: C.text, marginBottom: 12, display: "flex", alignItems: "center", gap: 8 }}>
 Patrimonio Immobiliare
 <span style={{ fontSize: 11, fontWeight: 400, color: C.textDim }}>— riepilogo siti</span>
 </div>
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(155px, 1fr))", gap: 12 }}>
 <KPICard label="N. Siti" value={buildingStats.count} color="#8B5CF6" />
 <KPICard label="Costo Siti" value={fmtEuro(buildingStats.totalCost, 0)} color={C.accent} sub="/anno" />
 <KPICard label="Dispositivi" value={buildingStats.totalDevices} color={C.conn} sub="associati" />
 <KPICard label="Costo Medio/Sito" value={buildingStats.count > 0 ? fmtEuro(buildingStats.totalCost / buildingStats.count, 0) : "—"} color="#8B5CF6" sub="/anno" />
 <KPICard label="Sito più Costoso" value={buildingStats.costliest ? fmtEuro(buildingStats.costliest.totalCost, 0) : "—"} color={C.warn} sub={buildingStats.costliest?.name?.split(" - ")[0] || ""} />
 </div>
 </div>

 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
 <ChartCard title=" Top Siti per Spesa Totale">
 <ResponsiveContainer width="100%" height={Math.max(160, buildingStats.topBuildings.length * 40)}>
 <BarChart data={buildingStats.topBuildings} layout="vertical" margin={{ left: 150 }}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis type="number" tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${(v/1000).toFixed(0)}k`} />
 <YAxis type="category" dataKey="name" tick={{ fill: C.textMuted, fontSize: 10 }} width={145} />
 <Tooltip contentStyle={customTooltipStyle} formatter={(v) => fmtEuro(v, 0)} />
 <Bar dataKey="totalCost" fill="#8B5CF6" radius={[0, 6, 6, 0]} name="Totale">
 {buildingStats.topBuildings.map((b, i) => {
 const compObj = COMPANIES.find(c => c.id === b.company);
 return <Cell key={i} fill={compObj?.color || C.accent} />;
 })}
 </Bar>
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>

 <ChartCard title=" Anomalie & Alert">
 <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
 {[
 { text: "POD IT001E00054321 — consumo +32% vs media trimestre", type: "warn" },
 { text: "Conguaglio elevato su IT001E00012345 (€1,240)", type: "danger" },
 { text: "3 fatture gas in scadenza entro 7gg", type: "warn" },
 { text: "Budget energia superato del 5% (Q3)", type: "danger" },
 ].map((a, i) => (
 <div key={i} style={{ display: "flex", gap: 10, alignItems: "center", padding: "8px 12px", borderRadius: 8, background: `${a.type === "danger" ? C.danger : C.warn}11`, borderLeft: `3px solid ${a.type === "danger" ? C.danger : C.warn}` }}>
 <span style={{ fontSize: 14 }}>{a.type === "danger" ? "" : ""}</span>
 <span style={{ fontSize: 12, color: C.text }}>{a.text}</span>
 </div>
 ))}
 </div>
 </ChartCard>
 </div>
 </div>
 );
}

// ─── ENERGY DASHBOARD ─────────────────────────────────────────────────────────

function EnergySubNav({ active, onChange }) {
 const tabs = [
 { key: "analisi_pod", label: "Analisi per POD" },
 { key: "contabilita", label: "Vista Contabilità" },
 { key: "competenza", label: "Vista Competenza" },
 { key: "budget", label: "Budget" },
 { key: "stato_fatt", label: "Stato Fatturazione" },
 { key: "contratti", label: "Contratti" },
 ];
 return (
 <div style={{ display: "flex", gap: 2, background: "#e9ecf1", borderRadius: 12, padding: 4, border: `1px solid ${C.border}`, marginBottom: 22 }}>
 {tabs.map(t => (
 <button key={t.key} onClick={() => onChange(t.key)} style={{
 padding: "9px 18px", borderRadius: 9, border: "none", cursor: "pointer",
 fontSize: 13, fontWeight: 600, fontFamily: "inherit", transition: "all 0.2s",
 background: active === t.key ? `linear-gradient(135deg, ${C.energy}, ${C.energy}cc)` : "transparent",
 color: active === t.key ? "#fff" : C.textMuted,
 boxShadow: active === t.key ? `0 2px 8px ${C.energy}33` : "none",
 }}>{t.label}</button>
 ))}
 </div>
 );
}

function EnergyPODAnalysis() {
 const { energyData: ENERGY_DATA, pods: PODS } = useCompanyFilter();
 const [searchPod, setSearchPod] = useState("");
 const [filterCity, setFilterCity] = useState("all");
 const [filterCdc, setFilterCdc] = useState("all");
 const [selectedPod, setSelectedPod] = useState(null);

 const podStats = useMemo(() => PODS.map(pod => {
 const rows = ENERGY_DATA.filter(d => d.pod === pod.id);
 const totConsumo = rows.reduce((s, d) => s + d.consumoTotale, 0);
 const totFattura = rows.reduce((s, d) => s + d.totaleFattura, 0);
 const totEnergia = rows.reduce((s, d) => s + d.importoEnergia, 0);
 const totConguagli = rows.reduce((s, d) => s + d.conguaglio, 0);
 const pctEstimated = rows.filter(d => d.isEstimated).length / rows.length * 100;
 const avgPowerMax = rows.reduce((s, d) => s + d.potenzaMax, 0) / rows.length;
 const costoUnit = totConsumo > 0 ? totEnergia / totConsumo : 0;
 const consumoF1 = rows.reduce((s, d) => s + d.consumoF1, 0);
 const consumoF2 = rows.reduce((s, d) => s + d.consumoF2, 0);
 const consumoF3 = rows.reduce((s, d) => s + d.consumoF3, 0);
 // month trend for sparkline
 const monthly = Array.from({ length: 12 }, (_, m) => {
 const mr = rows.filter(d => d.meseConsumi === m);
 return { m, consumo: mr.reduce((s, d) => s + d.consumoTotale, 0), costo: mr.reduce((s, d) => s + d.totaleFattura, 0) };
 });
 return {
 ...pod, totConsumo, totFattura, totEnergia, costoUnit, totConguagli, pctEstimated,
 avgPowerMax: +avgPowerMax.toFixed(0), consumoF1, consumoF2, consumoF3, monthly,
 nFatture: rows.length,
 nStorni: rows.filter(d => d.tipoDocumento === "S").length,
 };
 }), []);

 const filtered = podStats.filter(p => {
 if (searchPod && !p.id.toLowerCase().includes(searchPod.toLowerCase()) && !p.site.toLowerCase().includes(searchPod.toLowerCase()) && !p.person.toLowerCase().includes(searchPod.toLowerCase())) return false;
 if (filterCity !== "all" && p.city !== filterCity) return false;
 if (filterCdc !== "all" && p.cdc !== filterCdc) return false;
 return true;
 });

 const totalConsumo = podStats.reduce((s, p) => s + p.totConsumo, 0);
 const totalFattura = podStats.reduce((s, p) => s + p.totFattura, 0);
 const totalEnergia = podStats.reduce((s, p) => s + p.totEnergia, 0);
 const avgCostoUnit = totalConsumo > 0 ? totalEnergia / totalConsumo : 0;

 const cities = [...new Set(PODS.map(p => p.city))];
 const cdcs = [...new Set(PODS.map(p => p.cdc))];

 // Detail view for a selected POD
 if (selectedPod) {
 const pod = podStats.find(p => p.id === selectedPod);
 if (!pod) { setSelectedPod(null); return null; }
 return (
 <div>
 <button onClick={() => setSelectedPod(null)} style={{ background: "none", border: "none", color: C.accentLight, cursor: "pointer", fontSize: 13, fontFamily: "inherit", marginBottom: 16, padding: 0 }}>
 ← Torna all'elenco POD
 </button>
 <SectionTitle sub={`${pod.site} · ${pod.city} · Potenza contrattuale: ${pod.power} kW`}>
 Dettaglio POD: <span style={{ color: C.energy, fontFamily: "monospace" }}>{pod.id}</span>
 </SectionTitle>

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(170px, 1fr))", gap: 12, marginBottom: 20 }}>
 <KPICard label="Consumo Annuo" value={`${fmt(pod.totConsumo)} kWh`} color={C.energy} />
 <KPICard label="Costo Unitario" value={`€${pod.costoUnit.toLocaleString("it-IT", {minimumFractionDigits:4, maximumFractionDigits:4})}/kWh`} color={C.energyLight} />
 <KPICard label="Totale Fatturato" value={fmtEuro(pod.totFattura, 0)} color={C.accent} />
 <KPICard label="Potenza Max Media" value={`${pod.avgPowerMax} kW`} color={C.accentLight} sub={`Contr.: ${pod.power} kW`} />
 <KPICard label="Conguagli" value={fmtEuro(pod.totConguagli, 0)} color={pod.totConguagli > 0 ? C.danger : C.success} />
 <KPICard label="% Dati Stimati" value={`${fmt(pod.pctEstimated, 0)}%`} color={pod.pctEstimated > 20 ? C.warn : C.success} warning={pod.pctEstimated > 20} />
 </div>

 {/* Anagrafica */}
 <div style={{ background: C.card, borderRadius: 12, padding: 18, border: `1px solid ${C.border}`, marginBottom: 20 }}>
 <div style={{ fontSize: 13, fontWeight: 600, color: C.textMuted, marginBottom: 10 }}> Anagrafica Punto di Prelievo</div>
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "8px 24px", fontSize: 13 }}>
 {[
 ["POD", pod.id], ["Cliente", pod.client], ["Sito", pod.site],
 ["Città", pod.city], ["Potenza Contrattuale", `${pod.power} kW`], ["Centro di Costo", pod.cdc],
 ["Assegnatario", pod.person], ["Reparto", pod.dept], ["N. Fatture", pod.nFatture],
 ].map(([k, v]) => (
 <div key={k} style={{ display: "flex", gap: 8 }}>
 <span style={{ color: C.textDim, minWidth: 120 }}>{k}:</span>
 <span style={{ color: C.text, fontWeight: 500 }}>{v}</span>
 </div>
 ))}
 </div>
 </div>

 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 20 }}>
 <ChartCard title="Trend Consumo Mensile (kWh)">
 <ResponsiveContainer width="100%" height={240}>
 <BarChart data={pod.monthly.map(d => ({ name: MONTHS[d.m], consumo: d.consumo }))}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => `${fmt(v)} kWh`} />
 <Bar dataKey="consumo" fill={C.energy} radius={[4,4,0,0]} name="kWh" />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>
 <ChartCard title="Trend Costo Mensile (€)">
 <ResponsiveContainer width="100%" height={240}>
 <BarChart data={pod.monthly.map(d => ({ name: MONTHS[d.m], costo: +d.costo.toFixed(0) }))}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${v}`} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v, 0)} />
 <Bar dataKey="costo" fill={C.accent} radius={[4,4,0,0]} name="€" />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>
 </div>

 <ChartCard title="Mix Fasce Orarie Annuo" style={{ marginBottom: 20 }}>
 <ResponsiveContainer width="100%" height={200}>
 <PieChart>
 <Pie data={[
 { name: "F1 Punta", value: pod.consumoF1, color: C.f1 },
 { name: "F2 Intermedia", value: pod.consumoF2, color: C.f2 },
 { name: "F3 Fuori punta", value: pod.consumoF3, color: C.f3 },
 ]} cx="50%" cy="50%" innerRadius={45} outerRadius={75} paddingAngle={3} dataKey="value" stroke="none">
 <Cell fill={C.f1} /><Cell fill={C.f2} /><Cell fill={C.f3} />
 </Pie>
 <Tooltip contentStyle={customTooltipStyle} formatter={v => `${fmt(v)} kWh`} />
 <Legend wrapperStyle={{ fontSize: 11 }} />
 </PieChart>
 </ResponsiveContainer>
 </ChartCard>

 <SectionTitle>Storico Fatture</SectionTitle>
 <DataTable
 columns={[
 { key: "meseConsumi", label: "Mese Comp.", render: v => MONTHS[v] },
 { key: "meseEmissione", label: "Mese Emiss.", render: v => MONTHS[v] },
 { key: "consumoTotale", label: "Consumo kWh", align: "right", render: v => fmt(v) },
 { key: "totaleFattura", label: "Totale €", align: "right", render: v => <strong>{fmtEuro(v)}</strong> },
 { key: "conguaglio", label: "Conguaglio", align: "right", render: v => v !== 0 ? <Badge color={v > 0 ? C.danger : C.success}>{fmtEuro(v)}</Badge> : "—" },
 { key: "consumiDefinitivi", label: "Fonte Dato", render: (v, row) => <Badge color={row.isEstimated ? C.warn : C.success}>{v}</Badge> },
 { key: "tipoDocumento", label: "Tipo", render: v => <Badge color={v === "S" ? C.danger : C.success}>{v === "S" ? "Storno" : "Fattura"}</Badge> },
 ]}
 data={ENERGY_DATA.filter(d => d.pod === pod.id)}
 maxHeight={320}
 />
 </div>
 );
 }

 return (
 <div>
 <SectionTitle sub="Overview dei punti di prelievo con KPI aggregati e drill-down per singolo POD">Analisi per POD — Energia Elettrica</SectionTitle>

 {/* OVERVIEW KPIs */}
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="POD Totali" value={PODS.length} color={C.energy} />
 <KPICard label="Consumo Totale Annuo" value={`${fmt(totalConsumo)} kWh`} color={C.energyLight} />
 <KPICard label="Spesa Totale Annua" value={fmtEuro(totalFattura, 0)} color={C.accent} />
 <KPICard label="Costo Medio" value={`€${avgCostoUnit.toLocaleString("it-IT", {minimumFractionDigits:4, maximumFractionDigits:4})}/kWh`} color={C.success} />
 </div>

 {/* Comparison bar chart per Città */}
 <ChartCard title="Consumo Annuo per Città (kWh)" style={{ marginBottom: 22 }}>
 <ResponsiveContainer width="100%" height={200}>
 <BarChart data={(() => {
 const byCity = {};
 podStats.forEach(p => { byCity[p.city] = (byCity[p.city] || 0) + p.totConsumo; });
 return Object.entries(byCity).map(([city, consumo]) => ({ name: city, consumo })).sort((a, b) => b.consumo - a.consumo);
 })()} layout="vertical" margin={{ left: 80 }}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis type="number" tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `${(v/1000).toFixed(0)}k`} />
 <YAxis type="category" dataKey="name" tick={{ fill: C.textMuted, fontSize: 11 }} width={80} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => `${fmt(v)} kWh`} />
 <Bar dataKey="consumo" fill={C.energy} radius={[0,6,6,0]} name="kWh" />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>

 {/* FILTERS */}
 <div style={{ display: "flex", gap: 10, marginBottom: 16, flexWrap: "wrap", alignItems: "center" }}>
 <input
 value={searchPod} onChange={e => setSearchPod(e.target.value)}
 placeholder=" Cerca POD, sito, persona..."
 style={{ flex: 1, minWidth: 220, padding: "9px 14px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 13, fontFamily: "inherit", outline: "none" }}
 />
 <select value={filterCity} onChange={e => setFilterCity(e.target.value)} style={{ padding: "9px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 12, fontFamily: "inherit" }}>
 <option value="all">Tutte le città</option>
 {cities.map(c => <option key={c} value={c}>{c}</option>)}
 </select>
 <select value={filterCdc} onChange={e => setFilterCdc(e.target.value)} style={{ padding: "9px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 12, fontFamily: "inherit" }}>
 <option value="all">Tutti i CdC</option>
 {cdcs.map(c => <option key={c} value={c}>{c}</option>)}
 </select>
 <div style={{ fontSize: 12, color: C.textDim }}>{filtered.length} di {podStats.length} POD</div>
 </div>

 {/* POD TABLE */}
 <DataTable
 columns={[
 { key: "id", label: "POD", render: (v) => (
 <span onClick={() => setSelectedPod(v)} style={{ fontFamily: "monospace", fontSize: 12, color: C.accentLight, cursor: "pointer", textDecoration: "underline", textDecorationStyle: "dotted" }}>{v}</span>
 )},
 { key: "site", label: "Sito / Indirizzo" },
 { key: "city", label: "Città" },
 { key: "power", label: "P. Contr. kW", align: "right", render: v => `${v} kW` },
 { key: "cdc", label: "CdC", render: v => <Badge color={C.energyLight} bg={`${C.energy}18`}>{v}</Badge> },
 { key: "person", label: "Assegnatario" },
 { key: "totConsumo", label: "Consumo kWh", align: "right", render: v => <strong>{fmt(v)}</strong> },
 { key: "totFattura", label: "Spesa €", align: "right", render: v => <strong style={{ color: C.energyLight }}>{fmtEuro(v, 0)}</strong> },
 { key: "costoUnit", label: "€/kWh", align: "right", render: v => `€${v.toLocaleString("it-IT", {minimumFractionDigits:4, maximumFractionDigits:4})}` },
 { key: "avgPowerMax", label: "P.Max kW", align: "right" },
 { key: "pctEstimated", label: "% Stimato", align: "right", render: v => (
 <span style={{ color: v > 20 ? C.warn : C.success }}>{v.toFixed(0)}% {v > 20 ? "" : ""}</span>
 )},
 { key: "totConguagli", label: "Conguagli", align: "right", render: v => v !== 0 ? <Badge color={v > 0 ? C.danger : C.success}>{fmtEuro(v, 0)}</Badge> : "—" },
 ]}
 data={filtered}
 maxHeight={420}
 />
 <div style={{ fontSize: 11, color: C.textDim, marginTop: 8 }}> Clicca su un POD per il drill-down completo con trend, fasce orarie e storico fatture.</div>
 </div>
 );
}

// ─── COPERTURA FATTURAZIONE ───────────────────────────────────────────────────

function StatoFatturazione({ utility }) {
 const { energyData, gasData, pods, pdrs } = useCompanyFilter();
 const isEnergy = utility === "energia";
 const data = isEnergy ? energyData : gasData;
 const devices = isEnergy ? pods : pdrs;
 const idKey = isEnergy ? "pod" : "pdr";
 const idLabel = isEnergy ? "POD" : "PDR";
 const unitLabel = isEnergy ? "kWh" : "Smc";
 const color = isEnergy ? C.energy : C.gas;

 const [year, setYear] = useState(2025);
 const [sortKey, setSortKey] = useState("id");
 const [sortDir, setSortDir] = useState("asc");

 const toggleSort = (key) => {
  if (sortKey === key) setSortDir(d => d === "asc" ? "desc" : "asc");
  else { setSortKey(key); setSortDir("asc"); }
 };

 // Build matrix: for each device, for each month, check if data exists
 const matrix = useMemo(() => {
  return devices.map(dev => {
   const devData = data.filter(d => d[idKey] === dev.id && d.anno === year);
   const months = Array.from({ length: 12 }, (_, m) => {
    const mRows = devData.filter(d => d.meseConsumi === m);
    if (mRows.length === 0) return { status: "missing", value: 0, cost: 0 };
    const consumo = isEnergy ? mRows.reduce((s, d) => s + d.consumoTotale, 0) : mRows.reduce((s, d) => s + d.consumoSmc, 0);
    const costo = mRows.reduce((s, d) => s + d.totaleFattura, 0);
    const isEstimated = isEnergy ? mRows.some(d => d.isEstimated) : false;
    return { status: isEstimated ? "estimated" : "ok", value: consumo, cost: costo };
   });
   const totCost = months.reduce((s, m) => s + m.cost, 0);
   const totConsumo = months.reduce((s, m) => s + m.value, 0);
   const coveredMonths = months.filter(m => m.status !== "missing").length;
   return { dev, months, totCost, totConsumo, coveredMonths, power: dev.power || 0 };
  });
 }, [devices, data, year, idKey, isEnergy]);

 // Sort
 const sorted = useMemo(() => {
  const arr = [...matrix];
  const dir = sortDir === "asc" ? 1 : -1;
  switch (sortKey) {
   case "id": arr.sort((a, b) => a.dev.id.localeCompare(b.dev.id) * dir); break;
   case "cost": arr.sort((a, b) => (a.totCost - b.totCost) * dir); break;
   case "consumo": arr.sort((a, b) => (a.totConsumo - b.totConsumo) * dir); break;
   case "copertura": arr.sort((a, b) => (a.coveredMonths - b.coveredMonths) * dir); break;
   default: break;
  }
  return arr;
 }, [matrix, sortKey, sortDir]);

 // Summary KPIs
 const totalDevices = devices.length;
 const fullyCovered = matrix.filter(r => r.coveredMonths === 12).length;
 const partialCovered = matrix.filter(r => r.coveredMonths > 0 && r.coveredMonths < 12).length;
 const noCoverage = matrix.filter(r => r.coveredMonths === 0).length;
 const totalMissing = matrix.reduce((s, r) => s + (12 - r.coveredMonths), 0);
 const coveragePct = totalDevices > 0 ? (matrix.reduce((s, r) => s + r.coveredMonths, 0) / (totalDevices * 12) * 100) : 0;

 const cellBg = (status) => {
  if (status === "ok") return { bg: `${C.success}`, text: "#fff" };
  if (status === "estimated") return { bg: C.warn, text: "#fff" };
  return { bg: "#f3f4f6", text: C.textDim };
 };

 const sortIcon = (key) => sortKey === key ? (sortDir === "asc" ? " ▲" : " ▼") : "";
 const thStyle = (key) => ({ fontSize: 10, fontWeight: 700, color: C.textMuted, cursor: "pointer", padding: "8px 4px", textAlign: "center", borderBottom: `2px solid ${C.border}`, background: sortKey === key ? `${color}08` : "transparent", userSelect: "none", whiteSpace: "nowrap", fontFamily: "inherit" });

 return (
  <div>
   <SectionTitle sub={`Stato fatturazione per ${idLabel} e mese di competenza. Cliccare sulle intestazioni per ordinare.`}>
    Stato Fatturazione — {isEnergy ? "Energia Elettrica" : "Gas Naturale"}
   </SectionTitle>

   {/* Year selector */}
   <div style={{ display: "flex", gap: 4, marginBottom: 16 }}>
    {YEARS.map(y => (
     <button key={y} onClick={() => setYear(y)} style={{
      padding: "6px 16px", borderRadius: 6, border: `1px solid ${year === y ? color : C.border}`,
      background: year === y ? color : C.card, color: year === y ? "#fff" : C.textMuted,
      fontSize: 12, fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
     }}>{y}</button>
    ))}
   </div>

   {/* KPIs */}
   <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(160px, 1fr))", gap: 14, marginBottom: 20 }}>
    <KPICard label="Copertura" value={`${fmt(coveragePct, 0)}%`} color={coveragePct >= 90 ? C.success : coveragePct >= 60 ? C.warn : C.danger} />
    <KPICard label={`${idLabel} Completi (12/12)`} value={fullyCovered} color={C.success} sub={`su ${totalDevices} totali`} />
    <KPICard label={`${idLabel} Parziali`} value={partialCovered} color={C.warn} />
    <KPICard label={`${idLabel} Senza Dati`} value={noCoverage} color={C.danger} />
    <KPICard label="Mesi Mancanti" value={totalMissing} color={totalMissing > 0 ? C.danger : C.success} sub={`su ${totalDevices * 12} totali`} />
   </div>

   {/* Legend */}
   <div style={{ display: "flex", gap: 16, marginBottom: 12, fontSize: 11, fontWeight: 600 }}>
    <div style={{ display: "flex", alignItems: "center", gap: 5 }}>
     <div style={{ width: 14, height: 14, borderRadius: 3, background: C.success }}></div> <span style={{ color: C.textMuted }}>Fatturato (definitivo)</span>
    </div>
    <div style={{ display: "flex", alignItems: "center", gap: 5 }}>
     <div style={{ width: 14, height: 14, borderRadius: 3, background: C.warn }}></div> <span style={{ color: C.textMuted }}>Fatturato (stimato)</span>
    </div>
    <div style={{ display: "flex", alignItems: "center", gap: 5 }}>
     <div style={{ width: 14, height: 14, borderRadius: 3, background: "#f3f4f6", border: `1px solid ${C.border}` }}></div> <span style={{ color: C.textMuted }}>Mancante</span>
    </div>
   </div>

   {/* Matrix table */}
   <div style={{ background: C.card, borderRadius: 10, border: `1px solid ${C.border}`, overflow: "auto", boxShadow: "0 1px 3px rgba(0,0,0,0.06)" }}>
    <table style={{ width: "100%", borderCollapse: "collapse", fontFamily: "inherit", fontSize: 11 }}>
     <thead>
      <tr>
       <th onClick={() => toggleSort("id")} style={{ ...thStyle("id"), textAlign: "left", paddingLeft: 12, minWidth: 140 }}>{idLabel}{sortIcon("id")}</th>
       <th style={{ ...thStyle(""), minWidth: 100, textAlign: "left" }}>Città</th>
       <th onClick={() => toggleSort("cost")} style={{ ...thStyle("cost"), minWidth: 85 }}>Spesa Tot.{sortIcon("cost")}</th>
       <th onClick={() => toggleSort("consumo")} style={{ ...thStyle("consumo"), minWidth: 90 }}>Consumo Netto{sortIcon("consumo")}</th>
       {isEnergy && <th style={{ ...thStyle(""), minWidth: 60 }}>Potenza</th>}
       <th onClick={() => toggleSort("copertura")} style={{ ...thStyle("copertura"), minWidth: 50 }}>Stato{sortIcon("copertura")}</th>
       {MONTHS.map((m, i) => (
        <th key={i} style={{ ...thStyle(""), minWidth: 48, fontSize: 9, lineHeight: 1.3 }}>{m}<br/><span style={{ fontWeight: 500, color: C.textDim }}>{year}</span></th>
       ))}
      </tr>
     </thead>
     <tbody>
      {sorted.map((row, ri) => (
       <tr key={row.dev.id} style={{ background: ri % 2 === 0 ? "transparent" : "#f9fafb" }}>
        <td style={{ padding: "6px 4px 6px 12px", fontWeight: 600, color: C.text, fontSize: 11, fontFamily: "'Inter', sans-serif", whiteSpace: "nowrap", letterSpacing: -0.3 }}>{row.dev.id}</td>
        <td style={{ padding: "6px 4px", fontSize: 11, color: C.textMuted, whiteSpace: "nowrap", maxWidth: 120, overflow: "hidden", textOverflow: "ellipsis" }} title={row.dev.site}>{row.dev.city}</td>
        <td style={{ padding: "6px 4px", textAlign: "right", fontWeight: 600, color: C.text, fontSize: 11 }}>{fmtEuro(row.totCost, 0)}</td>
        <td style={{ padding: "6px 4px", textAlign: "right", color: C.text, fontSize: 11 }}>{fmt(row.totConsumo)} {unitLabel}</td>
        {isEnergy && <td style={{ padding: "6px 4px", textAlign: "center", color: C.textMuted, fontSize: 11 }}>{row.power} kW</td>}
        <td style={{ padding: "6px 4px", textAlign: "center", fontWeight: 700, fontSize: 11, color: row.coveredMonths === 12 ? C.success : row.coveredMonths > 0 ? C.warn : C.danger }}>{row.coveredMonths}/12</td>
        {row.months.map((mc, mi) => {
         const { bg, text } = cellBg(mc.status);
         return (
          <td key={mi} title={mc.status === "missing" ? "Dato mancante" : `${fmt(mc.value)} ${unitLabel} · ${fmtEuro(mc.cost, 0)}`} style={{ padding: 2, textAlign: "center" }}>
           <div style={{
            width: "100%", height: 28, borderRadius: 3, background: bg, color: text,
            display: "flex", alignItems: "center", justifyContent: "center",
            fontSize: 9, fontWeight: 600, fontFamily: "inherit",
            border: mc.status === "missing" ? `1px solid ${C.border}` : "none",
           }}>
            {mc.status !== "missing" && fmt(mc.value, 0)}
           </div>
          </td>
         );
        })}
       </tr>
      ))}
     </tbody>
    </table>
   </div>

   {/* Summary row */}
   <div style={{ background: C.card, borderRadius: 8, padding: "10px 14px", border: `1px solid ${C.border}`, marginTop: 8, display: "flex", gap: 20, fontSize: 11, fontWeight: 600, color: C.textMuted }}>
    <span>Totale {idLabel}: {totalDevices}</span>
    <span>Copertura: <span style={{ color: coveragePct >= 90 ? C.success : C.warn, fontWeight: 700 }}>{fmt(coveragePct, 1)}%</span></span>
    <span>Mesi mancanti: <span style={{ color: totalMissing > 0 ? C.danger : C.success, fontWeight: 700 }}>{totalMissing}</span></span>
    <span>Spesa totale {year}: <span style={{ color: C.text, fontWeight: 700 }}>{fmtEuro(matrix.reduce((s, r) => s + r.totCost, 0), 0)}</span></span>
   </div>
  </div>
 );
}

function EnergyDashboard() {
 const [subPage, setSubPage] = useState("analisi_pod");

 return (
 <div>
 <EnergySubNav active={subPage} onChange={setSubPage} />
 {subPage === "analisi_pod" && <EnergyPODAnalysis />}
 {subPage === "contabilita" && <EnergyAccounting />}
 {subPage === "competenza" && <EnergyConsumption />}
 {subPage === "budget" && <UtilityBudgetTab utility="energia" />}
 {subPage === "stato_fatt" && <StatoFatturazione utility="energia" />}
 {subPage === "contratti" && <ContractTab utility="energia" />}
 </div>
 );
}

function EnergyAccounting() {
 const { energyData } = useCompanyFilter();
 const { preset, setPreset, filtered: ED, customFrom, setCustomFrom, customTo, setCustomTo } = usePeriodFilter(energyData);
 const byMonth = buildTimeline(ED, "meseEmissione", rows => ({
 fatturato: +rows.reduce((s, d) => s + d.totaleFattura, 0).toFixed(2),
 conguagli: +rows.reduce((s, d) => s + d.conguaglio, 0).toFixed(2),
 nFatture: rows.length,
 }));

 const totalFatturato = ED.reduce((s, d) => s + d.totaleFattura, 0);
 const totalConguagli = ED.reduce((s, d) => s + d.conguaglio, 0);
 const nStorni = ED.filter(d => d.tipoDocumento === "S").length;

 return (
 <div>
 <SectionTitle sub="Dati organizzati per data di emissione fattura">Vista Contabilità — Energia Elettrica</SectionTitle>
 <PeriodFilterBar preset={preset} setPreset={setPreset} customFrom={customFrom} setCustomFrom={setCustomFrom} customTo={customTo} setCustomTo={setCustomTo} />

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="Totale Fatturato" value={fmtEuro(totalFatturato, 0)} color={C.energy} />
 <KPICard label="N. Fatture Emesse" value={fmt(ENERGY_DATA.length)} color={C.accentLight} />
 <KPICard label="Storni / Note di Credito" value={nStorni} color={C.danger} />
 <KPICard label="Importo Conguagli" value={fmtEuro(totalConguagli, 0)} color={totalConguagli > 0 ? C.danger : C.success} />
 </div>

 <ChartCard title="Trend Fatturato per Data Emissione" style={{ marginBottom: 20 }}>
 <ResponsiveContainer width="100%" height={280}>
 <ComposedChart data={byMonth}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${(v/1000).toFixed(0)}k`} />
 <Tooltip contentStyle={customTooltipStyle} formatter={(v) => fmtEuro(v, 0)} />
 <Bar dataKey="fatturato" fill={C.energy} name="Fatturato" radius={[4,4,0,0]} />
 <Line dataKey="conguagli" stroke={C.danger} name="Conguagli" strokeWidth={2} dot={{ r: 3 }} />
 </ComposedChart>
 </ResponsiveContainer>
 </ChartCard>

 <SectionTitle>Dettaglio Fatture</SectionTitle>
 <FilteredTable
 data={ED}
 filters={[
 { key: "pod", label: "Tutti i POD", accessor: d => d.pod },
 { key: "site", label: "Tutti i siti", accessor: d => d.site },
 { key: "mese", label: "Tutti i mesi", accessor: d => d.meseEmissione, format: v => MONTHS[parseInt(v)] },
 ]}
 columns={[
 { key: "meseEmissione", label: "Mese Emissione", render: v => MONTHS[v] },
 { key: "pod", label: "POD" },
 { key: "site", label: "Sito" },
 { key: "tipoDocumento", label: "Tipo", render: v => <Badge color={v === "S" ? C.danger : C.success}>{v === "S" ? "Storno" : "Fattura"}</Badge> },
 { key: "consumoTotale", label: "Consumo kWh", align: "right", render: v => fmt(v) },
 { key: "totaleNettoIVA", label: "Netto IVA", align: "right", render: v => fmtEuro(v) },
 { key: "iva", label: "IVA", align: "right", render: v => fmtEuro(v) },
 { key: "totaleFattura", label: "Totale", align: "right", render: v => <strong>{fmtEuro(v)}</strong> },
 { key: "conguaglio", label: "Conguaglio", align: "right", render: v => v !== 0 ? <Badge color={v > 0 ? C.danger : C.success}>{fmtEuro(v)}</Badge> : "—" },
 ]}
 maxHeight={360}
 />
 </div>
 );
}

function EnergyConsumption() {
 const { energyData } = useCompanyFilter();
 const { preset, setPreset, filtered: ED, customFrom, setCustomFrom, customTo, setCustomTo } = usePeriodFilter(energyData);
 const byMonth = buildTimeline(ED, "meseConsumi", rows => {
 const totConsumo = rows.reduce((s, d) => s + d.consumoTotale, 0);
 const totEnergia = rows.reduce((s, d) => s + d.importoEnergia, 0);
 return {
 f1: rows.reduce((s, d) => s + d.consumoF1, 0),
 f2: rows.reduce((s, d) => s + d.consumoF2, 0),
 f3: rows.reduce((s, d) => s + d.consumoF3, 0),
 totale: totConsumo,
 costoUnitario: totConsumo > 0 ? +(totEnergia / totConsumo).toFixed(4) : 0,
 costoTotale: +rows.reduce((s, d) => s + d.totaleFattura, 0).toFixed(2),
 };
 });

 const totConsumo = ED.reduce((s, d) => s + d.consumoTotale, 0);
 const totEnergia = ED.reduce((s, d) => s + d.importoEnergia, 0);
 const pctEstimated = ED.length > 0 ? (ED.filter(d => d.isEstimated).length / ED.length * 100) : 0;
 const avgCostoUnit = totConsumo > 0 ? totEnergia / totConsumo : 0;
 const maxPower = ED.length > 0 ? Math.max(...ED.map(d => d.potenzaMax)) : 0;

 // Waterfall cost breakdown
 const totDisp = ED.reduce((s, d) => s + d.dispacciamento, 0);
 const totDist = ED.reduce((s, d) => s + d.distribuzione, 0);
 const totOneri = ED.reduce((s, d) => s + d.oneriSistema, 0);
 const totAccise = ED.reduce((s, d) => s + d.accise, 0);
 const totIva = ED.reduce((s, d) => s + d.iva, 0);
 const totConguagli = ED.reduce((s, d) => s + d.conguaglio, 0);
 const totBase = totEnergia+totDisp+totDist+totOneri+totAccise+totIva;

 const costBreakdown = [
 { name: "Materia Prima", eurKwh: totConsumo > 0 ? +(totEnergia / totConsumo).toFixed(4) : 0, total: +totEnergia.toFixed(0), pct: totBase > 0 ? +(totEnergia / totBase*100).toFixed(1) : 0, color: C.materia },
 { name: "Dispacciamento", eurKwh: totConsumo > 0 ? +(totDisp / totConsumo).toFixed(4) : 0, total: +totDisp.toFixed(0), pct: totBase > 0 ? +(totDisp / totBase*100).toFixed(1) : 0, color: C.dispacc },
 { name: "Distribuzione", eurKwh: totConsumo > 0 ? +(totDist / totConsumo).toFixed(4) : 0, total: +totDist.toFixed(0), pct: totBase > 0 ? +(totDist / totBase*100).toFixed(1) : 0, color: C.distrib },
 { name: "Oneri di Sistema", eurKwh: totConsumo > 0 ? +(totOneri / totConsumo).toFixed(4) : 0, total: +totOneri.toFixed(0), pct: totBase > 0 ? +(totOneri / totBase*100).toFixed(1) : 0, color: C.oneri },
 { name: "Imposte", eurKwh: totConsumo > 0 ? +(totAccise / totConsumo).toFixed(4) : 0, total: +totAccise.toFixed(0), pct: totBase > 0 ? +(totAccise / totBase*100).toFixed(1) : 0, color: C.imposte },
 ];

 return (
 <div>
 <SectionTitle sub="Dati organizzati per periodo di consumo effettivo (Mese/Anno Consumi)">Vista Competenza — Energia Elettrica</SectionTitle>
 <PeriodFilterBar preset={preset} setPreset={setPreset} customFrom={customFrom} setCustomFrom={setCustomFrom} customTo={customTo} setCustomTo={setCustomTo} />

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="Consumo Totale" value={`${fmt(totConsumo)} kWh`} color={C.energy} />
 <KPICard label="Costo Medio Unitario" value={`€${avgCostoUnit.toLocaleString("it-IT", {minimumFractionDigits:4, maximumFractionDigits:4})}/kWh`} color={C.energyLight} />
 <KPICard label="Potenza Max Assorbita" value={`${fmt(maxPower)} kW`} color={C.accent} />
 <KPICard label="POD Attivi" value={PODS.length} color={C.success} />
 <KPICard label="% Consumi Definitivi" value={`${fmt(100 - pctEstimated, 1)}%`} color={pctEstimated > 20 ? C.warn : C.success} warning={pctEstimated > 20} sub={`${fmt(pctEstimated, 1)}% stimati`} />
 </div>

 <ChartCard title="Trend Consumo Mensile per Fascia (kWh)" style={{ marginBottom: 16 }}>
 <ResponsiveContainer width="100%" height={280}>
 <ComposedChart data={byMonth}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis yAxisId="left" tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `${(v/1000).toFixed(0)}k`} />
 <YAxis yAxisId="right" orientation="right" tick={{ fill: C.energyLight, fontSize: 11 }} tickFormatter={v => `€${v}`} domain={[0, "auto"]} />
 <Tooltip contentStyle={customTooltipStyle} />
 <Legend wrapperStyle={{ fontSize: 11 }} />
 <Bar yAxisId="left" dataKey="f1" stackId="a" fill={C.f1} name="F1 Punta" />
 <Bar yAxisId="left" dataKey="f2" stackId="a" fill={C.f2} name="F2 Intermedia" />
 <Bar yAxisId="left" dataKey="f3" stackId="a" fill={C.f3} name="F3 Fuori punta" radius={[4,4,0,0]} />
 <Line yAxisId="right" dataKey="costoUnitario" stroke={C.energyLight} strokeWidth={2.5} dot={{ r: 3, fill: C.energyLight }} name="€/kWh" />
 </ComposedChart>
 </ResponsiveContainer>
 </ChartCard>

 <ChartCard title="Trend Costi Mensili (€)" style={{ marginBottom: 20 }}>
 <ResponsiveContainer width="100%" height={280}>
 <BarChart data={byMonth}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${(v/1000).toFixed(0)}k`} />
 <Tooltip contentStyle={customTooltipStyle} formatter={(v) => fmtEuro(v, 0)} />
 <Bar dataKey="costoTotale" fill={C.energy} name="Costo Totale €" radius={[4,4,0,0]} />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>

 {/* COST BREAKDOWN — WATERFALL */}
 <SectionTitle sub="Scomposizione del costo unitario €/kWh per componente">Costi Unitari — Analisi Waterfall</SectionTitle>
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 20 }}>
 <ChartCard title="Composizione Costo €/kWh">
 <ResponsiveContainer width="100%" height={240}>
 <BarChart data={costBreakdown} layout="vertical" margin={{ left: 100 }}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis type="number" tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${v}`} />
 <YAxis type="category" dataKey="name" tick={{ fill: C.textMuted, fontSize: 11 }} width={100} />
 <Tooltip contentStyle={customTooltipStyle} formatter={(v) => `€${v}/kWh`} />
 <Bar dataKey="eurKwh" radius={[0,6,6,0]} name="€/kWh">
 {costBreakdown.map((e, i) => <Cell key={i} fill={e.color} />)}
 </Bar>
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>
 <div>
 <DataTable
 columns={[
 { key: "name", label: "Componente", render: (v, row) => <span style={{ borderLeft: `3px solid ${row.color}`, paddingLeft: 8 }}>{v}</span> },
 { key: "eurKwh", label: "€/kWh", align: "right", render: v => `€${v}` },
 { key: "total", label: "€ Totale", align: "right", render: v => fmtEuro(v, 0) },
 { key: "pct", label: "% Totale", align: "right", render: v => `${v}%` },
 ]}
 data={costBreakdown}
 maxHeight={250}
 />
 </div>
 </div>

 <SectionTitle>Dettaglio Consumi per Competenza</SectionTitle>
 <FilteredTable
 data={ED}
 filters={[
 { key: "pod", label: "Tutti i POD", accessor: d => d.pod },
 { key: "site", label: "Tutti i siti", accessor: d => d.site },
 { key: "mese", label: "Tutti i mesi", accessor: d => d.meseConsumi, format: v => MONTHS[parseInt(v)] },
 ]}
 columns={[
 { key: "meseConsumi", label: "Mese Comp.", render: v => MONTHS[v] },
 { key: "pod", label: "POD" },
 { key: "site", label: "Sito" },
 { key: "consumoTotale", label: "Totale kWh", align: "right", render: v => fmt(v) },
 { key: "consumoF1", label: "F1 kWh", align: "right", render: v => fmt(v) },
 { key: "consumoF2", label: "F2 kWh", align: "right", render: v => fmt(v) },
 { key: "consumoF3", label: "F3 kWh", align: "right", render: v => fmt(v) },
 { key: "potenzaMax", label: "P.Max kW", align: "right", render: v => fmt(v) },
 { key: "consumiDefinitivi", label: "Fonte", render: (v, row) => <Badge color={row.isEstimated ? C.warn : C.success}>{v}</Badge> },
 { key: "costoUnit", label: "€/kWh", align: "right", render: (_, row) => row.consumoTotale > 0 ? `€${(row.importoEnergia / row.consumoTotale).toLocaleString("it-IT", {minimumFractionDigits:4, maximumFractionDigits:4})}` : "—", sortable: false },
 ]}
 maxHeight={360}
 />
 </div>
 );
}

// ─── GAS DASHBOARD ────────────────────────────────────────────────────────────

function GasSubNav({ active, onChange }) {
 const tabs = [
 { key: "analisi_pdr", label: "Analisi per PDR" },
 { key: "contabilita", label: "Vista Contabilità" },
 { key: "competenza", label: "Vista Competenza" },
 { key: "budget", label: "Budget" },
 { key: "stato_fatt", label: "Stato Fatturazione" },
 { key: "contratti", label: "Contratti" },
 ];
 return (
 <div style={{ display: "flex", gap: 2, background: "#e9ecf1", borderRadius: 12, padding: 4, border: `1px solid ${C.border}`, marginBottom: 22 }}>
 {tabs.map(t => (
 <button key={t.key} onClick={() => onChange(t.key)} style={{
 padding: "9px 18px", borderRadius: 9, border: "none", cursor: "pointer",
 fontSize: 13, fontWeight: 600, fontFamily: "inherit", transition: "all 0.2s",
 background: active === t.key ? `linear-gradient(135deg, ${C.gas}, ${C.gas}cc)` : "transparent",
 color: active === t.key ? "#fff" : C.textMuted,
 boxShadow: active === t.key ? `0 2px 8px ${C.gas}33` : "none",
 }}>{t.label}</button>
 ))}
 </div>
 );
}

function GasPDRAnalysis() {
 const { gasData: GAS_DATA, pdrs: PDRS } = useCompanyFilter();
 const [searchPdr, setSearchPdr] = useState("");
 const [filterCity, setFilterCity] = useState("all");
 const [filterCdc, setFilterCdc] = useState("all");
 const [selectedPdr, setSelectedPdr] = useState(null);

 const pdrStats = useMemo(() => PDRS.map(pdr => {
 const rows = GAS_DATA.filter(d => d.pdr === pdr.id);
 const totConsumo = rows.reduce((s, d) => s + d.consumoSmc, 0);
 const totFattura = rows.reduce((s, d) => s + d.totaleFattura, 0);
 const totImponibile = rows.reduce((s, d) => s + d.totaleImponibile, 0);
 const avgPCS = rows.reduce((s, d) => s + d.pcsMedio, 0) / rows.length;
 const costoUnit = totConsumo > 0 ? totFattura / totConsumo : 0;
 const totQV = rows.reduce((s, d) => s + d.qvMese, 0);
 const totTrasporto = rows.reduce((s, d) => s + d.trasporto, 0);
 const totOneri = rows.reduce((s, d) => s + d.oneri, 0);
 const totAccise = rows.reduce((s, d) => s + d.accise, 0);
 const monthly = Array.from({ length: 12 }, (_, m) => {
 const mr = rows.filter(d => d.meseConsumi === m);
 return { m, consumo: mr.reduce((s, d) => s + d.consumoSmc, 0), costo: +mr.reduce((s, d) => s + d.totaleFattura, 0).toFixed(0) };
 });
 return {
 ...pdr, totConsumo, totFattura, totImponibile, costoUnit, avgPCS, monthly,
 totQV, totTrasporto, totOneri, totAccise,
 nFatture: rows.length,
 };
 }), []);

 const filtered = pdrStats.filter(p => {
 if (searchPdr && !p.id.toLowerCase().includes(searchPdr.toLowerCase()) && !p.site.toLowerCase().includes(searchPdr.toLowerCase()) && !p.person.toLowerCase().includes(searchPdr.toLowerCase())) return false;
 if (filterCity !== "all" && p.city !== filterCity) return false;
 if (filterCdc !== "all" && p.cdc !== filterCdc) return false;
 return true;
 });

 const totalConsumo = pdrStats.reduce((s, p) => s + p.totConsumo, 0);
 const totalFattura = pdrStats.reduce((s, p) => s + p.totFattura, 0);
 const avgCostoUnit = totalConsumo > 0 ? totalFattura / totalConsumo : 0;
 const avgPCSAll = pdrStats.reduce((s, p) => s + p.avgPCS, 0) / pdrStats.length;

 const cities = [...new Set(PDRS.map(p => p.city))];
 const cdcs = [...new Set(PDRS.map(p => p.cdc))];

 // Detail view for a selected PDR
 if (selectedPdr) {
 const pdr = pdrStats.find(p => p.id === selectedPdr);
 if (!pdr) { setSelectedPdr(null); return null; }
 return (
 <div>
 <button onClick={() => setSelectedPdr(null)} style={{ background: "none", border: "none", color: C.accentLight, cursor: "pointer", fontSize: 13, fontFamily: "inherit", marginBottom: 16, padding: 0 }}>
 ← Torna all'elenco PDR
 </button>
 <SectionTitle sub={`${pdr.site} · ${pdr.city} · Distributore: ${pdr.distributor}`}>
 Dettaglio PDR: <span style={{ color: C.gas, fontFamily: "monospace" }}>{pdr.id}</span>
 </SectionTitle>

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(170px, 1fr))", gap: 12, marginBottom: 20 }}>
 <KPICard label="Consumo Annuo" value={`${fmt(pdr.totConsumo)} Smc`} color={C.gas} />
 <KPICard label="Costo Unitario" value={`€${pdr.costoUnit.toLocaleString("it-IT", {minimumFractionDigits:4, maximumFractionDigits:4})}/Smc`} color={C.gasLight} />
 <KPICard label="Totale Fatturato" value={fmtEuro(pdr.totFattura, 0)} color={C.accent} />
 <KPICard label="PCS Medio" value={`${pdr.avgPCS.toFixed(2)} kJ/Smc`} color={C.accentLight} />
 </div>

 {/* Anagrafica */}
 <div style={{ background: C.card, borderRadius: 12, padding: 18, border: `1px solid ${C.border}`, marginBottom: 20 }}>
 <div style={{ fontSize: 13, fontWeight: 600, color: C.textMuted, marginBottom: 10 }}> Anagrafica Punto di Riconsegna</div>
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "8px 24px", fontSize: 13 }}>
 {[
 ["PDR", pdr.id], ["Cliente", pdr.client], ["Sito", pdr.site],
 ["Città", pdr.city], ["Distributore", pdr.distributor], ["Centro di Costo", pdr.cdc],
 ["Assegnatario", pdr.person], ["Reparto", pdr.dept], ["N. Fatture", pdr.nFatture],
 ].map(([k, v]) => (
 <div key={k} style={{ display: "flex", gap: 8 }}>
 <span style={{ color: C.textDim, minWidth: 120 }}>{k}:</span>
 <span style={{ color: C.text, fontWeight: 500 }}>{v}</span>
 </div>
 ))}
 </div>
 </div>

 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 20 }}>
 <ChartCard title="Trend Consumo Mensile (Smc)">
 <ResponsiveContainer width="100%" height={240}>
 <BarChart data={pdr.monthly.map(d => ({ name: MONTHS[d.m], consumo: d.consumo }))}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => `${fmt(v)} Smc`} />
 <Bar dataKey="consumo" fill={C.gas} radius={[4,4,0,0]} name="Smc" />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>
 <ChartCard title="Trend Costo Mensile (€)">
 <ResponsiveContainer width="100%" height={240}>
 <BarChart data={pdr.monthly.map(d => ({ name: MONTHS[d.m], costo: d.costo }))}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${v}`} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v, 0)} />
 <Bar dataKey="costo" fill={C.accent} radius={[4,4,0,0]} name="€" />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>
 </div>

 <ChartCard title="Scomposizione Costi Annua" style={{ marginBottom: 20 }}>
 <ResponsiveContainer width="100%" height={200}>
 <PieChart>
 <Pie data={[
 { name: "Materia Prima", value: +pdr.totQV.toFixed(0), color: C.materia },
 { name: "Trasporto", value: +pdr.totTrasporto.toFixed(0), color: C.distrib },
 { name: "Oneri Sistema", value: +pdr.totOneri.toFixed(0), color: C.oneri },
 { name: "Accise", value: +pdr.totAccise.toFixed(0), color: C.imposte },
 ]} cx="50%" cy="50%" innerRadius={45} outerRadius={75} paddingAngle={3} dataKey="value" stroke="none">
 <Cell fill={C.materia} /><Cell fill={C.distrib} /><Cell fill={C.oneri} /><Cell fill={C.imposte} />
 </Pie>
 <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v, 0)} />
 <Legend wrapperStyle={{ fontSize: 11 }} />
 </PieChart>
 </ResponsiveContainer>
 </ChartCard>

 <SectionTitle>Storico Fatture</SectionTitle>
 <DataTable
 columns={[
 { key: "meseConsumi", label: "Mese Comp.", render: v => MONTHS[v] },
 { key: "meseEmissione", label: "Mese Emiss.", render: v => MONTHS[v] },
 { key: "consumoSmc", label: "Consumo Smc", align: "right", render: v => fmt(v) },
 { key: "pcsMedio", label: "PCS", align: "right" },
 { key: "totaleFattura", label: "Totale €", align: "right", render: v => <strong>{fmtEuro(v)}</strong> },
 { key: "tipoFattura", label: "Tipo", render: v => <Badge color={v.includes("Storno") ? C.danger : C.success}>{v}</Badge> },
 ]}
 data={GAS_DATA.filter(d => d.pdr === pdr.id)}
 maxHeight={320}
 />
 </div>
 );
 }

 return (
 <div>
 <SectionTitle sub="Overview dei punti di riconsegna con KPI aggregati e drill-down per singolo PDR">Analisi per PDR — Gas Naturale</SectionTitle>

 {/* OVERVIEW KPIs */}
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="PDR Totali" value={PDRS.length} color={C.gas} />
 <KPICard label="Consumo Totale Annuo" value={`${fmt(totalConsumo)} Smc`} color={C.gasLight} />
 <KPICard label="Spesa Totale Annua" value={fmtEuro(totalFattura, 0)} color={C.accent} />
 <KPICard label="Costo Medio" value={`€${avgCostoUnit.toLocaleString("it-IT", {minimumFractionDigits:4, maximumFractionDigits:4})}/Smc`} color={C.success} />
 <KPICard label="PCS Medio" value={`${avgPCSAll.toFixed(2)} kJ/Smc`} color={C.accentLight} />
 </div>

 {/* Comparison charts per PDR */}
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 22 }}>
 <ChartCard title="Consumo Annuo per PDR (Smc)">
 <ResponsiveContainer width="100%" height={180}>
 <BarChart data={pdrStats.map(p => ({ name: p.city, consumo: p.totConsumo }))} layout="vertical" margin={{ left: 80 }}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis type="number" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis type="category" dataKey="name" tick={{ fill: C.textMuted, fontSize: 11 }} width={80} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => `${fmt(v)} Smc`} />
 <Bar dataKey="consumo" fill={C.gas} radius={[0,6,6,0]} name="Smc" />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>
 <ChartCard title="Stagionalità Consumi (confronto PDR)">
 <ResponsiveContainer width="100%" height={180}>
 <LineChart data={Array.from({ length: 12 }, (_, m) => {
 const o = { name: MONTHS[m] };
 pdrStats.forEach(p => { o[p.city] = p.monthly[m].consumo; });
 return o;
 })}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} />
 <Tooltip contentStyle={customTooltipStyle} />
 {pdrStats.map((p, i) => <Line key={p.id} dataKey={p.city} stroke={[C.gas, C.gasLight][i % 2]} strokeWidth={2} dot={{ r: 3 }} name={p.city} />)}
 </LineChart>
 </ResponsiveContainer>
 </ChartCard>
 </div>

 {/* FILTERS */}
 <div style={{ display: "flex", gap: 10, marginBottom: 16, flexWrap: "wrap", alignItems: "center" }}>
 <input
 value={searchPdr} onChange={e => setSearchPdr(e.target.value)}
 placeholder=" Cerca PDR, sito, persona..."
 style={{ flex: 1, minWidth: 220, padding: "9px 14px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 13, fontFamily: "inherit", outline: "none" }}
 />
 <select value={filterCity} onChange={e => setFilterCity(e.target.value)} style={{ padding: "9px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 12, fontFamily: "inherit" }}>
 <option value="all">Tutte le città</option>
 {cities.map(c => <option key={c} value={c}>{c}</option>)}
 </select>
 <select value={filterCdc} onChange={e => setFilterCdc(e.target.value)} style={{ padding: "9px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 12, fontFamily: "inherit" }}>
 <option value="all">Tutti i CdC</option>
 {cdcs.map(c => <option key={c} value={c}>{c}</option>)}
 </select>
 <div style={{ fontSize: 12, color: C.textDim }}>{filtered.length} di {pdrStats.length} PDR</div>
 </div>

 {/* PDR TABLE */}
 <DataTable
 columns={[
 { key: "id", label: "PDR", render: (v) => (
 <span onClick={() => setSelectedPdr(v)} style={{ fontFamily: "monospace", fontSize: 12, color: C.accentLight, cursor: "pointer", textDecoration: "underline", textDecorationStyle: "dotted" }}>{v}</span>
 )},
 { key: "site", label: "Sito / Indirizzo" },
 { key: "city", label: "Città" },
 { key: "distributor", label: "Distributore" },
 { key: "cdc", label: "CdC", render: v => <Badge color={C.gasLight} bg={`${C.gas}18`}>{v}</Badge> },
 { key: "person", label: "Assegnatario" },
 { key: "totConsumo", label: "Consumo Smc", align: "right", render: v => <strong>{fmt(v)}</strong> },
 { key: "totFattura", label: "Spesa €", align: "right", render: v => <strong style={{ color: C.gasLight }}>{fmtEuro(v, 0)}</strong> },
 { key: "costoUnit", label: "€/Smc", align: "right", render: v => `€${v.toLocaleString("it-IT", {minimumFractionDigits:4, maximumFractionDigits:4})}` },
 { key: "avgPCS", label: "PCS Medio", align: "right", render: v => v.toLocaleString("it-IT", {minimumFractionDigits:2, maximumFractionDigits:2}) },
 ]}
 data={filtered}
 maxHeight={420}
 />
 <div style={{ fontSize: 11, color: C.textDim, marginTop: 8 }}> Clicca su un PDR per il drill-down completo con trend, stagionalità e storico fatture.</div>
 </div>
 );
}

function GasDashboard() {
 const [subPage, setSubPage] = useState("analisi_pdr");

 return (
 <div>
 <GasSubNav active={subPage} onChange={setSubPage} />
 {subPage === "analisi_pdr" && <GasPDRAnalysis />}
 {subPage === "contabilita" && <GasContabilita />}
 {subPage === "competenza" && <GasCompetenza />}
 {subPage === "budget" && <UtilityBudgetTab utility="gas" />}
 {subPage === "stato_fatt" && <StatoFatturazione utility="gas" />}
 {subPage === "contratti" && <ContractTab utility="gas" />}
 </div>
 );
}

function GasContabilita() {
 const { gasData } = useCompanyFilter();
 const { preset, setPreset, filtered: GD, customFrom, setCustomFrom, customTo, setCustomTo } = usePeriodFilter(gasData);
 const byMonth = buildTimeline(GD, "meseEmissione", rows => {
 const totConsumo = rows.reduce((s, d) => s + d.consumoSmc, 0);
 const totFatt = rows.reduce((s, d) => s + d.totaleFattura, 0);
 return { consumo: totConsumo, fatturato: +totFatt.toFixed(0), costoUnit: totConsumo > 0 ? +(totFatt / totConsumo).toFixed(4) : 0 };
 });
 const totConsumo = GD.reduce((s, d) => s + d.consumoSmc, 0);
 const totFatt = GD.reduce((s, d) => s + d.totaleFattura, 0);
 const avgPCS = GD.length > 0 ? GD.reduce((s, d) => s + d.pcsMedio, 0) / GD.length : 0;

 return (
 <div>
 <SectionTitle sub="Dati organizzati per data di emissione fattura">Vista Contabilità — Gas Naturale</SectionTitle>
 <PeriodFilterBar preset={preset} setPreset={setPreset} customFrom={customFrom} setCustomFrom={setCustomFrom} customTo={customTo} setCustomTo={setCustomTo} />

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="Consumo Totale" value={`${fmt(totConsumo)} Smc`} color={C.gas} />
 <KPICard label="Costo Medio" value={totConsumo > 0 ? `€${totFatt / totConsumo.toLocaleString("it-IT", {minimumFractionDigits:4, maximumFractionDigits:4})}/Smc` : "—"} color={C.gasLight} />
 <KPICard label="PDR Attivi" value={PDRS.length} color={C.success} />
 <KPICard label="PCS Medio" value={`${avgPCS.toFixed(2)} kJ/Smc`} color={C.accent} />
 <KPICard label="Totale Fatturato" value={fmtEuro(totFatt, 0)} color={C.gas} />
 </div>

 <ChartCard title="Trend Fatturato per Data Emissione" style={{ marginBottom: 20 }}>
 <ResponsiveContainer width="100%" height={280}>
 <ComposedChart data={byMonth}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis yAxisId="l" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis yAxisId="r" orientation="right" tick={{ fill: C.gasLight, fontSize: 11 }} />
 <Tooltip contentStyle={customTooltipStyle} />
 <Bar yAxisId="l" dataKey="fatturato" fill={C.gas} name="Fatturato €" radius={[4,4,0,0]} />
 <Line yAxisId="r" dataKey="costoUnit" stroke={C.gasLight} strokeWidth={2.5} dot={{ r: 3 }} name="€/Smc" />
 </ComposedChart>
 </ResponsiveContainer>
 </ChartCard>

 <SectionTitle>Dettaglio Fatture per Emissione</SectionTitle>
 <FilteredTable
 data={GD}
 filters={[
 { key: "pdr", label: "Tutti i PDR", accessor: d => d.pdr },
 { key: "site", label: "Tutti i siti", accessor: d => d.site },
 { key: "mese", label: "Tutti i mesi", accessor: d => d.meseEmissione, format: v => MONTHS[parseInt(v)] },
 ]}
 columns={[
 { key: "meseEmissione", label: "Mese Emissione", render: v => MONTHS[v] },
 { key: "pdr", label: "PDR" },
 { key: "site", label: "Sito" },
 { key: "distributor", label: "Distributore" },
 { key: "consumoSmc", label: "Consumo Smc", align: "right", render: v => fmt(v) },
 { key: "pcsMedio", label: "PCS", align: "right" },
 { key: "totaleFattura", label: "Totale €", align: "right", render: v => <strong>{fmtEuro(v)}</strong> },
 { key: "tipoFattura", label: "Tipo", render: v => <Badge color={v.includes("Storno") ? C.danger : C.success}>{v}</Badge> },
 ]}
 maxHeight={320}
 />
 </div>
 );
}

function GasCompetenza() {
 const { gasData } = useCompanyFilter();
 const { preset, setPreset, filtered: GD, customFrom, setCustomFrom, customTo, setCustomTo } = usePeriodFilter(gasData);
 const byMonth = buildTimeline(GD, "meseConsumi", rows => {
 const totConsumo = rows.reduce((s, d) => s + d.consumoSmc, 0);
 const totFatt = rows.reduce((s, d) => s + d.totaleFattura, 0);
 return { consumo: totConsumo, fatturato: +totFatt.toFixed(0), costoUnit: totConsumo > 0 ? +(totFatt / totConsumo).toFixed(4) : 0 };
 });
 const totConsumo = GD.reduce((s, d) => s + d.consumoSmc, 0);
 const totFatt = GD.reduce((s, d) => s + d.totaleFattura, 0);
 const avgPCS = GD.length > 0 ? GD.reduce((s, d) => s + d.pcsMedio, 0) / GD.length : 0;

 return (
 <div>
 <SectionTitle sub="Dati organizzati per periodo di consumo effettivo">Vista Competenza — Gas Naturale</SectionTitle>
 <PeriodFilterBar preset={preset} setPreset={setPreset} customFrom={customFrom} setCustomFrom={setCustomFrom} customTo={customTo} setCustomTo={setCustomTo} />

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="Consumo Totale" value={`${fmt(totConsumo)} Smc`} color={C.gas} />
 <KPICard label="Costo Medio" value={totConsumo > 0 ? `€${totFatt / totConsumo.toLocaleString("it-IT", {minimumFractionDigits:4, maximumFractionDigits:4})}/Smc` : "—"} color={C.gasLight} />
 <KPICard label="PDR Attivi" value={PDRS.length} color={C.success} />
 <KPICard label="PCS Medio" value={`${avgPCS.toFixed(2)} kJ/Smc`} color={C.accent} />
 <KPICard label="Totale Fatturato" value={fmtEuro(totFatt, 0)} color={C.gas} />
 </div>

 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 20 }}>
 <ChartCard title="Trend Consumo Smc — per competenza">
 <ResponsiveContainer width="100%" height={280}>
 <ComposedChart data={byMonth}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis yAxisId="l" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis yAxisId="r" orientation="right" tick={{ fill: C.gasLight, fontSize: 11 }} />
 <Tooltip contentStyle={customTooltipStyle} />
 <Bar yAxisId="l" dataKey="consumo" fill={C.gas} name="Consumo Smc" radius={[4,4,0,0]} />
 <Line yAxisId="r" dataKey="costoUnit" stroke={C.gasLight} strokeWidth={2.5} dot={{ r: 3 }} name="€/Smc" />
 </ComposedChart>
 </ResponsiveContainer>
 </ChartCard>

 <ChartCard title="Scomposizione Costi €/Smc">
 {(() => {
 const totQV = GD.reduce((s, d) => s + d.qvMese, 0);
 const totQF = GD.reduce((s, d) => s + d.qfMese, 0);
 const totTr = GD.reduce((s, d) => s + d.trasporto, 0);
 const totOn = GD.reduce((s, d) => s + d.oneri, 0);
 const totAc = GD.reduce((s, d) => s + d.accise, 0);
 const gasBreakdown = [
 { name: "Materia Prima (QV)", value: +totQV.toFixed(0), color: C.materia },
 { name: "Quota Fissa (QF)", value: +totQF.toFixed(0), color: C.energy },
 { name: "Trasporto", value: +totTr.toFixed(0), color: C.distrib },
 { name: "Oneri Sistema", value: +totOn.toFixed(0), color: C.oneri },
 { name: "Accise", value: +totAc.toFixed(0), color: C.imposte },
 ];
 return (
 <ResponsiveContainer width="100%" height={280}>
 <PieChart>
 <Pie data={gasBreakdown} cx="50%" cy="50%" innerRadius={55} outerRadius={90} paddingAngle={2} dataKey="value" stroke="none">
 {gasBreakdown.map((e, i) => <Cell key={i} fill={e.color} />)}
 </Pie>
 <Tooltip contentStyle={customTooltipStyle} formatter={(v) => fmtEuro(v, 0)} />
 <Legend wrapperStyle={{ fontSize: 11 }} />
 </PieChart>
 </ResponsiveContainer>
 );
 })()}
 </ChartCard>
 </div>

 <SectionTitle>Dettaglio per Competenza</SectionTitle>
 <FilteredTable
 data={GD}
 filters={[
 { key: "pdr", label: "Tutti i PDR", accessor: d => d.pdr },
 { key: "site", label: "Tutti i siti", accessor: d => d.site },
 { key: "mese", label: "Tutti i mesi", accessor: d => d.meseConsumi, format: v => MONTHS[parseInt(v)] },
 ]}
 columns={[
 { key: "meseConsumi", label: "Mese Comp.", render: v => MONTHS[v] },
 { key: "pdr", label: "PDR" },
 { key: "site", label: "Sito" },
 { key: "distributor", label: "Distributore" },
 { key: "consumoSmc", label: "Consumo Smc", align: "right", render: v => fmt(v) },
 { key: "pcsMedio", label: "PCS", align: "right" },
 { key: "totaleFattura", label: "Totale €", align: "right", render: v => <strong>{fmtEuro(v)}</strong> },
 { key: "tipoFattura", label: "Tipo", render: v => <Badge color={v.includes("Storno") ? C.danger : C.success}>{v}</Badge> },
 ]}
 maxHeight={320}
 />
 </div>
 );
}

// ─── MOBILE DASHBOARD ─────────────────────────────────────────────────────────

function MobileDashboard() {
 const [mainTab, setMainTab] = useState("dati");
 const tabs = [{key:"dati",label:"Dati & Analisi"},{key:"budget",label:"Budget"},{key:"contratti",label:"Contratti"}];
 if (mainTab === "contratti") return (
 <div>
 <TabBar tabs={tabs} active={mainTab} onChange={setMainTab} style={{ marginBottom: 20 }} />
 <ContractTab utility="mobile" />
 </div>
 );
 if (mainTab === "budget") return (
 <div>
 <TabBar tabs={tabs} active={mainTab} onChange={setMainTab} style={{ marginBottom: 20 }} />
 <UtilityBudgetTab utility="mobile" />
 </div>
 );

 return <MobileDashboardContent mainTab={mainTab} setMainTab={setMainTab} />;
}

function MobileDashboardContent({ mainTab, setMainTab }) {
 const { mobileData, mobileLines: ML } = useCompanyFilter();
 const [view, setView] = useState("competenza");
 const { preset, setPreset, filtered: MD, customFrom, setCustomFrom, customTo, setCustomTo } = usePeriodFilter(mobileData);
 const totFatt = MD.reduce((s, d) => s + d.totaleFattura, 0);
 const avgLines = MD.length > 0 ? MD.reduce((s, d) => s + d.numLinee, 0) / MD.length : 0;
 const avgPerLine = avgLines > 0 ? totFatt / (avgLines * 12) : 0;
 const totFissa = MD.reduce((s, d) => s + d.spesaFissa, 0);
 const totVar = MD.reduce((s, d) => s + d.spesaVariabile, 0);

 const byMonth = buildTimeline(MD, view === "contabilita" ? "meseEmissione" : "meseConsumi", rows => ({
 spesaFissa: rows.reduce((s, d) => s + d.spesaFissa, 0),
 spesaVariabile: rows.reduce((s, d) => s + d.spesaVariabile, 0),
 altriAddebiti: rows.reduce((s, d) => s + d.altriAddebiti, 0),
 totale: rows.reduce((s, d) => s + d.totaleFattura, 0),
 }));

 const profileData = [
 { name: "5G Power Executive", linee: 2, unitCost: 25.41, total: 50.82 },
 { name: "Tim Deluxe XL", linee: 2, unitCost: 25.99, total: 51.98 },
 { name: "5G Power Unlimited", linee: 1, unitCost: 24.99, total: 24.99 },
 ];

 return (
 <div>
 <TabBar tabs={[{key:"dati",label:"Dati & Analisi"},{key:"budget",label:"Budget"},{key:"contratti",label:"Contratti"}]} active={mainTab} onChange={setMainTab} style={{ marginBottom: 20 }} />
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
 <SectionTitle sub={view === "contabilita" ? "Per data emissione" : "Per periodo di competenza"}>
 {view === "contabilita" ? "Vista Contabilità" : "Vista Competenza"} — Telefonia Mobile
 </SectionTitle>
 <ViewToggle view={view} onChange={setView} />
 </div>
 <PeriodFilterBar preset={preset} setPreset={setPreset} customFrom={customFrom} setCustomFrom={setCustomFrom} customTo={customTo} setCustomTo={setCustomTo} />

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="Totale Fatturato" value={fmtEuro(totFatt, 0)} color={C.mobile} />
 <KPICard label="Linee Attive (media)" value={fmt(Math.round(avgLines))} color={C.mobileLight} />
 <KPICard label="Costo Medio/Linea/Mese" value={fmtEuro(avgPerLine)} color={C.accent} />
 <KPICard label="Spesa Fissa vs Variabile" value={(totFissa+totVar) > 0 ? `${(totFissa/(totFissa+totVar)*100).toFixed(0)}% / ${(totVar/(totFissa+totVar)*100).toFixed(0)}%` : "—"} color={C.mobile} />
 </div>

 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 20 }}>
 <ChartCard title="Trend Spesa Mensile (Fissa + Variabile + Altri)">
 <ResponsiveContainer width="100%" height={280}>
 <BarChart data={byMonth}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${v}`} />
 <Tooltip contentStyle={customTooltipStyle} formatter={(v) => fmtEuro(v)} />
 <Legend wrapperStyle={{ fontSize: 11 }} />
 <Bar dataKey="spesaFissa" stackId="a" fill={C.mobile} name="Spesa Fissa" />
 <Bar dataKey="spesaVariabile" stackId="a" fill={C.mobileLight} name="Spesa Variabile" />
 <Bar dataKey="altriAddebiti" stackId="a" fill={C.accent} name="Altri Addebiti" radius={[4,4,0,0]} />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>

 <ChartCard title="Costo per Profilo Tariffario">
 <ResponsiveContainer width="100%" height={280}>
 <BarChart data={profileData} layout="vertical" margin={{ left: 110 }}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis type="number" tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${v}`} />
 <YAxis type="category" dataKey="name" tick={{ fill: C.textMuted, fontSize: 11 }} width={110} />
 <Tooltip contentStyle={customTooltipStyle} formatter={(v) => fmtEuro(v)} />
 <Bar dataKey="unitCost" fill={C.mobile} radius={[0,6,6,0]} name="€/linea/mese" />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>
 </div>

 <SectionTitle>Dettaglio Linee</SectionTitle>
 <FilteredTable
 data={ML}
 filters={[
 { key: "profile", label: "Tutti i profili", accessor: d => d.profile },
 { key: "dept", label: "Tutti i reparti", accessor: d => d.dept },
 { key: "person", label: "Tutti gli assegnatari", accessor: d => d.person },
 ]}
 columns={[
 { key: "id", label: "Numero" },
 { key: "profile", label: "Profilo" },
 { key: "person", label: "Assegnatario" },
 { key: "dept", label: "Reparto" },
 { key: "fixedCost", label: "Canone €/mese", align: "right", render: v => fmtEuro(v) },
 { key: "services", label: "Servizi Opzionali", render: v => v.map(s => <Badge key={s} color={C.mobileLight} bg={`${C.mobile}22`}>{s}</Badge>).reduce((a, b) => [a, " ", b]) },
 ]}
 maxHeight={280}
 />
 </div>
 );
}

// ─── FIXED LINE DASHBOARD ─────────────────────────────────────────────────────

function FixedDashboard() {
 const [mainTab, setMainTab] = useState("dati");
 const tabs = [{key:"dati",label:"Dati & Analisi"},{key:"budget",label:"Budget"},{key:"contratti",label:"Contratti"}];
 if (mainTab === "contratti") return (
 <div>
 <TabBar tabs={tabs} active={mainTab} onChange={setMainTab} style={{ marginBottom: 20 }} />
 <ContractTab utility="fisso" />
 </div>
 );
 if (mainTab === "budget") return (
 <div>
 <TabBar tabs={tabs} active={mainTab} onChange={setMainTab} style={{ marginBottom: 20 }} />
 <UtilityBudgetTab utility="fisso" />
 </div>
 );

 const { fixedData, fixedLines: FL } = useCompanyFilter();
 const { preset, setPreset, filtered: FD, customFrom, setCustomFrom, customTo, setCustomTo } = usePeriodFilter(fixedData);
 const totFatt = FD.reduce((s, d) => s + d.totaleFattura, 0);

 return (
 <div>
 <SectionTitle sub="Panoramica costi e servizi">Telefonia Fissa</SectionTitle>
 <TabBar tabs={tabs} active={mainTab} onChange={setMainTab} style={{ marginBottom: 20 }} />
 <PeriodFilterBar preset={preset} setPreset={setPreset} customFrom={customFrom} setCustomFrom={setCustomFrom} customTo={customTo} setCustomTo={setCustomTo} />
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="Totale Fatturato" value={fmtEuro(totFatt, 0)} color={C.fixed} />
 <KPICard label="Linee Attive" value={FL.length} color={C.fixedLight} />
 <KPICard label="Costo Medio/Linea" value={FL.length > 0 ? fmtEuro(totFatt / FL.length / 12) : "—"} color={C.accent} />
 </div>

 <ChartCard title="Trend Spesa Mensile" style={{ marginBottom: 20 }}>
 <ResponsiveContainer width="100%" height={240}>
 <BarChart data={buildTimeline(FD, "meseConsumi", rows => ({
 spesaFissa: rows.reduce((s,d) => s + d.spesaFissa, 0), prodotti: rows.reduce((s,d) => s + d.prodotti, 0), altri: rows.reduce((s,d) => s + d.altriAddebiti, 0)
 }))}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${v}`} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v)} />
 <Legend wrapperStyle={{ fontSize: 11 }} />
 <Bar dataKey="spesaFissa" stackId="a" fill={C.fixed} name="Spesa Fissa" />
 <Bar dataKey="prodotti" stackId="a" fill={C.fixedLight} name="Prodotti" />
 <Bar dataKey="altri" stackId="a" fill={C.accent} name="Altri" radius={[4,4,0,0]} />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>

 <SectionTitle>Dettaglio Linee</SectionTitle>
 <FilteredTable
 data={FL}
 filters={[
 { key: "site", label: "Tutte le sedi", accessor: d => d.site },
 { key: "service", label: "Tutti i servizi", accessor: d => d.service },
 { key: "cdc", label: "Tutti i CdC", accessor: d => d.cdc },
 ]}
 columns={[
 { key: "id", label: "Numero" },
 { key: "site", label: "Sede" },
 { key: "service", label: "Servizio" },
 { key: "monthlyCost", label: "Canone €/mese", align: "right", render: v => fmtEuro(v) },
 { key: "cdc", label: "CdC" },
 ]}
 maxHeight={200}
 />
 </div>
 );
}

// ─── CONNECTIVITY DASHBOARD ───────────────────────────────────────────────────

function ConnDashboard() {
 const [mainTab, setMainTab] = useState("dati");
 const tabs = [{key:"dati",label:"Dati & Analisi"},{key:"budget",label:"Budget"},{key:"contratti",label:"Contratti"}];
 if (mainTab === "contratti") return (
 <div>
 <TabBar tabs={tabs} active={mainTab} onChange={setMainTab} style={{ marginBottom: 20 }} />
 <ContractTab utility="connettivita" />
 </div>
 );
 if (mainTab === "budget") return (
 <div>
 <TabBar tabs={tabs} active={mainTab} onChange={setMainTab} style={{ marginBottom: 20 }} />
 <UtilityBudgetTab utility="connettivita" />
 </div>
 );

 const { connData, connectivity: CONN } = useCompanyFilter();
 const { preset, setPreset, filtered: CD, customFrom, setCustomFrom, customTo, setCustomTo } = usePeriodFilter(connData);
 const totFatt = CD.reduce((s, d) => s + d.totaleFattura, 0);

 return (
 <div>
 <SectionTitle sub="Panoramica collegamenti dati aziendali">Connettività</SectionTitle>
 <TabBar tabs={tabs} active={mainTab} onChange={setMainTab} style={{ marginBottom: 20 }} />
 <PeriodFilterBar preset={preset} setPreset={setPreset} customFrom={customFrom} setCustomFrom={setCustomFrom} customTo={customTo} setCustomTo={setCustomTo} />
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="Totale Periodo" value={fmtEuro(totFatt, 0)} color={C.conn} />
 <KPICard label="N. Collegamenti" value={CONN.length} color={C.connLight} />
 <KPICard label="Canone Medio" value={CONN.length > 0 ? fmtEuro(totFatt / CONN.length / 12) : "—"} color={C.accent} sub="/collegamento/mese" />
 </div>

 <SectionTitle>Dettaglio Collegamenti</SectionTitle>
 <FilteredTable
 data={CONN}
 filters={[
 { key: "site", label: "Tutte le sedi", accessor: d => d.site },
 { key: "type", label: "Tutti i tipi", accessor: d => d.type },
 { key: "sla", label: "Tutti i SLA", accessor: d => d.sla },
 ]}
 columns={[
 { key: "id", label: "ID Circuito" },
 { key: "site", label: "Sede" },
 { key: "type", label: "Tipo" },
 { key: "band", label: "Banda" },
 { key: "bmg", label: "BMG" },
 { key: "sla", label: "SLA", render: v => <Badge color={v === "Platinum" ? C.energy : v === "Gold" ? C.energyLight : C.textMuted}>{v}</Badge> },
 { key: "monthlyCost", label: "Canone €/mese", align: "right", render: v => fmtEuro(v) },
 { key: "cdc", label: "CdC" },
 ]}
 maxHeight={240}
 />
 </div>
 );
}

// ─── DEVICE REGISTRY ──────────────────────────────────────────────────────────

function DeviceRegistry() {
 const { pods: PODS, pdrs: PDRS, mobileLines: MOBILE_LINES, fixedLines: FIXED_LINES, connectivity: CONNECTIVITY } = useCompanyFilter();
 const [filter, setFilter] = useState("all");
 const [search, setSearch] = useState("");

 // Build device-to-site lookup from SITES
 const deviceBuildingMap = useMemo(() => {
 const map = {};
 BUILDINGS.forEach(bld => {
 bld.devices.pods.forEach(id => { map[`pods:${id}`] = bld; });
 bld.devices.pdrs.forEach(id => { map[`pdrs:${id}`] = bld; });
 bld.devices.fixedLines.forEach(id => { map[`fixedLines:${id}`] = bld; });
 bld.devices.connectivity.forEach(id => { map[`connectivity:${id}`] = bld; });
 bld.devices.mobileLines.forEach(id => { map[`mobileLines:${id}`] = bld; });
 });
 return map;
 }, []);

 const allDevices = useMemo(() => [
 ...PODS.map(p => ({ type: "energia", devType: "pods", typeLabel: " Energia", identifier: p.id, client: p.client, location: p.site, status: "Attivo", cdc: p.cdc, person: p.person, dept: p.dept, lastCost: ENERGY_DATA.filter(d => d.pod === p.id).slice(-1)[0]?.totaleFattura || 0, building: deviceBuildingMap[`pods:${p.id}`] || null })),
 ...PDRS.map(p => ({ type: "gas", devType: "pdrs", typeLabel: " Gas", identifier: p.id, client: p.client, location: p.site, status: "Attivo", cdc: p.cdc, person: p.person, dept: p.dept, lastCost: GAS_DATA.filter(d => d.pdr === p.id).slice(-1)[0]?.totaleFattura || 0, building: deviceBuildingMap[`pdrs:${p.id}`] || null })),
 ...MOBILE_LINES.map(l => ({ type: "mobile", devType: "mobileLines", typeLabel: " Mobile", identifier: l.id, client: "—", location: `${l.dept}`, status: "Attivo", cdc: l.cdc, person: l.person, dept: l.dept, lastCost: l.fixedCost, building: deviceBuildingMap[`mobileLines:${l.id}`] || null })),
 ...FIXED_LINES.map(l => ({ type: "fisso", devType: "fixedLines", typeLabel: " Fisso", identifier: l.id, client: "—", location: l.site, status: "Attivo", cdc: l.cdc, person: l.person, dept: "IT", lastCost: l.monthlyCost, building: deviceBuildingMap[`fixedLines:${l.id}`] || null })),
 ...CONNECTIVITY.map(c => ({ type: "connettivita", devType: "connectivity", typeLabel: " Conn.", identifier: c.id, client: "—", location: c.site, status: "Attivo", cdc: c.cdc, person: "IT Dept", dept: "IT", lastCost: c.monthlyCost, building: deviceBuildingMap[`connectivity:${c.id}`] || null })),
 ], [deviceBuildingMap]);

 const filtered = allDevices.filter(d => {
 if (filter !== "all" && d.type !== filter) return false;
 if (search && !Object.values(d).some(v => String(v).toLowerCase().includes(search.toLowerCase()))) return false;
 return true;
 });

 return (
 <div>
 <SectionTitle sub="Registro centralizzato di tutti i punti di fornitura / dispositivi con dati gestionali">Anagrafica Dispositivi</SectionTitle>

 <div style={{ display: "flex", gap: 12, marginBottom: 20, flexWrap: "wrap", alignItems: "center" }}>
 <input
 value={search} onChange={e => setSearch(e.target.value)}
 placeholder=" Cerca per ID, persona, CdC, sede..."
 style={{ flex: 1, minWidth: 240, padding: "10px 14px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 13, fontFamily: "inherit", outline: "none" }}
 />
 <TabBar
 tabs={[
 { key: "all", label: `Tutti (${allDevices.length})` },
 { key: "energia", label: "" },
 { key: "gas", label: "" },
 { key: "mobile", label: "" },
 { key: "fisso", label: "" },
 { key: "connettivita", label: "" },
 ]}
 active={filter}
 onChange={setFilter}
 />
 </div>

 <DataTable
 columns={[
 { key: "typeLabel", label: "Tipo" },
 { key: "identifier", label: "Identificativo", render: v => <span style={{ fontFamily: "monospace", fontSize: 12, color: C.accentLight }}>{v}</span> },
 { key: "building", label: "Sito", render: v => v ? (
 <span style={{ fontSize: 11, fontWeight: 600, color: C.text }}> {v.name}</span>
 ) : (
 <span style={{ fontSize: 11, color: C.warn, fontStyle: "italic" }}> Non associato</span>
 )},
 { key: "location", label: "Sede / Ubicazione" },
 { key: "status", label: "Stato", render: v => <Badge color={v === "Attivo" ? C.success : C.danger}>{v}</Badge> },
 { key: "cdc", label: "CdC", render: v => <span style={{ fontWeight: 600, color: C.energyLight }}>{v}</span> },
 { key: "person", label: "Assegnatario" },
 { key: "dept", label: "Reparto" },
 { key: "lastCost", label: "Ultimo Costo €", align: "right", render: v => fmtEuro(v) },
 ]}
 data={filtered}
 maxHeight={500}
 />

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))", gap: 14, marginTop: 24 }}>
 <div style={{ background: C.card, borderRadius: 10, padding: 16, border: `1px solid ${C.border}` }}>
 <div style={{ fontSize: 12, fontWeight: 600, color: C.textMuted, marginBottom: 8 }}>Dispositivi per Tipo</div>
 {Object.entries(UTILITY_META).map(([k, v]) => {
 const ct = allDevices.filter(d => d.type === k).length;
 return (
 <div key={k} style={{ display: "flex", justifyContent: "space-between", padding: "4px 0", fontSize: 13 }}>
 <span style={{ color: C.text }}>{v.label}</span>
 <span style={{ fontWeight: 700, color: v.color }}>{ct}</span>
 </div>
 );
 })}
 </div>
 <div style={{ background: C.card, borderRadius: 10, padding: 16, border: `1px solid ${C.border}` }}>
 <div style={{ fontSize: 12, fontWeight: 600, color: C.textMuted, marginBottom: 8 }}>Per Centro di Costo</div>
 {["CDC-001", "CDC-002", "CDC-003", "CDC-004"].map(cdc => {
 const devices = allDevices.filter(d => d.cdc === cdc);
 const totalCost = devices.reduce((s, d) => s + d.lastCost, 0);
 return (
 <div key={cdc} style={{ display: "flex", justifyContent: "space-between", padding: "4px 0", fontSize: 13 }}>
 <span style={{ color: C.text }}>{cdc}</span>
 <span style={{ color: C.textMuted }}>{devices.length} disp. · <strong style={{ color: C.energyLight }}>{fmtEuro(totalCost)}</strong></span>
 </div>
 );
 })}
 </div>
 <div style={{ background: C.card, borderRadius: 10, padding: 16, border: `1px solid ${C.border}` }}>
 <div style={{ fontSize: 12, fontWeight: 600, color: C.textMuted, marginBottom: 8 }}>Azioni Rapide</div>
 {[" Import da Excel", " Export Anagrafica", " Modifica Massiva CdC", " Assegna Tag"].map(a => (
 <div key={a} style={{ padding: "6px 0", fontSize: 13, color: C.accentLight, cursor: "pointer" }}>{a}</div>
 ))}
 </div>
 </div>
 </div>
 );
}

// ─── HELPERS: ACTUAL DATA PER UTILITY ─────────────────────────────────────────

function getActualByUtilityMonth(utility, m, co, anno) {
 const eD = co && co !== "all" ? ENERGY_DATA.filter(d => d.company === co) : ENERGY_DATA;
 const gD = co && co !== "all" ? GAS_DATA.filter(d => d.company === co) : GAS_DATA;
 const mD = co && co !== "all" ? MOBILE_DATA.filter(d => d.company === co) : MOBILE_DATA;
 const fD = co && co !== "all" ? FIXED_DATA.filter(d => d.company === co) : FIXED_DATA;
 const cD = co && co !== "all" ? CONN_DATA.filter(d => d.company === co) : CONN_DATA;
 const yf = (d) => anno ? d.anno === anno : true;
 switch (utility) {
 case "energia": return eD.filter(d => d.meseConsumi === m && yf(d)).reduce((s, d) => s + d.totaleFattura, 0);
 case "gas": return gD.filter(d => d.meseConsumi === m && yf(d)).reduce((s, d) => s + d.totaleFattura, 0);
 case "mobile": return mD.filter(d => d.meseConsumi === m && yf(d)).reduce((s, d) => s + d.totaleFattura, 0);
 case "fisso": return fD.filter(d => d.meseConsumi === m && yf(d)).reduce((s, d) => s + d.totaleFattura, 0);
 case "connettivita": return cD.filter(d => d.meseConsumi === m && yf(d)).reduce((s, d) => s + d.totaleFattura, 0);
 default: return 0;
 }
}
function getConsumoByUtilityMonth(utility, m, co, anno) {
 const eD = co && co !== "all" ? ENERGY_DATA.filter(d => d.company === co) : ENERGY_DATA;
 const gD = co && co !== "all" ? GAS_DATA.filter(d => d.company === co) : GAS_DATA;
 const yf = (d) => anno ? d.anno === anno : true;
 switch (utility) {
 case "energia": return eD.filter(d => d.meseConsumi === m && yf(d)).reduce((s, d) => s + d.consumoTotale, 0);
 case "gas": return gD.filter(d => d.meseConsumi === m && yf(d)).reduce((s, d) => s + d.consumoSmc, 0);
 default: return 0;
 }
}
function getMateriaPrimaByMonth(utility, m, co, anno) {
 const eD = co && co !== "all" ? ENERGY_DATA.filter(d => d.company === co) : ENERGY_DATA;
 const gD = co && co !== "all" ? GAS_DATA.filter(d => d.company === co) : GAS_DATA;
 const yf = (d) => anno ? d.anno === anno : true;
 if (utility === "energia") return eD.filter(d => d.meseConsumi === m && yf(d)).reduce((s, d) => s + d.importoEnergia, 0);
 if (utility === "gas") return gD.filter(d => d.meseConsumi === m && yf(d)).reduce((s, d) => s + d.qvMese, 0);
 return 0;
}
function getAltriOneriByMonth(utility, m, co, anno) {
 return getActualByUtilityMonth(utility, m, co, anno) - getMateriaPrimaByMonth(utility, m, co, anno);
}

const UTILITY_KEYS = ["energia", "gas", "mobile", "fisso", "connettivita"];

// Per-device helpers (POD/PDR level)
function getActualByDevice(utility, deviceId, m, co, anno) {
 const yf = (d) => anno ? d.anno === anno : true;
 if (utility === "energia") return ENERGY_DATA.filter(d => d.pod === deviceId && d.meseConsumi === m && yf(d) && (co === "all" || !co || d.company === co)).reduce((s, d) => s + d.totaleFattura, 0);
 if (utility === "gas") return GAS_DATA.filter(d => d.pdr === deviceId && d.meseConsumi === m && yf(d) && (co === "all" || !co || d.company === co)).reduce((s, d) => s + d.totaleFattura, 0);
 return 0;
}
function getConsumoByDevice(utility, deviceId, m, co, anno) {
 const yf = (d) => anno ? d.anno === anno : true;
 if (utility === "energia") return ENERGY_DATA.filter(d => d.pod === deviceId && d.meseConsumi === m && yf(d) && (co === "all" || !co || d.company === co)).reduce((s, d) => s + d.consumoTotale, 0);
 if (utility === "gas") return GAS_DATA.filter(d => d.pdr === deviceId && d.meseConsumi === m && yf(d) && (co === "all" || !co || d.company === co)).reduce((s, d) => s + d.consumoSmc, 0);
 return 0;
}
function getAltriOneriByDevice(utility, deviceId, m, co, anno) {
 const yf = (d) => anno ? d.anno === anno : true;
 if (utility === "energia") {
  const rows = ENERGY_DATA.filter(d => d.pod === deviceId && d.meseConsumi === m && yf(d) && (co === "all" || !co || d.company === co));
  const totFatt = rows.reduce((s, d) => s + d.totaleFattura, 0);
  const materia = rows.reduce((s, d) => s + d.importoEnergia, 0);
  return totFatt - materia;
 }
 if (utility === "gas") {
  const rows = GAS_DATA.filter(d => d.pdr === deviceId && d.meseConsumi === m && yf(d) && (co === "all" || !co || d.company === co));
  const totFatt = rows.reduce((s, d) => s + d.totaleFattura, 0);
  const materia = rows.reduce((s, d) => s + d.qvMese, 0);
  return totFatt - materia;
 }
 return 0;
}

// ─── REUSABLE UTILITY BUDGET TAB ──────────────────────────────────────────────

function UtilityBudgetTab({ utility }) {
 const meta = UTILITY_META[utility];
 const { co, pods, pdrs } = useCompanyFilter();
 const unit = utility === "energia" ? "kWh" : utility === "gas" ? "Smc" : "€";
 const hasFutures = utility === "energia" || utility === "gas";
 const isEG = hasFutures;
 const devices = isEG ? (utility === "energia" ? pods : pdrs) : [];
 const idKey = utility === "energia" ? "pod" : "pdr";
 const idLabel = utility === "energia" ? "POD" : "PDR";

 const [selectedDevice, setSelectedDevice] = useState("all");

 // Actual/consumo getters that respect device selection
 const getActual = (m, anno) => {
  if (!isEG || selectedDevice === "all") return getActualByUtilityMonth(utility, m, co, anno);
  return getActualByDevice(utility, selectedDevice, m, co, anno);
 };
 const getConsumo = (m, anno) => {
  if (!isEG || selectedDevice === "all") return getConsumoByUtilityMonth(utility, m, co, anno);
  return getConsumoByDevice(utility, selectedDevice, m, co, anno);
 };
 const getOneri = (m, anno) => {
  if (!isEG || selectedDevice === "all") return getAltriOneriByMonth(utility, m, co, anno);
  return getAltriOneriByDevice(utility, selectedDevice, m, co, anno);
 };

 const [budgetValues, setBudgetValues] = useState(() =>
 Array.from({ length: 12 }, (_, m) => {
 const actual = getActualByUtilityMonth(utility, m, co);
 return Math.round(actual * (0.92 + Math.random() * 0.16));
 })
 );

 // Reset budget when device changes
 useEffect(() => {
  setBudgetValues(Array.from({ length: 12 }, (_, m) => {
   const actual = getActual(m);
   return Math.round(actual * (0.95 + Math.random() * 0.10));
  }));
 }, [selectedDevice]);

 const [editingCell, setEditingCell] = useState(null);
 const [editValue, setEditValue] = useState("");

 const handleCellClick = (month, val) => { setEditingCell(month); setEditValue(String(val)); };
 const handleCellSave = () => {
 if (editingCell === null) return;
 setBudgetValues(prev => { const n = [...prev]; n[editingCell] = Math.round(parseFloat(editValue) || 0); return n; });
 setEditingCell(null);
 };
 const handleCellKeyDown = (e) => { if (e.key === "Enter") handleCellSave(); if (e.key === "Escape") setEditingCell(null); };

 const applyPct = (pct) => setBudgetValues(prev => prev.map(v => Math.round(v * (1 + pct / 100))));
 const copyActual = () => setBudgetValues(Array.from({ length: 12 }, (_, m) => Math.round(getActual(m))));

 const generateFromFutures = () => {
  if (!hasFutures) return;
  const futures = FUTURES_PRICES[utility];
  const newBudget = Array.from({ length: 12 }, (_, m) => {
   const consumo2025 = getConsumo(m, 2025);
   const prezzoPerUnit = futures.toUnit(futures.monthly[m]);
   const costoMateria = consumo2025 * prezzoPerUnit;
   const altriOneri2025 = getOneri(m, 2025);
   const consumoCorr2025 = getConsumo(m, 2025);
   const ratioOneri = consumoCorr2025 > 0 ? altriOneri2025 / consumoCorr2025 : 0;
   const costoOneri = consumo2025 * ratioOneri;
   return Math.round(costoMateria + costoOneri);
  });
  setBudgetValues(newBudget);
 };

 const comparison = budgetValues.map((b, m) => {
 const actual = +getActual(m).toFixed(0);
 const delta = actual - b;
 const pct = b > 0 ? +(delta / b * 100).toFixed(1) : 0;
 return { name: MONTHS[m], month: m, budget: b, actual, delta, pct };
 });

 const totB = comparison.reduce((s, d) => s + d.budget, 0);
 const totA = comparison.reduce((s, d) => s + d.actual, 0);
 const totD = totA - totB;
 const overMonths = comparison.filter(d => d.delta > 0).length;

 return (
 <div>
 <SectionTitle sub={`Definisci e monitora il budget mensile per ${meta.label}. Clicca sulle celle per modificare.`}>
 Budget — {meta.label}
 </SectionTitle>

 <div style={{
 background: `${meta.color}11`, borderRadius: 12, padding: "12px 16px",
 border: `1px solid ${meta.color}22`, fontSize: 12, color: C.textMuted, lineHeight: 1.6, marginBottom: 18,
 }}>
 <strong style={{ color: C.text }}>Clicca su qualsiasi importo del budget</strong> per modificarlo. Usa i pulsanti rapidi per copiare l'actual come base o applicare variazioni %.
 {hasFutures && <> Il pulsante <strong style={{ color: meta.color }}>Genera Budget 2026 da Futures</strong> calcola il budget usando i consumi 2025 e i prezzi futures 2026 ({utility === "energia" ? "EEX Italian Power" : "ICE Dutch TTF"}), poi puoi affinare i valori manualmente.</>}
 </div>

 {/* Device selector for E&G */}
 {isEG && devices.length > 0 && (
 <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 16, background: C.card, borderRadius: 10, padding: "10px 14px", border: `1px solid ${C.border}` }}>
 <span style={{ fontSize: 11, fontWeight: 700, color: C.text, whiteSpace: "nowrap" }}>Punto di fornitura:</span>
 <select value={selectedDevice} onChange={e => setSelectedDevice(e.target.value)}
  style={{ flex: 1, maxWidth: 420, padding: "6px 10px", borderRadius: 6, border: `1px solid ${meta.color}55`, background: selectedDevice !== "all" ? `${meta.color}08` : C.card, color: C.text, fontSize: 11, fontFamily: "inherit", cursor: "pointer" }}>
  <option value="all">Tutti i {idLabel} (aggregato)</option>
  {devices.map(d => <option key={d.id} value={d.id}>{d.id} — {d.city || d.site}</option>)}
 </select>
 {selectedDevice !== "all" && (
  <span style={{ fontSize: 10, color: meta.color, fontWeight: 600, padding: "3px 8px", borderRadius: 4, background: `${meta.color}15` }}>
   {idLabel}: {selectedDevice.slice(-6)}
  </span>
 )}
 </div>
 )}

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 20 }}>
 <KPICard label="Budget Annuale" value={fmtEuro(totB, 0)} color={meta.color} />
 <KPICard label="Actual" value={fmtEuro(totA, 0)} color={C.accent} />
 <KPICard label="Scostamento" value={`${totD > 0 ? "+" : ""}${fmtEuro(totD, 0)}`} color={totD > 0 ? C.danger : C.success} change={totB > 0 ? +(totD / totB * 100).toFixed(1) : 0} />
 <KPICard label="Mesi Sopra Budget" value={`${overMonths}/12`} color={overMonths > 6 ? C.danger : C.success} />
 </div>

 {/* Quick actions */}
 <div style={{ display: "flex", gap: 6, marginBottom: 14, flexWrap: "wrap" }}>
 {hasFutures && (
 <button onClick={generateFromFutures} style={{ padding: "6px 14px", borderRadius: 8, border: `1px solid ${meta.color}`, background: `${meta.color}15`, color: meta.color, fontSize: 11, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Genera Budget 2026 da Futures</button>
 )}
 <button onClick={copyActual} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.textMuted, fontSize: 11, cursor: "pointer", fontFamily: "inherit" }}>Copia da Actual</button>
 <button onClick={() => applyPct(5)} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.textMuted, fontSize: 11, cursor: "pointer", fontFamily: "inherit" }}>+5%</button>
 <button onClick={() => applyPct(-5)} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.textMuted, fontSize: 11, cursor: "pointer", fontFamily: "inherit" }}>−5%</button>
 <button onClick={() => applyPct(10)} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.textMuted, fontSize: 11, cursor: "pointer", fontFamily: "inherit" }}>+10%</button>
 <button onClick={() => applyPct(-10)} style={{ padding: "6px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.textMuted, fontSize: 11, cursor: "pointer", fontFamily: "inherit" }}>−10%</button>
 </div>

 {/* Chart */}
 <ChartCard title={`Budget vs Actual — ${meta.label}${selectedDevice !== "all" && isEG ? ` — ${selectedDevice}` : ""}`} style={{ marginBottom: 20 }}>
 <ResponsiveContainer width="100%" height={260}>
 <ComposedChart data={comparison}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${(v / 1000).toFixed(0)}k`} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v, 0)} />
 <Legend wrapperStyle={{ fontSize: 11 }} />
 <Bar dataKey="budget" fill={`${meta.color}55`} stroke={meta.color} strokeWidth={1} name="Budget" radius={[4, 4, 0, 0]} />
 <Bar dataKey="actual" fill={meta.color} name="Actual" radius={[4, 4, 0, 0]} />
 </ComposedChart>
 </ResponsiveContainer>
 </ChartCard>

 {/* Editable table */}
 <div style={{ overflowX: "auto" }}>
 <table style={{ width: "100%", borderCollapse: "separate", borderSpacing: 0, fontSize: 12 }}>
 <thead>
 <tr>
 <th style={{ padding: "8px 10px", textAlign: "left", color: C.textDim, fontWeight: 600, borderBottom: `1px solid ${C.border}`, position: "sticky", left: 0, background: C.bg, zIndex: 1 }}>Riga</th>
 {MONTHS.map(m => <th key={m} style={{ padding: "8px 4px", textAlign: "right", color: C.textDim, fontWeight: 600, borderBottom: `1px solid ${C.border}`, minWidth: 68 }}>{m}</th>)}
 <th style={{ padding: "8px 10px", textAlign: "right", color: C.text, fontWeight: 700, borderBottom: `1px solid ${C.border}` }}>TOTALE</th>
 </tr>
 </thead>
 <tbody>
 {/* Budget row — EDITABLE */}
 <tr>
 <td style={{ padding: "6px 10px", color: meta.color, fontWeight: 600, borderBottom: `1px solid ${C.border}11`, position: "sticky", left: 0, background: C.bg, zIndex: 1 }}> Budget</td>
 {comparison.map((d, i) => {
 const isEd = editingCell === i;
 return (
 <td key={i} onClick={() => !isEd && handleCellClick(i, d.budget)} style={{ padding: "4px 2px", textAlign: "right", borderBottom: `1px solid ${C.border}11`, cursor: "pointer", background: isEd ? `${meta.color}22` : "transparent" }}>
 {isEd ? (
 <input autoFocus value={editValue} onChange={e => setEditValue(e.target.value)} onBlur={handleCellSave} onKeyDown={handleCellKeyDown}
 style={{ width: 58, padding: "3px 5px", borderRadius: 4, border: `1px solid ${meta.color}`, background: `${meta.color}11`, color: C.text, fontSize: 11, textAlign: "right", fontFamily: "inherit", outline: "none" }} />
 ) : (
 <span style={{ color: meta.color, fontWeight: 500, padding: "2px 4px", borderRadius: 4 }}
 onMouseEnter={e => e.currentTarget.style.background = `${meta.color}15`}
 onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
 {fmtEuro(d.budget, 0)}
 </span>
 )}
 </td>
 );
 })}
 <td style={{ padding: "6px 10px", textAlign: "right", fontWeight: 700, color: meta.color, borderBottom: `1px solid ${C.border}11` }}>{fmtEuro(totB, 0)}</td>
 </tr>
 {/* Actual */}
 <tr>
 <td style={{ padding: "6px 10px", color: C.accent, fontWeight: 600, borderBottom: `1px solid ${C.border}11`, position: "sticky", left: 0, background: C.bg, zIndex: 1 }}> Actual</td>
 {comparison.map((d, i) => <td key={i} style={{ padding: "6px 2px", textAlign: "right", borderBottom: `1px solid ${C.border}11`, fontWeight: 500 }}>{fmtEuro(d.actual, 0)}</td>)}
 <td style={{ padding: "6px 10px", textAlign: "right", fontWeight: 700, color: C.accent, borderBottom: `1px solid ${C.border}11` }}>{fmtEuro(totA, 0)}</td>
 </tr>
 {/* Delta */}
 <tr>
 <td style={{ padding: "6px 10px", color: C.textDim, fontWeight: 600, position: "sticky", left: 0, background: C.bg, zIndex: 1 }}> Δ Scostam.</td>
 {comparison.map((d, i) => (
 <td key={i} style={{ padding: "4px 2px", textAlign: "right" }}>
 <span style={{ color: d.delta > 0 ? C.danger : d.delta < 0 ? C.success : C.textDim, fontWeight: 600, fontSize: 11 }}>{d.delta > 0 ? "+" : ""}{fmtEuro(d.delta, 0)}</span>
 <div style={{ fontSize: 9, color: d.delta > 0 ? C.danger : C.success, opacity: 0.8 }}>{d.pct > 0 ? "+" : ""}{d.pct}%</div>
 </td>
 ))}
 <td style={{ padding: "6px 10px", textAlign: "right" }}><span style={{ color: totD > 0 ? C.danger : C.success, fontWeight: 700 }}>{totD > 0 ? "+" : ""}{fmtEuro(totD, 0)}</span></td>
 </tr>
 </tbody>
 </table>
 </div>

 {/* Heatmap */}
 <div style={{ display: "grid", gridTemplateColumns: "repeat(12, 1fr)", gap: 5, marginTop: 18 }}>
 {comparison.map(d => {
 const i = Math.min(Math.abs(d.pct) / 15, 1);
 const over = d.delta > 0;
 return (
 <div key={d.name} style={{ background: over ? `rgba(239,68,68,${0.15 + i * 0.5})` : `rgba(16,185,129,${0.15 + i * 0.5})`, borderRadius: 8, padding: "8px 4px", textAlign: "center", border: `1px solid ${over ? C.danger + "33" : C.success + "33"}` }}>
 <div style={{ fontSize: 10, fontWeight: 700, color: C.text }}>{d.name}</div>
 <div style={{ fontSize: 16, fontWeight: 800, color: over ? C.danger : C.success }}>{d.pct > 0 ? "+" : ""}{d.pct}%</div>
 </div>
 );
 })}
 </div>
 </div>
 );
}

// ─── BUDGET OVERVIEW (all utilities consolidated) ────────────────────────────

function BudgetOverview() {
 const { co } = useCompanyFilter();
 const ALL_UTILS = [
  { key: "energia", label: "Energia Elettrica" },
  { key: "gas", label: "Gas Naturale" },
  { key: "mobile", label: "Telefonia Mobile" },
  { key: "fisso", label: "Telefonia Fissa" },
  { key: "connettivita", label: "Connettività" },
 ];

 // Generate stable budget values per utility (same logic as UtilityBudgetTab)
 const utilData = useMemo(() => {
  // Use a seeded-like approach: hash from utility key for consistency
  const seed = (s) => { let h = 0; for (let i = 0; i < s.length; i++) h = ((h << 5) - h) + s.charCodeAt(i); return Math.abs(h); };
  return ALL_UTILS.map(u => {
   const meta = UTILITY_META[u.key];
   const s = seed(u.key);
   const months = Array.from({ length: 12 }, (_, m) => {
    const actual = +getActualByUtilityMonth(u.key, m, co, 2025).toFixed(0);
    // Budget = actual * random factor (deterministic-ish per utility+month)
    const factor = 0.92 + ((s * (m + 1) * 7) % 100) / 625;
    const budget = Math.round(actual * factor);
    const delta = actual - budget;
    const pct = budget > 0 ? +(delta / budget * 100).toFixed(1) : 0;
    return { name: MONTHS[m], month: m, actual, budget, delta, pct };
   });
   const totBudget = months.reduce((s, d) => s + d.budget, 0);
   const totActual = months.reduce((s, d) => s + d.actual, 0);
   const totDelta = totActual - totBudget;
   const overMonths = months.filter(d => d.delta > 0).length;
   return { ...u, meta, months, totBudget, totActual, totDelta, overMonths };
  });
 }, [co]);

 const grandBudget = utilData.reduce((s, u) => s + u.totBudget, 0);
 const grandActual = utilData.reduce((s, u) => s + u.totActual, 0);
 const grandDelta = grandActual - grandBudget;
 const grandOverMonths = utilData.reduce((s, u) => s + u.overMonths, 0);

 // Monthly totals across all utilities
 const monthlyTotals = Array.from({ length: 12 }, (_, m) => {
  const budget = utilData.reduce((s, u) => s + u.months[m].budget, 0);
  const actual = utilData.reduce((s, u) => s + u.months[m].actual, 0);
  const delta = actual - budget;
  return { name: MONTHS[m], budget, actual, delta };
 });

 return (
  <div>
   <SectionTitle sub="Confronto budget vs consolidato 2025 per tutte le utility aziendali">
    Budget Complessivo — Panoramica 2025
   </SectionTitle>

   {/* Grand Total KPIs */}
   <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))", gap: 14, marginBottom: 24 }}>
    <KPICard label="Budget Totale" value={fmtEuro(grandBudget, 0)} color={C.accent} />
    <KPICard label="Consolidato Totale" value={fmtEuro(grandActual, 0)} color={C.text} />
    <KPICard label="Scostamento" value={`${grandDelta > 0 ? "+" : ""}${fmtEuro(grandDelta, 0)}`} color={grandDelta > 0 ? C.danger : C.success} change={grandBudget > 0 ? +(grandDelta / grandBudget * 100).toFixed(1) : 0} />
   </div>

   {/* Monthly chart all utilities */}
   <ChartCard title="Budget vs Consolidato — Totale Mensile" style={{ marginBottom: 24 }}>
    <ResponsiveContainer width="100%" height={280}>
     <ComposedChart data={monthlyTotals}>
      <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
      <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
      <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${(v / 1000).toFixed(0)}k`} />
      <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v, 0)} />
      <Legend wrapperStyle={{ fontSize: 11 }} />
      <Bar dataKey="budget" fill={`${C.accent}55`} stroke={C.accent} strokeWidth={1} name="Budget" radius={[4, 4, 0, 0]} />
      <Bar dataKey="actual" fill={C.accent} name="Consolidato" radius={[4, 4, 0, 0]} />
      <Line dataKey="delta" stroke={C.danger} strokeWidth={1.5} strokeDasharray="4 4" dot={{ r: 2 }} name="Scostamento" />
     </ComposedChart>
    </ResponsiveContainer>
   </ChartCard>

   {/* Per-utility cards */}
   <SectionTitle sub="Dettaglio per singola utility — budget, consolidato, scostamento">Confronto per Utility</SectionTitle>
   <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(320px, 1fr))", gap: 16, marginBottom: 24 }}>
    {utilData.map(u => {
     const pct = u.totBudget > 0 ? (u.totDelta / u.totBudget * 100) : 0;
     const over = u.totDelta > 0;
     return (
      <div key={u.key} style={{ background: C.card, borderRadius: 12, border: `1px solid ${C.border}`, overflow: "hidden" }}>
       <div style={{ padding: "12px 16px", background: `${u.meta.color}11`, borderBottom: `1px solid ${C.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <span style={{ fontWeight: 700, fontSize: 13, color: u.meta.color }}>{u.label}</span>
        <span style={{ fontSize: 12, fontWeight: 700, color: over ? C.danger : C.success, background: over ? `${C.danger}15` : `${C.success}15`, padding: "2px 8px", borderRadius: 4 }}>
         {pct > 0 ? "+" : ""}{pct.toFixed(1)}%
        </span>
       </div>
       <div style={{ padding: 16 }}>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10, marginBottom: 12 }}>
         <div style={{ textAlign: "center" }}>
          <div style={{ fontSize: 9, color: C.textDim, fontWeight: 600, textTransform: "uppercase" }}>Budget</div>
          <div style={{ fontSize: 16, fontWeight: 800, color: u.meta.color }}>{fmtEuro(u.totBudget, 0)}</div>
         </div>
         <div style={{ textAlign: "center" }}>
          <div style={{ fontSize: 9, color: C.textDim, fontWeight: 600, textTransform: "uppercase" }}>Consolidato</div>
          <div style={{ fontSize: 16, fontWeight: 800, color: C.text }}>{fmtEuro(u.totActual, 0)}</div>
         </div>
         <div style={{ textAlign: "center" }}>
          <div style={{ fontSize: 9, color: C.textDim, fontWeight: 600, textTransform: "uppercase" }}>Scostamento</div>
          <div style={{ fontSize: 16, fontWeight: 800, color: over ? C.danger : C.success }}>{u.totDelta > 0 ? "+" : ""}{fmtEuro(u.totDelta, 0)}</div>
         </div>
        </div>
        {/* Mini sparkline bar */}
        <div style={{ display: "grid", gridTemplateColumns: "repeat(12, 1fr)", gap: 2, marginTop: 4 }}>
         {u.months.map(d => {
          const mo = d.delta > 0;
          const intensity = Math.min(Math.abs(d.pct) / 20, 1);
          return (
           <div key={d.name} title={`${d.name}: Budget ${fmtEuro(d.budget, 0)} / Actual ${fmtEuro(d.actual, 0)} / Δ ${d.delta > 0 ? "+" : ""}${fmtEuro(d.delta, 0)} (${d.pct > 0 ? "+" : ""}${d.pct}%)`}
            style={{ height: 20, borderRadius: 3, background: mo ? `rgba(239,68,68,${0.2 + intensity * 0.6})` : `rgba(16,185,129,${0.2 + intensity * 0.6})`, display: "flex", alignItems: "center", justifyContent: "center" }}>
            <span style={{ fontSize: 7, fontWeight: 700, color: mo ? "#b91c1c" : "#065f46" }}>{d.name.charAt(0)}</span>
           </div>
          );
         })}
        </div>
        <div style={{ display: "flex", justifyContent: "space-between", marginTop: 6, fontSize: 9, color: C.textDim }}>
         <span>Mesi sopra budget: <strong style={{ color: u.overMonths > 6 ? C.danger : C.success }}>{u.overMonths}/12</strong></span>
         <span>Media scost.: <strong style={{ color: over ? C.danger : C.success }}>{pct > 0 ? "+" : ""}{pct.toFixed(1)}%</strong></span>
        </div>
       </div>
      </div>
     );
    })}
   </div>

   {/* Summary table */}
   <SectionTitle sub="Riepilogo annuale per utility">Tabella Riassuntiva</SectionTitle>
   <DataTable
    columns={[
     { key: "label", label: "Utility", render: (v, row) => <span style={{ fontWeight: 600, color: row.meta.color }}>{v}</span> },
     { key: "totBudget", label: "Budget €", align: "right", render: v => fmtEuro(v, 0) },
     { key: "totActual", label: "Consolidato €", align: "right", render: v => <strong>{fmtEuro(v, 0)}</strong> },
     { key: "totDelta", label: "Scostamento €", align: "right", render: v => <span style={{ color: v > 0 ? C.danger : C.success, fontWeight: 600 }}>{v > 0 ? "+" : ""}{fmtEuro(v, 0)}</span> },
     { key: "pct", label: "Δ %", align: "right", render: (_, row) => { const p = row.totBudget > 0 ? (row.totDelta / row.totBudget * 100) : 0; return <span style={{ color: p > 0 ? C.danger : C.success, fontWeight: 700 }}>{p > 0 ? "+" : ""}{p.toLocaleString("it-IT", {minimumFractionDigits:1, maximumFractionDigits:1})}%</span>; }},
     { key: "overMonths", label: "Mesi Sopra", align: "center", render: v => <span style={{ color: v > 6 ? C.danger : C.success, fontWeight: 600 }}>{v}/12</span> },
     { key: "weight", label: "Peso %", align: "right", render: (_, row) => <span style={{ color: C.textMuted }}>{grandBudget > 0 ? (row.totBudget / grandBudget * 100).toFixed(1) : 0}%</span> },
    ]}
    data={utilData}
    maxHeight={300}
   />

   {/* Monthly detail table */}
   <SectionTitle sub="Scostamento mensile complessivo" style={{ marginTop: 24 }}>Dettaglio Mensile Aggregato</SectionTitle>
   <div style={{ overflowX: "auto" }}>
    <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11 }}>
     <thead>
      <tr>
       <th style={{ padding: "8px 10px", textAlign: "left", color: C.textDim, fontWeight: 600, borderBottom: `2px solid ${C.border}` }}>Utility</th>
       {MONTHS.map(m => <th key={m} style={{ padding: "6px 3px", textAlign: "right", color: C.textDim, fontWeight: 600, borderBottom: `2px solid ${C.border}`, fontSize: 10 }}>{m}</th>)}
       <th style={{ padding: "8px 6px", textAlign: "right", color: C.text, fontWeight: 700, borderBottom: `2px solid ${C.border}` }}>TOT</th>
      </tr>
     </thead>
     <tbody>
      {utilData.map(u => (
       <tr key={u.key}>
        <td style={{ padding: "5px 10px", fontWeight: 600, color: u.meta.color, borderBottom: `1px solid ${C.border}11`, whiteSpace: "nowrap", fontSize: 10 }}>{u.label}</td>
        {u.months.map((d, i) => (
         <td key={i} style={{ padding: "4px 2px", textAlign: "right", borderBottom: `1px solid ${C.border}11` }}>
          <span style={{ fontSize: 10, fontWeight: 600, color: d.delta > 0 ? C.danger : d.delta < 0 ? C.success : C.textDim }}>{d.delta > 0 ? "+" : ""}{fmtEuro(d.delta, 0)}</span>
         </td>
        ))}
        <td style={{ padding: "5px 6px", textAlign: "right", fontWeight: 700, color: u.totDelta > 0 ? C.danger : C.success, borderBottom: `1px solid ${C.border}11` }}>{u.totDelta > 0 ? "+" : ""}{fmtEuro(u.totDelta, 0)}</td>
       </tr>
      ))}
      <tr style={{ background: `${C.accent}08` }}>
       <td style={{ padding: "6px 10px", fontWeight: 700, color: C.text, borderTop: `2px solid ${C.border}` }}>TOTALE</td>
       {monthlyTotals.map((d, i) => (
        <td key={i} style={{ padding: "5px 2px", textAlign: "right", fontWeight: 700, color: d.delta > 0 ? C.danger : C.success, borderTop: `2px solid ${C.border}`, fontSize: 10 }}>{d.delta > 0 ? "+" : ""}{fmtEuro(d.delta, 0)}</td>
       ))}
       <td style={{ padding: "6px 6px", textAlign: "right", fontWeight: 800, color: grandDelta > 0 ? C.danger : C.success, borderTop: `2px solid ${C.border}` }}>{grandDelta > 0 ? "+" : ""}{fmtEuro(grandDelta, 0)}</td>
      </tr>
     </tbody>
    </table>
   </div>
  </div>
 );
}

// ─── FORECAST SECTION (solo Energia e Gas) ────────────────────────────────────

// Simulated market futures prices (demo data from ICE TTF and EEX Italian Power)
const FUTURES_PRICES = {
 energia: { // EEX Italian Power Futures 2026 — €/MWh → converted to €/kWh
 label: "EEX Italian Power Futures 2026",
 source: "https://www.eex.com/en/market-data/market-data-hub",
 unit: "€/MWh",
 unitConv: "€/kWh",
 // Monthly forward prices 2026 (demo) — €/MWh — leggero calo rispetto al 2025
 monthly: [118.5, 112.3, 105.6, 98.4, 91.2, 85.8, 88.3, 95.1, 101.7, 108.9, 121.4, 128.7],
 toUnit: (mwh) => mwh / 1000, // €/MWh → €/kWh
 },
 gas: { // ICE Dutch TTF Gas Futures 2026 — €/MWh → converted to €/Smc
 label: "ICE Dutch TTF Gas Futures 2026",
 source: "https://www.ice.com/products/27996665/Dutch-TTF-Gas-Futures/data?marketId=5336900",
 unit: "€/MWh",
 unitConv: "€/Smc",
 // Monthly forward prices 2026 (demo) — €/MWh — in leggera discesa
 monthly: [39.8, 37.1, 33.5, 30.2, 27.8, 26.3, 27.1, 29.0, 32.4, 36.1, 41.5, 45.2],
 toUnit: (mwh) => mwh * 0.0036 * 38.1 / 1000 * 10.5, // approx €/MWh → €/Smc
 },
};

function ForecastDashboard() {
 const { co } = useCompanyFilter();
 const [activeUtility, setActiveUtility] = useState("energia");
 const [forecastTab, setForecastTab] = useState("forecast");
 const [savedScenarios, setSavedScenarios] = useState([]);

 const handleSaveScenario = (scenario) => {
  setSavedScenarios(prev => [{ ...scenario, id: Date.now(), date: new Date().toLocaleString("it-IT", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" }) }, ...prev]);
 };

 const handleDeleteScenario = (id) => {
  setSavedScenarios(prev => prev.filter(s => s.id !== id));
 };

 return (
 <div>
 <SectionTitle sub="Previsione dei costi basata su consumi storici e prezzi dei mercati all'ingrosso">
 Forecast Energia e Gas — Proiezione 2026
 </SectionTitle>

 <TabBar tabs={[
  { key: "forecast", label: "Forecast Base" },
  { key: "scenari", label: "Scenari What-If" },
  { key: "storico", label: `Storico Scenari (${savedScenarios.length})` },
 ]} active={forecastTab} onChange={setForecastTab} style={{ marginBottom: 20 }} />

 {forecastTab === "forecast" && <>
 {/* Educational section about markets */}
 <div style={{ background: C.card, borderRadius: 14, padding: 20, border: `1px solid ${C.border}`, marginBottom: 24 }}>
 <div style={{ fontSize: 15, fontWeight: 700, color: C.text, marginBottom: 12 }}> Come funzionano i Mercati Energetici all'Ingrosso</div>
 <div style={{ fontSize: 12, color: C.textMuted, lineHeight: 1.8 }}>
 <p style={{ margin: "0 0 10px" }}>I prezzi dell'energia e del gas che le aziende pagano in bolletta sono fortemente influenzati dai <strong style={{ color: C.energy }}>mercati all'ingrosso</strong>, dove i produttori e i trader negoziano i volumi di energia e gas attraverso contratti futures.</p>

 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 12 }}>
 <div style={{ background: `${C.energy}11`, borderRadius: 10, padding: 14, border: `1px solid ${C.energy}22` }}>
 <div style={{ fontWeight: 700, color: C.energy, marginBottom: 6 }}> EEX Italian Power Futures</div>
 <div style={{ fontSize: 11, lineHeight: 1.7 }}>
 La borsa <strong>EEX</strong> (European Energy Exchange) è il principale mercato europeo per i futures sull'energia elettrica. I <strong>Italian Power Futures</strong> riflettono il prezzo atteso dell'elettricità in Italia per i mesi futuri. Sono quotati in <strong>€/MWh</strong> e rappresentano il riferimento per i contratti di fornitura a prezzo variabile. Il <strong>PUN</strong> (Prezzo Unico Nazionale) è il prezzo spot di riferimento per l'Italia.
 </div>
 <div style={{ marginTop: 8, fontSize: 10, color: C.textDim }}>
 <a href="https://www.eex.com/en/market-data/market-data-hub" target="_blank" rel="noopener" style={{ color: C.accentLight }}>eex.com — Italian Power Futures</a>
 </div>
 </div>

 <div style={{ background: `${C.gas}11`, borderRadius: 10, padding: 14, border: `1px solid ${C.gas}22` }}>
 <div style={{ fontWeight: 700, color: C.gas, marginBottom: 6 }}> ICE Dutch TTF Gas Futures</div>
 <div style={{ fontSize: 11, lineHeight: 1.7 }}>
 Il <strong>TTF</strong> (Title Transfer Facility) è l'hub virtuale olandese che funge da benchmark per il prezzo del gas naturale in Europa. Negoziato sulla borsa <strong>ICE</strong> (Intercontinental Exchange), il TTF Futures è quotato in <strong>€/MWh</strong> e viene convertito in <strong>€/Smc</strong> tramite il PCS (Potere Calorifico Superiore). È il riferimento per la componente materia prima nelle bollette gas.
 </div>
 <div style={{ marginTop: 8, fontSize: 10, color: C.textDim }}>
 <a href="https://www.ice.com/products/27996665/Dutch-TTF-Gas-Futures/data?marketId=5336900" target="_blank" rel="noopener" style={{ color: C.accentLight }}>ice.com — Dutch TTF Gas Futures</a>
 </div>
 </div>
 </div>

 <div style={{ background: `${C.accent}11`, borderRadius: 10, padding: 14, border: `1px solid ${C.accent}22` }}>
 <div style={{ fontWeight: 700, color: C.accent, marginBottom: 8 }}> Metodologia di Calcolo del Forecast</div>
 <div style={{ fontSize: 11, lineHeight: 1.8 }}>
 Il forecast della spesa futura si calcola per ogni mese con la seguente formula:<br/><br/>
 <div style={{ background: "#e9ecf1", borderRadius: 8, padding: "12px 16px", fontFamily: "monospace", fontSize: 12, color: C.text, border: `1px solid ${C.border}`, marginBottom: 10 }}>
 <strong style={{ color: C.energy }}>Costo Materia Prima</strong> = Consumi<sub>mese/anno prec.</sub> × Prezzo Futures<sub>mese</sub><br/>
 <strong style={{ color: C.warn }}>Costo Altri Oneri</strong> = (Altri Oneri<sub>mese prec.</sub> / Consumi<sub>mese prec.</sub>) × Consumi<sub>mese/anno prec.</sub><br/>
 <strong style={{ color: C.accentLight }}>Forecast Totale</strong> = Costo Materia Prima + Costo Altri Oneri
 </div>
 Dove:<br/>
 • <strong>Consumi mese/anno precedente</strong>: i kWh o Smc effettivamente consumati nello stesso mese dell'anno precedente (stagionalità)<br/>
 • <strong>Prezzo Futures</strong>: il prezzo forward dal mercato all'ingrosso (EEX per energia, TTF per gas) per quel mese<br/>
 • <strong>Altri Oneri</strong>: tutte le componenti di costo diverse dalla materia prima (dispacciamento, distribuzione, oneri di sistema, trasporto, accise, imposte). Si calcola il rapporto €/unità del mese di riferimento e si moltiplica per i consumi previsti.<br/>
 • Il coefficiente "altri oneri per unità" (es. €0,090/kWh) viene calcolato come: <code style={{ background: "#e9ecf1", padding: "2px 6px", borderRadius: 4 }}>Σ(costi non-materia-prima) / Σ(consumi)</code> del mese corrispondente del 2025.
 </div>
 </div>
 </div>
 </div>

 {/* Utility toggle */}
 <div style={{ display: "flex", gap: 6, marginBottom: 20 }}>
 {["energia", "gas"].map(u => {
 const um = UTILITY_META[u];
 return (
 <button key={u} onClick={() => setActiveUtility(u)} style={{
 padding: "9px 20px", borderRadius: 10, border: `1px solid ${activeUtility === u ? um.color : C.border}`,
 background: activeUtility === u ? `${um.color}22` : "transparent",
 color: activeUtility === u ? um.color : C.textMuted,
 fontSize: 13, fontWeight: 700, cursor: "pointer", fontFamily: "inherit", transition: "all 0.15s",
 }}>{um.label}</button>
 );
 })}
 </div>

 <ForecastUtilityDetail utility={activeUtility} />
 </>}

 {forecastTab === "scenari" && <ScenarioBuilder onSave={handleSaveScenario} />}

 {forecastTab === "storico" && <ScenarioHistory scenarios={savedScenarios} onDelete={handleDeleteScenario} onLoad={(s) => { setForecastTab("scenari"); }} />}
 </div>
 );
}

function ScenarioBuilder({ onSave }) {
 const { co } = useCompanyFilter();
 const [utility, setUtility] = useState("energia");
 const meta = UTILITY_META[utility];
 const futures = FUTURES_PRICES[utility];
 const unit = utility === "energia" ? "kWh" : "Smc";

 // Editable scenario parameters
 const [scenarioName, setScenarioName] = useState("Scenario personalizzato");
 const [priceAdj, setPriceAdj] = useState(0); // % adjustment on futures prices
 const [consumoAdj, setConsumoAdj] = useState(0); // % adjustment on consumption
 const [oneriAdj, setOneriAdj] = useState(0); // % adjustment on altri oneri coeff
 const [customPrices, setCustomPrices] = useState([...futures.monthly]);
 const [customConsumi, setCustomConsumi] = useState(() =>
  Array.from({ length: 12 }, (_, m) => Math.round(getConsumoByUtilityMonth(utility, m, co, 2025)))
 );
 const [saved, setSaved] = useState(false);

 // Reset when utility changes
 useEffect(() => {
  const f = FUTURES_PRICES[utility];
  setCustomPrices([...f.monthly]);
  setCustomConsumi(Array.from({ length: 12 }, (_, m) => Math.round(getConsumoByUtilityMonth(utility, m, co, 2025))));
  setPriceAdj(0); setConsumoAdj(0); setOneriAdj(0);
 }, [utility, co]);

 // Apply % adjustments
 const applyPriceAdj = () => {
  const f = FUTURES_PRICES[utility];
  setCustomPrices(f.monthly.map(p => +(p * (1 + priceAdj / 100)).toFixed(1)));
 };
 const applyConsumoAdj = () => {
  setCustomConsumi(Array.from({ length: 12 }, (_, m) => {
   const base = getConsumoByUtilityMonth(utility, m, co, 2025);
   return Math.round(base * (1 + consumoAdj / 100));
  }));
 };

 // Calculate scenario
 const scenarioMonths = useMemo(() => {
  const f = FUTURES_PRICES[utility];
  return Array.from({ length: 12 }, (_, m) => {
   const consumo = customConsumi[m];
   const prezzo = f.toUnit(customPrices[m]);
   const costoMateria = consumo * prezzo;
   const altriOneri2025 = getAltriOneriByMonth(utility, m, co, 2025);
   const consumo2025 = getConsumoByUtilityMonth(utility, m, co, 2025);
   const ratioOneri = consumo2025 > 0 ? altriOneri2025 / consumo2025 : 0;
   const ratioAdj = ratioOneri * (1 + oneriAdj / 100);
   const costoOneri = consumo * ratioAdj;
   const totale = costoMateria + costoOneri;
   // Base forecast (no adjustments)
   const baseConsumo = getConsumoByUtilityMonth(utility, m, co, 2025);
   const basePrezzo = f.toUnit(f.monthly[m]);
   const baseMateria = baseConsumo * basePrezzo;
   const baseOneri = baseConsumo * ratioOneri;
   const baseTotale = baseMateria + baseOneri;
   const actual2025 = getActualByUtilityMonth(utility, m, co, 2025);
   return {
    name: MONTHS[m], month: m, consumo, prezzo: customPrices[m],
    costoMateria: +costoMateria.toFixed(0), costoOneri: +costoOneri.toFixed(0),
    scenario: +totale.toFixed(0), base: +baseTotale.toFixed(0), actual2025: +actual2025.toFixed(0),
    delta: +(totale - baseTotale).toFixed(0),
   };
  });
 }, [utility, co, customPrices, customConsumi, oneriAdj]);

 const totScenario = scenarioMonths.reduce((s, d) => s + d.scenario, 0);
 const totBase = scenarioMonths.reduce((s, d) => s + d.base, 0);
 const totActual = scenarioMonths.reduce((s, d) => s + d.actual2025, 0);
 const deltaVsBase = totScenario - totBase;
 const deltaVsActual = totScenario - totActual;

 const inputStyle = { padding: "6px 10px", borderRadius: 5, border: `1px solid ${C.border}`, fontSize: 12, fontFamily: "inherit", color: C.text, width: 70, textAlign: "right" };

 return (
  <div>
   <SectionTitle sub="Modifica prezzi, consumi e oneri per simulare scenari alternativi">Scenari What-If — Simulatore Forecast 2026</SectionTitle>

   {/* Utility selector */}
   <div style={{ display: "flex", gap: 6, marginBottom: 20 }}>
    {["energia", "gas"].map(u => {
     const um = UTILITY_META[u];
     return (
      <button key={u} onClick={() => setUtility(u)} style={{
       padding: "9px 20px", borderRadius: 10, border: `1px solid ${utility === u ? um.color : C.border}`,
       background: utility === u ? `${um.color}22` : "transparent",
       color: utility === u ? um.color : C.textMuted,
       fontSize: 13, fontWeight: 700, cursor: "pointer", fontFamily: "inherit",
      }}>{um.label}</button>
     );
    })}
   </div>

   {/* Scenario name + save */}
   <div style={{ display: "flex", gap: 10, alignItems: "center", marginBottom: 18, background: C.card, borderRadius: 10, padding: "10px 16px", border: `1px solid ${C.border}` }}>
    <span style={{ fontSize: 11, fontWeight: 700, color: C.text, whiteSpace: "nowrap" }}>Nome scenario:</span>
    <input value={scenarioName} onChange={e => { setScenarioName(e.target.value); setSaved(false); }}
     style={{ flex: 1, padding: "7px 12px", borderRadius: 6, border: `1px solid ${C.border}`, fontSize: 12, fontFamily: "inherit", color: C.text, maxWidth: 350 }} />
    <button onClick={() => {
     if (!scenarioName.trim()) return;
     onSave && onSave({
      name: scenarioName, utility, priceAdj, consumoAdj, oneriAdj,
      totScenario: scenarioMonths.reduce((s, d) => s + d.scenario, 0),
      totBase: scenarioMonths.reduce((s, d) => s + d.base, 0),
      delta: scenarioMonths.reduce((s, d) => s + d.scenario, 0) - scenarioMonths.reduce((s, d) => s + d.base, 0),
      customPrices: [...customPrices], customConsumi: [...customConsumi],
      months: scenarioMonths.map(d => ({ name: d.name, scenario: d.scenario, base: d.base, costoMateria: d.costoMateria, costoOneri: d.costoOneri, consumo: d.consumo, prezzo: d.prezzo, actual2025: d.actual2025 })),
     });
     setSaved(true);
     setTimeout(() => setSaved(false), 3000);
    }} style={{
     padding: "8px 20px", borderRadius: 8, border: "none", cursor: "pointer", fontFamily: "inherit",
     background: saved ? C.success : `linear-gradient(135deg, ${C.accent}, #224abe)`,
     color: "#fff", fontSize: 12, fontWeight: 700, boxShadow: "0 2px 6px rgba(78,115,223,0.3)", transition: "all 0.2s",
    }}>
     {saved ? "Salvato" : "Salva Scenario"}
    </button>
   </div>

   {/* Quick adjustments */}
   <div style={{ background: C.card, borderRadius: 12, padding: 20, border: `1px solid ${C.border}`, marginBottom: 20 }}>
    <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 14 }}>Regolazioni Rapide (%)</div>
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 16 }}>
     <div>
      <div style={{ fontSize: 11, fontWeight: 600, color: meta.color, marginBottom: 6 }}>Prezzi Futures</div>
      <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
       <input type="range" min={-50} max={50} value={priceAdj} onChange={e => setPriceAdj(+e.target.value)} style={{ flex: 1 }} />
       <span style={{ fontSize: 13, fontWeight: 700, color: priceAdj > 0 ? C.danger : priceAdj < 0 ? C.success : C.text, minWidth: 50 }}>{priceAdj > 0 ? "+" : ""}{priceAdj}%</span>
       <button onClick={applyPriceAdj} style={{ padding: "4px 10px", borderRadius: 4, border: `1px solid ${meta.color}`, background: `${meta.color}15`, color: meta.color, fontSize: 10, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Applica</button>
      </div>
      <div style={{ fontSize: 10, color: C.textDim, marginTop: 4 }}>Variazione % sui prezzi futures base</div>
     </div>
     <div>
      <div style={{ fontSize: 11, fontWeight: 600, color: C.accent, marginBottom: 6 }}>Consumi Previsti</div>
      <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
       <input type="range" min={-50} max={50} value={consumoAdj} onChange={e => setConsumoAdj(+e.target.value)} style={{ flex: 1 }} />
       <span style={{ fontSize: 13, fontWeight: 700, color: consumoAdj > 0 ? C.danger : consumoAdj < 0 ? C.success : C.text, minWidth: 50 }}>{consumoAdj > 0 ? "+" : ""}{consumoAdj}%</span>
       <button onClick={applyConsumoAdj} style={{ padding: "4px 10px", borderRadius: 4, border: `1px solid ${C.accent}`, background: `${C.accent}15`, color: C.accent, fontSize: 10, fontWeight: 700, cursor: "pointer", fontFamily: "inherit" }}>Applica</button>
      </div>
      <div style={{ fontSize: 10, color: C.textDim, marginTop: 4 }}>Variazione % sui consumi 2025 come base</div>
     </div>
     <div>
      <div style={{ fontSize: 11, fontWeight: 600, color: C.warn, marginBottom: 6 }}>Coefficiente Oneri</div>
      <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
       <input type="range" min={-50} max={50} value={oneriAdj} onChange={e => setOneriAdj(+e.target.value)} style={{ flex: 1 }} />
       <span style={{ fontSize: 13, fontWeight: 700, color: oneriAdj > 0 ? C.danger : oneriAdj < 0 ? C.success : C.text, minWidth: 50 }}>{oneriAdj > 0 ? "+" : ""}{oneriAdj}%</span>
      </div>
      <div style={{ fontSize: 10, color: C.textDim, marginTop: 4 }}>Variazione % sugli oneri di sistema (real-time)</div>
     </div>
    </div>
   </div>

   {/* Editable monthly prices & consumi */}
   <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 20 }}>
    <div style={{ background: C.card, borderRadius: 12, padding: 16, border: `1px solid ${C.border}` }}>
     <div style={{ fontSize: 13, fontWeight: 700, color: meta.color, marginBottom: 10 }}>Prezzi Futures Scenario ({futures.unit})</div>
     <div style={{ display: "grid", gridTemplateColumns: "repeat(6, 1fr)", gap: 6 }}>
      {customPrices.map((p, i) => (
       <div key={i} style={{ textAlign: "center" }}>
        <div style={{ fontSize: 9, color: C.textDim, fontWeight: 600, marginBottom: 2 }}>{MONTHS[i]}</div>
        <input value={p} onChange={e => { const v = [...customPrices]; v[i] = parseFloat(e.target.value) || 0; setCustomPrices(v); }}
         style={{ ...inputStyle, width: "100%", textAlign: "center", borderColor: p !== futures.monthly[i] ? meta.color : C.border, fontWeight: p !== futures.monthly[i] ? 700 : 400, color: p !== futures.monthly[i] ? meta.color : C.text }} />
        <div style={{ fontSize: 8, color: C.textDim }}>base: {futures.monthly[i]}</div>
       </div>
      ))}
     </div>
    </div>
    <div style={{ background: C.card, borderRadius: 12, padding: 16, border: `1px solid ${C.border}` }}>
     <div style={{ fontSize: 13, fontWeight: 700, color: C.accent, marginBottom: 10 }}>Consumi Scenario ({unit})</div>
     <div style={{ display: "grid", gridTemplateColumns: "repeat(6, 1fr)", gap: 6 }}>
      {customConsumi.map((c, i) => {
       const base = Math.round(getConsumoByUtilityMonth(utility, i, co, 2025));
       return (
        <div key={i} style={{ textAlign: "center" }}>
         <div style={{ fontSize: 9, color: C.textDim, fontWeight: 600, marginBottom: 2 }}>{MONTHS[i]}</div>
         <input value={c} onChange={e => { const v = [...customConsumi]; v[i] = parseInt(e.target.value) || 0; setCustomConsumi(v); }}
          style={{ ...inputStyle, width: "100%", textAlign: "center", borderColor: c !== base ? C.accent : C.border, fontWeight: c !== base ? 700 : 400, color: c !== base ? C.accent : C.text }} />
         <div style={{ fontSize: 8, color: C.textDim }}>base: {fmt(base)}</div>
        </div>
       );
      })}
     </div>
    </div>
   </div>

   {/* Scenario KPIs */}
   <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 20 }}>
    <KPICard label="Scenario 2026" value={fmtEuro(totScenario, 0)} color={meta.color} />
    <KPICard label="Forecast Base 2026" value={fmtEuro(totBase, 0)} color={C.textMuted} />
    <KPICard label="Delta vs Base" value={`${deltaVsBase > 0 ? "+" : ""}${fmtEuro(deltaVsBase, 0)}`} color={deltaVsBase > 0 ? C.danger : C.success} change={totBase > 0 ? +(deltaVsBase / totBase * 100).toFixed(1) : 0} />
    <KPICard label="Actual 2025" value={fmtEuro(totActual, 0)} color={C.success} />
    <KPICard label="Delta vs 2025" value={`${deltaVsActual > 0 ? "+" : ""}${fmtEuro(deltaVsActual, 0)}`} color={deltaVsActual > 0 ? C.danger : C.success} change={totActual > 0 ? +(deltaVsActual / totActual * 100).toFixed(1) : 0} />
   </div>

   {/* Scenario chart */}
   <ChartCard title={`Scenario vs Base vs Actual 2025 — ${meta.label}`} style={{ marginBottom: 20 }}>
    <ResponsiveContainer width="100%" height={300}>
     <ComposedChart data={scenarioMonths}>
      <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
      <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
      <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${(v / 1000).toFixed(0)}k`} />
      <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v, 0)} />
      <Legend wrapperStyle={{ fontSize: 11 }} />
      <Bar dataKey="scenario" fill={meta.color} name="Scenario" radius={[4, 4, 0, 0]} />
      <Line dataKey="base" stroke={C.textMuted} strokeWidth={2} strokeDasharray="5 5" dot={{ r: 2, fill: C.textMuted }} name="Forecast Base" />
      <Line dataKey="actual2025" stroke={C.success} strokeWidth={2} dot={{ r: 2, fill: C.success }} name="Actual 2025" />
     </ComposedChart>
    </ResponsiveContainer>
   </ChartCard>

   {/* Detail table */}
   <SectionTitle sub="Dettaglio calcoli scenario per mese">Tabella Scenario Dettagliata</SectionTitle>
   <DataTable
    columns={[
     { key: "name", label: "Mese 2026" },
     { key: "consumo", label: `Consumi (${unit})`, align: "right", render: v => fmt(v) },
     { key: "prezzo", label: `Prezzo (${futures.unit})`, align: "right", render: v => `€${v.toLocaleString("it-IT", {minimumFractionDigits:1, maximumFractionDigits:1})}` },
     { key: "costoMateria", label: "Materia Prima €", align: "right", render: v => fmtEuro(v, 0) },
     { key: "costoOneri", label: "Altri Oneri €", align: "right", render: v => fmtEuro(v, 0) },
     { key: "scenario", label: "Scenario €", align: "right", render: v => <strong style={{ color: meta.color }}>{fmtEuro(v, 0)}</strong> },
     { key: "base", label: "Base €", align: "right", render: v => <span style={{ color: C.textMuted }}>{fmtEuro(v, 0)}</span> },
     { key: "delta", label: "Delta €", align: "right", render: v => <span style={{ color: v > 0 ? C.danger : v < 0 ? C.success : C.text, fontWeight: 600 }}>{v > 0 ? "+" : ""}{fmtEuro(v, 0)}</span> },
    ]}
    data={scenarioMonths}
    maxHeight={400}
   />
  </div>
 );
}

function ScenarioHistory({ scenarios, onDelete, onLoad }) {
 const [expandedId, setExpandedId] = useState(null);
 const [filterUtility, setFilterUtility] = useState("all");

 const filtered = filterUtility === "all" ? scenarios : scenarios.filter(s => s.utility === filterUtility);
 const energyCount = scenarios.filter(s => s.utility === "energia").length;
 const gasCount = scenarios.filter(s => s.utility === "gas").length;

 return (
  <div>
   <SectionTitle sub={`${scenarios.length} scenari salvati — seleziona per consultare i dettagli`}>Storico Scenari What-If</SectionTitle>

   {/* KPI row */}
   <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(160px, 1fr))", gap: 12, marginBottom: 18 }}>
    <KPICard label="Scenari Totali" value={scenarios.length} color={C.accent} />
    <KPICard label="Energia" value={energyCount} color={C.energy} />
    <KPICard label="Gas" value={gasCount} color={C.gas} />
   </div>

   {/* Filter */}
   <div style={{ display: "flex", gap: 4, marginBottom: 16 }}>
    {[{ k: "all", l: "Tutti" }, { k: "energia", l: "Energia" }, { k: "gas", l: "Gas" }].map(f => (
     <button key={f.k} onClick={() => setFilterUtility(f.k)} style={{
      padding: "6px 14px", borderRadius: 6, border: `1px solid ${filterUtility === f.k ? C.accent : C.border}`,
      background: filterUtility === f.k ? C.accent : C.card, color: filterUtility === f.k ? "#fff" : C.textMuted,
      fontSize: 11, fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
     }}>{f.l} {f.k !== "all" ? `(${scenarios.filter(s => s.utility === f.k).length})` : ""}</button>
    ))}
   </div>

   {filtered.length === 0 && (
    <div style={{ textAlign: "center", padding: 40, color: C.textDim, fontSize: 13 }}>
     Nessuno scenario salvato{filterUtility !== "all" ? ` per ${UTILITY_META[filterUtility]?.label}` : ""}. Vai alla tab "Scenari What-If" per crearne uno.
    </div>
   )}

   {/* Scenario cards */}
   <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
    {filtered.map(s => {
     const meta = UTILITY_META[s.utility];
     const isExpanded = expandedId === s.id;
     const deltaPct = s.totBase > 0 ? +(s.delta / s.totBase * 100).toFixed(1) : 0;
     return (
      <div key={s.id} style={{
       background: C.card, borderRadius: 12, border: `1px solid ${isExpanded ? meta.color : C.border}`,
       borderLeft: `4px solid ${meta.color}`, overflow: "hidden", transition: "all 0.2s",
       boxShadow: isExpanded ? `0 4px 16px ${meta.color}22` : "0 1px 3px rgba(0,0,0,0.06)",
      }}>
       {/* Header */}
       <div onClick={() => setExpandedId(isExpanded ? null : s.id)} style={{ padding: "14px 18px", cursor: "pointer", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
         <div>
          <div style={{ fontSize: 14, fontWeight: 700, color: C.text }}>{s.name}</div>
          <div style={{ fontSize: 10, color: C.textDim, marginTop: 2 }}>
           <Badge color={meta.color} bg={`${meta.color}15`}>{meta.label}</Badge>
           <span style={{ marginLeft: 8 }}>{s.date}</span>
          </div>
         </div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
         <div style={{ textAlign: "right" }}>
          <div style={{ fontSize: 16, fontWeight: 800, color: meta.color }}>{fmtEuro(s.totScenario, 0)}</div>
          <div style={{ fontSize: 10, color: s.delta > 0 ? C.danger : C.success, fontWeight: 600 }}>
           {s.delta > 0 ? "+" : ""}{fmtEuro(s.delta, 0)} ({deltaPct > 0 ? "+" : ""}{deltaPct}% vs base)
          </div>
         </div>
         <span style={{ fontSize: 16, color: C.textDim, transition: "transform 0.2s", transform: isExpanded ? "rotate(180deg)" : "rotate(0deg)" }}>▼</span>
        </div>
       </div>

       {/* Expanded detail */}
       {isExpanded && (
        <div style={{ borderTop: `1px solid ${C.border}`, padding: "16px 18px" }}>
         {/* Parameters */}
         <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(160px, 1fr))", gap: 10, marginBottom: 16 }}>
          <div style={{ background: `${meta.color}08`, borderRadius: 8, padding: "10px 12px", border: `1px solid ${meta.color}15` }}>
           <div style={{ fontSize: 9, color: C.textDim, fontWeight: 600, textTransform: "uppercase" }}>Prezzi</div>
           <div style={{ fontSize: 16, fontWeight: 800, color: s.priceAdj > 0 ? C.danger : s.priceAdj < 0 ? C.success : C.text }}>{s.priceAdj > 0 ? "+" : ""}{s.priceAdj}%</div>
          </div>
          <div style={{ background: `${C.accent}08`, borderRadius: 8, padding: "10px 12px", border: `1px solid ${C.accent}15` }}>
           <div style={{ fontSize: 9, color: C.textDim, fontWeight: 600, textTransform: "uppercase" }}>Consumi</div>
           <div style={{ fontSize: 16, fontWeight: 800, color: s.consumoAdj > 0 ? C.danger : s.consumoAdj < 0 ? C.success : C.text }}>{s.consumoAdj > 0 ? "+" : ""}{s.consumoAdj}%</div>
          </div>
          <div style={{ background: `${C.warn}08`, borderRadius: 8, padding: "10px 12px", border: `1px solid ${C.warn}15` }}>
           <div style={{ fontSize: 9, color: C.textDim, fontWeight: 600, textTransform: "uppercase" }}>Oneri</div>
           <div style={{ fontSize: 16, fontWeight: 800, color: s.oneriAdj > 0 ? C.danger : s.oneriAdj < 0 ? C.success : C.text }}>{s.oneriAdj > 0 ? "+" : ""}{s.oneriAdj}%</div>
          </div>
          <div style={{ background: `${C.success}08`, borderRadius: 8, padding: "10px 12px", border: `1px solid ${C.success}15` }}>
           <div style={{ fontSize: 9, color: C.textDim, fontWeight: 600, textTransform: "uppercase" }}>Base Forecast</div>
           <div style={{ fontSize: 16, fontWeight: 800, color: C.text }}>{fmtEuro(s.totBase, 0)}</div>
          </div>
         </div>

         {/* Monthly chart bars */}
         {s.months && s.months.length > 0 && (
          <div style={{ background: `${C.bg}`, borderRadius: 10, padding: 14, marginBottom: 14 }}>
           <div style={{ fontSize: 11, fontWeight: 700, color: C.text, marginBottom: 10 }}>Confronto Mensile: Scenario vs Base</div>
           <div style={{ display: "flex", alignItems: "flex-end", gap: 3, height: 120 }}>
            {s.months.map((d, i) => {
             const max = Math.max(...s.months.map(x => Math.max(x.scenario, x.base)));
             const hS = max > 0 ? (d.scenario / max) * 100 : 0;
             const hB = max > 0 ? (d.base / max) * 100 : 0;
             return (
              <div key={i} style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 2 }}>
               <div style={{ display: "flex", gap: 1, alignItems: "flex-end", width: "100%", justifyContent: "center" }}>
                <div style={{ width: "40%", height: hS, background: meta.color, borderRadius: "2px 2px 0 0" }} title={`Scenario ${d.name}: ${fmtEuro(d.scenario, 0)}`} />
                <div style={{ width: "40%", height: hB, background: C.textDim + "55", borderRadius: "2px 2px 0 0" }} title={`Base ${d.name}: ${fmtEuro(d.base, 0)}`} />
               </div>
               <span style={{ fontSize: 8, color: C.textDim }}>{d.name}</span>
              </div>
             );
            })}
           </div>
           <div style={{ display: "flex", gap: 12, marginTop: 8, fontSize: 10 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 4 }}><div style={{ width: 10, height: 10, borderRadius: 2, background: meta.color }} /><span style={{ color: C.textMuted }}>Scenario</span></div>
            <div style={{ display: "flex", alignItems: "center", gap: 4 }}><div style={{ width: 10, height: 10, borderRadius: 2, background: C.textDim + "55" }} /><span style={{ color: C.textMuted }}>Forecast Base</span></div>
           </div>
          </div>
         )}

         {/* Monthly detail table */}
         {s.months && s.months.length > 0 && (
          <div style={{ overflowX: "auto", marginBottom: 14 }}>
           <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11 }}>
            <thead>
             <tr>
              {["Mese", "Scenario €", "Base €", "Delta €", "Δ %"].map(h => (
               <th key={h} style={{ padding: "6px 8px", textAlign: h === "Mese" ? "left" : "right", fontWeight: 700, color: C.textDim, borderBottom: `2px solid ${C.border}`, fontSize: 10 }}>{h}</th>
              ))}
             </tr>
            </thead>
            <tbody>
             {s.months.map((d, i) => {
              const delta = d.scenario - d.base;
              const pct = d.base > 0 ? +(delta / d.base * 100).toFixed(1) : 0;
              return (
               <tr key={i} style={{ borderBottom: `1px solid ${C.border}22` }}>
                <td style={{ padding: "5px 8px", fontWeight: 600 }}>{d.name}</td>
                <td style={{ padding: "5px 8px", textAlign: "right", fontWeight: 600, color: meta.color }}>{fmtEuro(d.scenario, 0)}</td>
                <td style={{ padding: "5px 8px", textAlign: "right", color: C.textMuted }}>{fmtEuro(d.base, 0)}</td>
                <td style={{ padding: "5px 8px", textAlign: "right", fontWeight: 600, color: delta > 0 ? C.danger : C.success }}>{delta > 0 ? "+" : ""}{fmtEuro(delta, 0)}</td>
                <td style={{ padding: "5px 8px", textAlign: "right", fontSize: 10, color: delta > 0 ? C.danger : C.success }}>{pct > 0 ? "+" : ""}{pct}%</td>
               </tr>
              );
             })}
             <tr style={{ borderTop: `2px solid ${C.border}` }}>
              <td style={{ padding: "6px 8px", fontWeight: 800 }}>TOTALE</td>
              <td style={{ padding: "6px 8px", textAlign: "right", fontWeight: 800, color: meta.color }}>{fmtEuro(s.totScenario, 0)}</td>
              <td style={{ padding: "6px 8px", textAlign: "right", fontWeight: 700, color: C.textMuted }}>{fmtEuro(s.totBase, 0)}</td>
              <td style={{ padding: "6px 8px", textAlign: "right", fontWeight: 800, color: s.delta > 0 ? C.danger : C.success }}>{s.delta > 0 ? "+" : ""}{fmtEuro(s.delta, 0)}</td>
              <td style={{ padding: "6px 8px", textAlign: "right", fontWeight: 700, color: s.delta > 0 ? C.danger : C.success }}>{s.totBase > 0 ? `${deltaPct > 0 ? "+" : ""}${deltaPct}%` : "—"}</td>
             </tr>
            </tbody>
           </table>
          </div>
         )}

         {/* Actions */}
         <div style={{ display: "flex", gap: 8 }}>
          <button onClick={() => onDelete(s.id)} style={{
           padding: "7px 16px", borderRadius: 6, border: `1px solid ${C.danger}44`,
           background: `${C.danger}08`, color: C.danger, fontSize: 11, fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
          }}>Elimina Scenario</button>
         </div>
        </div>
       )}
      </div>
     );
    })}
   </div>
  </div>
 );
}

function ForecastUtilityDetail({ utility }) {
 const { co, energyData, gasData, pods, pdrs } = useCompanyFilter();
 const meta = UTILITY_META[utility];
 const futures = FUTURES_PRICES[utility];
 const unit = utility === "energia" ? "kWh" : "Smc";
 const sourceData = utility === "energia" ? energyData : gasData;
 const { preset, setPreset, filtered: filtData, customFrom, setCustomFrom, customTo, setCustomTo } = usePeriodFilter(sourceData);
 const devices = utility === "energia" ? pods : pdrs;
 const idLabel = utility === "energia" ? "POD" : "PDR";

 const [selectedDevice, setSelectedDevice] = useState("all");

 // Device-aware getters
 const getAct = (m, anno) => selectedDevice === "all" ? getActualByUtilityMonth(utility, m, co, anno) : getActualByDevice(utility, selectedDevice, m, co, anno);
 const getCons = (m, anno) => selectedDevice === "all" ? getConsumoByUtilityMonth(utility, m, co, anno) : getConsumoByDevice(utility, selectedDevice, m, co, anno);
 const getOner = (m, anno) => selectedDevice === "all" ? getAltriOneriByMonth(utility, m, co, anno) : getAltriOneriByDevice(utility, selectedDevice, m, co, anno);

 // Q1 2026 (Gen-Mar) = consolidato, Apr-Dic = forecast
 const CONSOLIDATO_END = 2; // index 0=Gen, 1=Feb, 2=Mar → last consolidato month

 const forecastMonths = useMemo(() => Array.from({ length: 12 }, (_, m) => {
  const isConsolidato = m <= CONSOLIDATO_END;

  // For consolidato months: use actual 2026 data
  const actual2026 = getAct(m, 2026);
  const consumo2026 = getCons(m, 2026);

  // For forecast months: use 2025 consumi × futures 2026 prices
  const consumo2025 = getCons(m, 2025);
  const prezzoFuturesMWh = futures.monthly[m];
  const prezzoPerUnit = futures.toUnit(prezzoFuturesMWh);
  const costoMateriaFcast = consumo2025 * prezzoPerUnit;
  const altriOneri2025 = getOner(m, 2025);
  const consumoCorr2025 = getCons(m, 2025);
  const ratioAltriOneri = consumoCorr2025 > 0 ? altriOneri2025 / consumoCorr2025 : 0;
  const costoOneriFcast = consumo2025 * ratioAltriOneri;
  const totaleForecast = costoMateriaFcast + costoOneriFcast;

  // Actual 2025 same month for YoY comparison
  const actual2025 = getAct(m, 2025);

  // The "value" column: consolidato uses real 2026 data, forecast uses calculated
  const valore2026 = isConsolidato ? actual2026 : +totaleForecast.toFixed(0);
  const consumoRef = isConsolidato ? consumo2026 : consumo2025;

  return {
   name: MONTHS[m], month: m, isConsolidato,
   consumoRef, prezzoFuturesMWh, prezzoPerUnit: +prezzoPerUnit.toFixed(5),
   costoMateria: isConsolidato ? 0 : +costoMateriaFcast.toFixed(0),
   ratioAltriOneri: +ratioAltriOneri.toFixed(4),
   costoAltriOneri: isConsolidato ? 0 : +costoOneriFcast.toFixed(0),
   valore2026,
   actual2025: +actual2025.toFixed(0),
   delta: +(valore2026 - actual2025).toFixed(0),
   // Chart bars
   consolidato: isConsolidato ? valore2026 : 0,
   forecastMateria: !isConsolidato ? +costoMateriaFcast.toFixed(0) : 0,
   forecastOneri: !isConsolidato ? +costoOneriFcast.toFixed(0) : 0,
  };
 }), [utility, co, selectedDevice]);

 const consolidatoMonths = forecastMonths.filter(m => m.isConsolidato);
 const forecastOnlyMonths = forecastMonths.filter(m => !m.isConsolidato);
 const totConsolidato = consolidatoMonths.reduce((s, d) => s + d.valore2026, 0);
 const totForecastOnly = forecastOnlyMonths.reduce((s, d) => s + d.valore2026, 0);
 const totAnno2026 = totConsolidato + totForecastOnly;
 const totActual2025 = forecastMonths.reduce((s, d) => s + d.actual2025, 0);
 const totMateria = forecastOnlyMonths.reduce((s, d) => s + d.costoMateria, 0);
 const totOneri = forecastOnlyMonths.reduce((s, d) => s + d.costoAltriOneri, 0);
 const deltaVs2025 = totAnno2026 - totActual2025;

 return (
 <div>
 <SectionTitle sub={`Gen–Mar 2026 consolidato + Apr–Dic 2026 forecast (${futures.label})${selectedDevice !== "all" ? ` — ${selectedDevice}` : ""}`}>
 Forecast {meta.label} — 2026
 </SectionTitle>

 {/* Device selector */}
 {devices.length > 0 && (
 <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 16, background: C.card, borderRadius: 10, padding: "10px 14px", border: `1px solid ${C.border}` }}>
 <span style={{ fontSize: 11, fontWeight: 700, color: C.text, whiteSpace: "nowrap" }}>Punto di fornitura:</span>
 <select value={selectedDevice} onChange={e => setSelectedDevice(e.target.value)}
  style={{ flex: 1, maxWidth: 420, padding: "6px 10px", borderRadius: 6, border: `1px solid ${meta.color}55`, background: selectedDevice !== "all" ? `${meta.color}08` : C.card, color: C.text, fontSize: 11, fontFamily: "inherit", cursor: "pointer" }}>
  <option value="all">Tutti i {idLabel} (aggregato)</option>
  {devices.map(d => <option key={d.id} value={d.id}>{d.id} — {d.city || d.site}</option>)}
 </select>
 {selectedDevice !== "all" && (
  <span style={{ fontSize: 10, color: meta.color, fontWeight: 600, padding: "3px 8px", borderRadius: 4, background: `${meta.color}15` }}>
   {idLabel}: {selectedDevice.slice(-6)}
  </span>
 )}
 </div>
 )}

 <PeriodFilterBar preset={preset} setPreset={setPreset} customFrom={customFrom} setCustomFrom={setCustomFrom} customTo={customTo} setCustomTo={setCustomTo} />

 {/* Futures prices display */}
 <div style={{ background: C.card, borderRadius: 12, padding: 16, border: `1px solid ${C.border}`, marginBottom: 20 }}>
 <div style={{ fontSize: 13, fontWeight: 700, color: meta.color, marginBottom: 10 }}>
 Prezzi Futures 2026 — {futures.label} <span style={{ fontWeight: 400, fontSize: 11, color: C.textDim }}>({futures.unit})</span>
 </div>
 <div style={{ display: "grid", gridTemplateColumns: "repeat(12, 1fr)", gap: 4 }}>
 {futures.monthly.map((p, i) => {
  const isCons = i <= CONSOLIDATO_END;
  return (
  <div key={i} style={{ background: isCons ? `${C.success}11` : `${meta.color}11`, borderRadius: 6, padding: "6px 2px", textAlign: "center", border: `1px solid ${isCons ? C.success : meta.color}22` }}>
  <div style={{ fontSize: 9, color: C.textDim, fontWeight: 600 }}>{MONTHS[i]} 26</div>
  <div style={{ fontSize: 13, fontWeight: 800, color: isCons ? C.success : meta.color }}>{p.toLocaleString("it-IT", {minimumFractionDigits:1, maximumFractionDigits:1})}</div>
  <div style={{ fontSize: 8, color: isCons ? C.success : meta.color, fontWeight: 600 }}>{isCons ? "CONS." : "FCAST"}</div>
  </div>
  );
 })}
 </div>
 <div style={{ fontSize: 10, color: C.textDim, marginTop: 6 }}>
 Fonte: <a href={futures.source} target="_blank" rel="noopener" style={{ color: C.accentLight }}>{futures.label}</a> · Dati demo a scopo illustrativo
 </div>
 </div>

 {/* Consolidato vs Forecast split */}
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1px 1fr", gap: 0, marginBottom: 20, background: C.card, borderRadius: 12, border: `1px solid ${C.border}`, overflow: "hidden" }}>
  <div style={{ padding: 18 }}>
   <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12 }}>
    <div style={{ width: 10, height: 10, borderRadius: 3, background: C.success }}></div>
    <span style={{ fontSize: 12, fontWeight: 700, color: C.success, textTransform: "uppercase", letterSpacing: 0.5 }}>Consolidato 2026 (Gen–Mar)</span>
   </div>
   <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
    <KPICard label="Spesa Consolidata Q1" value={fmtEuro(totConsolidato, 0)} color={C.success} />
    <KPICard label="Mesi Chiusi" value={`${consolidatoMonths.length} / 12`} color={C.success} />
   </div>
  </div>
  <div style={{ background: C.border }}></div>
  <div style={{ padding: 18 }}>
   <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12 }}>
    <div style={{ width: 10, height: 10, borderRadius: 3, background: meta.color }}></div>
    <span style={{ fontSize: 12, fontWeight: 700, color: meta.color, textTransform: "uppercase", letterSpacing: 0.5 }}>Forecast 2026 (Apr–Dic)</span>
   </div>
   <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }}>
    <KPICard label="Proiezione Apr–Dic" value={fmtEuro(totForecastOnly, 0)} color={meta.color} />
    <KPICard label="Mesi Proiettati" value={`${forecastOnlyMonths.length} / 12`} color={meta.color} />
   </div>
  </div>
 </div>

 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 20 }}>
 <KPICard label="Totale 2026 (Cons.+Fcast)" value={fmtEuro(totAnno2026, 0)} color={meta.color} />
 <KPICard label="di cui Materia Prima (fcast)" value={fmtEuro(totMateria, 0)} color={C.materia} sub={totForecastOnly > 0 ? `${fmt(totMateria / totForecastOnly * 100, 0)}% del forecast` : ""} />
 <KPICard label="di cui Altri Oneri (fcast)" value={fmtEuro(totOneri, 0)} color={C.oneri} sub={totForecastOnly > 0 ? `${fmt(totOneri / totForecastOnly * 100, 0)}% del forecast` : ""} />
 <KPICard label="Totale 2025" value={fmtEuro(totActual2025, 0)} color={C.accent} />
 <KPICard label="Delta 2026 vs 2025" value={`${deltaVs2025 > 0 ? "+" : ""}${fmtEuro(deltaVs2025, 0)}`} color={deltaVs2025 > 0 ? C.danger : C.success} change={totActual2025 > 0 ? +(deltaVs2025 / totActual2025 * 100).toFixed(1) : 0} />
 </div>

 {/* Chart */}
 <ChartCard title={`Consolidato + Forecast 2026 vs Actual 2025 — ${meta.label}`} style={{ marginBottom: 20 }}>
 <div style={{ display: "flex", gap: 16, marginBottom: 8, paddingLeft: 8, flexWrap: "wrap" }}>
  <div style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, fontWeight: 600 }}>
   <div style={{ width: 12, height: 12, borderRadius: 2, background: C.success }}></div> <span style={{ color: C.textMuted }}>Consolidato 2026 (Q1)</span>
  </div>
  <div style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, fontWeight: 600 }}>
   <div style={{ width: 12, height: 12, borderRadius: 2, background: meta.color }}></div> <span style={{ color: C.textMuted }}>Forecast — Materia Prima</span>
  </div>
  <div style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, fontWeight: 600 }}>
   <div style={{ width: 12, height: 12, borderRadius: 2, background: `${meta.color}88` }}></div> <span style={{ color: C.textMuted }}>Forecast — Altri Oneri</span>
  </div>
  <div style={{ display: "flex", alignItems: "center", gap: 4, fontSize: 10, fontWeight: 600 }}>
   <div style={{ width: 12, height: 3, background: C.accent }}></div> <span style={{ color: C.textMuted }}>Actual 2025</span>
  </div>
 </div>
 <ResponsiveContainer width="100%" height={300}>
 <ComposedChart data={forecastMonths}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${(v / 1000).toFixed(0)}k`} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v, 0)} />
 <Bar dataKey="consolidato" stackId="a" fill={C.success} name="Consolidato Q1 2026" />
 <Bar dataKey="forecastMateria" stackId="a" fill={meta.color} name="Forecast — Materia Prima" />
 <Bar dataKey="forecastOneri" stackId="a" fill={`${meta.color}88`} name="Forecast — Altri Oneri" radius={[4, 4, 0, 0]} />
 <Line dataKey="actual2025" stroke={C.accent} strokeWidth={2} strokeDasharray="5 5" dot={{ r: 2, fill: C.accent }} name="Actual 2025" />
 </ComposedChart>
 </ResponsiveContainer>
 </ChartCard>

 {/* Table */}
 <SectionTitle sub="Verde = dato reale 2026, colorato = forecast basato su consumi 2025 × futures 2026">Tabella Dettagliata 2026</SectionTitle>
 <DataTable
 columns={[
 { key: "name", label: "Mese", render: (v, row) => (
  <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
   <div style={{ width: 8, height: 8, borderRadius: 2, background: row.isConsolidato ? C.success : meta.color, flexShrink: 0 }}></div>
   <span style={{ fontWeight: 600 }}>{v} 26</span>
   <span style={{ fontSize: 9, fontWeight: 700, color: row.isConsolidato ? C.success : meta.color, background: row.isConsolidato ? `${C.success}15` : `${meta.color}15`, padding: "1px 5px", borderRadius: 3 }}>{row.isConsolidato ? "CONS." : "FCAST"}</span>
  </div>
 )},
 { key: "consumoRef", label: `Consumi (${unit})`, align: "right", render: (v, row) => <span style={{ color: row.isConsolidato ? C.success : C.text }}>{fmt(v)}</span> },
 { key: "prezzoFuturesMWh", label: `Futures (${futures.unit})`, align: "right", render: v => `€${v.toLocaleString("it-IT", {minimumFractionDigits:1, maximumFractionDigits:1})}` },
 { key: "costoMateria", label: "Materia Prima €", align: "right", render: (v, row) => row.isConsolidato ? <span style={{ color: C.textDim }}>—</span> : fmtEuro(v, 0) },
 { key: "costoAltriOneri", label: "Altri Oneri €", align: "right", render: (v, row) => row.isConsolidato ? <span style={{ color: C.textDim }}>—</span> : fmtEuro(v, 0) },
 { key: "valore2026", label: "2026 €", align: "right", render: (v, row) => <strong style={{ color: row.isConsolidato ? C.success : meta.color }}>{fmtEuro(v, 0)}</strong> },
 { key: "actual2025", label: "2025 €", align: "right", render: v => fmtEuro(v, 0) },
 { key: "delta", label: "Delta €", align: "right", render: v => <span style={{ color: v > 0 ? C.danger : C.success, fontWeight: 600 }}>{v > 0 ? "+" : ""}{fmtEuro(v, 0)}</span> },
 ]}
 data={forecastMonths}
 maxHeight={420}
 />

 {/* Formula */}
 <div style={{ background: "#e9ecf1", borderRadius: 10, padding: 14, border: `1px solid ${C.border}`, marginTop: 16, fontSize: 11, color: C.textDim, lineHeight: 1.7 }}>
 <strong style={{ color: C.text }}>Metodologia:</strong><br/>
 <strong style={{ color: C.success }}>Gen–Mar 2026 (Consolidato)</strong>: dati reali di fatturazione 2026 già disponibili.<br/>
 <strong style={{ color: meta.color }}>Apr–Dic 2026 (Forecast)</strong>: <code style={{ color: meta.color }}>Consumi 2025<sub>mese</sub></code> × <code>Prezzo Futures 2026<sub>mese</sub></code> + <code style={{ color: C.warn }}>Coeff. Oneri 2025</code> × <code>Consumi 2025<sub>mese</sub></code>
 </div>
 </div>
 );
}

// ─── AI ASSISTANT ──────────────────────────────────────────────────────────────

function buildDataContext() {
 // Summarize the full dataset into a compact context for the AI
 const totEnergy = ENERGY_DATA.reduce((s, d) => s + d.totaleFattura, 0);
 const totGas = GAS_DATA.reduce((s, d) => s + d.totaleFattura, 0);
 const totMobile = MOBILE_DATA.reduce((s, d) => s + d.totaleFattura, 0);
 const totFixed = FIXED_DATA.reduce((s, d) => s + d.totaleFattura, 0);
 const totConn = CONN_DATA.reduce((s, d) => s + d.totaleFattura, 0);
 const grandTotal = totEnergy + totGas + totMobile + totFixed + totConn;

 const energyConsumo = ENERGY_DATA.reduce((s, d) => s + d.consumoTotale, 0);
 const energyCosto = ENERGY_DATA.reduce((s, d) => s + d.importoEnergia, 0);
 const gasConsumo = GAS_DATA.reduce((s, d) => s + d.consumoSmc, 0);

 const podSummaries = PODS.map(pod => {
 const rows = ENERGY_DATA.filter(d => d.pod === pod.id);
 const cons = rows.reduce((s, d) => s + d.consumoTotale, 0);
 const cost = rows.reduce((s, d) => s + d.totaleFattura, 0);
 const ener = rows.reduce((s, d) => s + d.importoEnergia, 0);
 const cong = rows.reduce((s, d) => s + d.conguaglio, 0);
 const pctEst = (rows.filter(d => d.isEstimated).length / rows.length * 100).toFixed(1);
 const f1 = rows.reduce((s, d) => s + d.consumoF1, 0);
 const f2 = rows.reduce((s, d) => s + d.consumoF2, 0);
 const f3 = rows.reduce((s, d) => s + d.consumoF3, 0);
 const monthly = Array.from({ length: 12 }, (_, m) => {
 const mr = rows.filter(d => d.meseConsumi === m);
 return { mese: MONTHS[m], kWh: mr.reduce((s, d) => s + d.consumoTotale, 0), eur: +mr.reduce((s, d) => s + d.totaleFattura, 0).toFixed(0) };
 });
 return `POD ${pod.id} (${pod.site}, ${pod.city}, P.contr=${pod.power}kW, CdC=${pod.cdc}, Resp=${pod.person}, Reparto=${pod.dept}): Consumo annuo=${cons}kWh, Costo=${cost.toFixed(0)}€, CostoUnit=${(ener/cons).toFixed(4)}€/kWh, Conguagli=${cong.toFixed(0)}€, %Stimato=${pctEst}%, F1=${f1}kWh(${(f1/cons*100).toFixed(0)}%), F2=${f2}kWh(${(f2/cons*100).toFixed(0)}%), F3=${f3}kWh(${(f3/cons*100).toFixed(0)}%). Mensile: ${monthly.map(m => `${m.mese}:${m.kWh}kWh/${m.eur}€`).join(', ')}`;
 });

 const pdrSummaries = PDRS.map(pdr => {
 const rows = GAS_DATA.filter(d => d.pdr === pdr.id);
 const cons = rows.reduce((s, d) => s + d.consumoSmc, 0);
 const cost = rows.reduce((s, d) => s + d.totaleFattura, 0);
 const pcs = rows.reduce((s, d) => s + d.pcsMedio, 0) / rows.length;
 const monthly = Array.from({ length: 12 }, (_, m) => {
 const mr = rows.filter(d => d.meseConsumi === m);
 return { mese: MONTHS[m], smc: mr.reduce((s, d) => s + d.consumoSmc, 0), eur: +mr.reduce((s, d) => s + d.totaleFattura, 0).toFixed(0) };
 });
 return `PDR ${pdr.id} (${pdr.site}, ${pdr.city}, Distrib=${pdr.distributor}, CdC=${pdr.cdc}, Resp=${pdr.person}): Consumo annuo=${cons}Smc, Costo=${cost.toFixed(0)}€, CostoUnit=${(cost/cons).toFixed(4)}€/Smc, PCS medio=${pcs.toFixed(2)}. Mensile: ${monthly.map(m => `${m.mese}:${m.smc}Smc/${m.eur}€`).join(', ')}`;
 });

 const mobileSummary = MOBILE_LINES.map(l => `Linea ${l.id}: profilo=${l.profile}, persona=${l.person}, reparto=${l.dept}, cdc=${l.cdc}, canone=${l.fixedCost}€/mese, servizi=[${l.services.join(',')}]`).join('\n');

 const fixedSummary = FIXED_LINES.map(l => `Linea ${l.id}: sede=${l.site}, servizio=${l.service}, canone=${l.monthlyCost}€/mese, cdc=${l.cdc}`).join('\n');

 const connSummary = CONNECTIVITY.map(c => `${c.id}: sede=${c.site}, tipo=${c.type}, banda=${c.band}, BMG=${c.bmg}, canone=${c.monthlyCost}€/mese, SLA=${c.sla}, cdc=${c.cdc}`).join('\n');

 // Energy cost breakdown
 const totDisp = ENERGY_DATA.reduce((s, d) => s + d.dispacciamento, 0);
 const totDist = ENERGY_DATA.reduce((s, d) => s + d.distribuzione, 0);
 const totOneri = ENERGY_DATA.reduce((s, d) => s + d.oneriSistema, 0);
 const totAccise = ENERGY_DATA.reduce((s, d) => s + d.accise, 0);
 const totIva = ENERGY_DATA.reduce((s, d) => s + d.iva, 0);
 const totConguagli = ENERGY_DATA.reduce((s, d) => s + d.conguaglio, 0);

 return `Sei l'analista AI esperto del sistema di gestione utility aziendali di REALE IMMOBILI SPA. Anno di riferimento: 2025.

RIEPILOGO GENERALE:
- Spesa totale utility: €${grandTotal.toFixed(0)} (Energia €${totEnergy.toFixed(0)}, Gas €${totGas.toFixed(0)}, Mobile €${totMobile.toFixed(0)}, Fisso €${totFixed.toFixed(0)}, Connettività €${totConn.toFixed(0)})
- Distribuzione: Energia ${(totEnergy/grandTotal*100).toFixed(1)}%, Gas ${(totGas/grandTotal*100).toFixed(1)}%, Mobile ${(totMobile/grandTotal*100).toFixed(1)}%, Fisso ${(totFixed/grandTotal*100).toFixed(1)}%, Connettività ${(totConn/grandTotal*100).toFixed(1)}%

ENERGIA ELETTRICA:
- ${PODS.length} POD attivi, consumo totale ${energyConsumo} kWh, costo medio €${(energyCosto/energyConsumo).toFixed(4)}/kWh
- Scomposizione costi: Materia prima €${energyCosto.toFixed(0)}, Dispacciamento €${totDisp.toFixed(0)}, Distribuzione €${totDist.toFixed(0)}, Oneri sistema €${totOneri.toFixed(0)}, Accise €${totAccise.toFixed(0)}, IVA €${totIva.toFixed(0)}
- Conguagli totali: €${totConguagli.toFixed(0)}
- % dati stimati: ${(ENERGY_DATA.filter(d=>d.isEstimated).length/ENERGY_DATA.length*100).toFixed(1)}%
Dettaglio per POD:
${podSummaries.join('\n')}

GAS NATURALE:
- ${PDRS.length} PDR attivi, consumo totale ${gasConsumo} Smc
Dettaglio per PDR:
${pdrSummaries.join('\n')}

TELEFONIA MOBILE:
- ${MOBILE_LINES.length} linee attive, spesa annua €${totMobile.toFixed(0)}
${mobileSummary}

TELEFONIA FISSA:
- ${FIXED_LINES.length} linee, spesa annua €${totFixed.toFixed(0)}
${fixedSummary}

CONNETTIVITÀ:
- ${CONNECTIVITY.length} collegamenti, spesa annua €${totConn.toFixed(0)}
${connSummary}

CENTRI DI COSTO: CDC-001 (Facility/Torino), CDC-002 (Operations/Milano), CDC-003 (Vendite/Roma), CDC-004 (IT)

Rispondi SEMPRE in italiano. Usa i dati sopra per rispondere in modo preciso e quantitativo. Puoi fare analisi, confronti, identificare anomalie, suggerire ottimizzazioni, calcolare trend, e rispondere a qualsiasi domanda sui dati utility. Formatta le risposte con numeri precisi e sii conciso ma completo. Se fai calcoli, mostra i passaggi. Usa emoji per rendere la risposta più leggibile.`;
}

const SUGGESTED_PROMPTS = [
 { label: "Analisi costi", prompt: "Fai un'analisi dettagliata della distribuzione dei costi utility per centro di costo. Quale CdC ha il costo più alto e perché?" },
 { label: "Anomalie energia", prompt: "Identifica le anomalie nei consumi energia: quali POD hanno consumi fuori norma? Ci sono mesi con picchi sospetti? Qual è l'impatto dei conguagli?" },
 { label: "Stagionalità gas", prompt: "Analizza la stagionalità dei consumi gas. Confronta i PDR di Torino e Milano: quale ha un profilo di consumo più efficiente?" },
 { label: "Ottimizzazione", prompt: "Suggerisci 5 azioni concrete per ottimizzare i costi utility basandoti sui dati. Stima il risparmio potenziale per ciascuna." },
 { label: "Costi mobile", prompt: "Analizza i costi della telefonia mobile per profilo tariffario. Ci sono linee con profili sovradimensionati? Quale piano è il più conveniente?" },
 { label: "Trend & forecast", prompt: "Analizza il trend dei costi energia degli ultimi 12 mesi. C'è un trend in crescita o in calo? Fai una proiezione per i prossimi 3 mesi." },
 { label: "Contabilità vs Competenza", prompt: "Spiega con esempi concreti dai nostri dati la differenza tra vista contabilità e vista competenza. Mostra come i conguagli distorcono l'analisi se attribuiti al mese di emissione." },
 { label: "Confronto sedi", prompt: "Confronta i costi utility totali (energia + gas + TLC) per sede: Torino vs Milano vs Roma. Normalizza per numero di dispositivi e identifica la sede più efficiente." },
];

function AIAssistant() {
 const [messages, setMessages] = useState([]);
 const [input, setInput] = useState("");
 const [loading, setLoading] = useState(false);
 const [showSuggestions, setShowSuggestions] = useState(true);
 const chatContainerRef = useCallback(node => {
 if (node) { node._el = node; }
 }, []);

 // Auto-scroll on new messages
 useEffect(() => {
 const el = document.getElementById("ai-chat-scroll");
 if (el) el.scrollTop = el.scrollHeight;
 }, [messages, loading]);

 const systemPrompt = useMemo(() => buildDataContext(), []);

 const sendMessage = async (text) => {
 if (!text.trim()) return;
 const userMsg = { role: "user", content: text.trim() };
 const newMessages = [...messages, userMsg];
 setMessages(newMessages);
 setInput("");
 setLoading(true);
 setShowSuggestions(false);

 try {
 const apiMessages = newMessages.map(m => ({ role: m.role, content: m.content }));
 const response = await fetch("https://api.anthropic.com/v1/messages", {
 method: "POST",
 headers: { "Content-Type": "application/json" },
 body: JSON.stringify({
 model: "claude-sonnet-4-20250514",
 max_tokens: 4096,
 system: systemPrompt,
 messages: apiMessages,
 }),
 });
 if (!response.ok) {
 const errBody = await response.text();
 throw new Error(`HTTP ${response.status}: ${errBody.slice(0, 200)}`);
 }
 const data = await response.json();
 if (data.error) {
 throw new Error(data.error.message || JSON.stringify(data.error));
 }
 const assistantText = (data.content || [])
 .filter(b => b.type === "text" && b.text)
 .map(b => b.text)
 .join("\n") || "Mi dispiace, non ho potuto generare una risposta. Riprova.";
 setMessages(prev => [...prev, { role: "assistant", content: assistantText }]);
 } catch (err) {
 console.error("AI API Error:", err);
 setMessages(prev => [...prev, { role: "assistant", content: ` Errore di comunicazione con l'AI: ${err.message}\n\nRiprova tra qualche istante oppure prova con una domanda più breve.` }]);
 }
 setLoading(false);
 };

 const handleKeyDown = (e) => {
 if (e.key === "Enter" && !e.shiftKey) {
 e.preventDefault();
 sendMessage(input);
 }
 };

 const clearChat = () => {
 setMessages([]);
 setShowSuggestions(true);
 };

 // Simple markdown-ish rendering
 const renderContent = (text) => {
 const lines = text.split('\n');
 return lines.map((line, i) => {
 // Bold
 let processed = line.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
 // Headers
 if (line.startsWith('### ')) return <h4 key={i} style={{ margin: '12px 0 6px', fontSize: 14, fontWeight: 700, color: C.energyLight }}>{line.slice(4)}</h4>;
 if (line.startsWith('## ')) return <h3 key={i} style={{ margin: '14px 0 6px', fontSize: 15, fontWeight: 700, color: C.energy }}>{line.slice(3)}</h3>;
 // List items
 if (line.match(/^[-•]\s/)) return <div key={i} style={{ paddingLeft: 16, position: 'relative', marginBottom: 3 }}><span style={{ position: 'absolute', left: 4, color: C.energy }}>•</span><span dangerouslySetInnerHTML={{ __html: processed.slice(2) }} /></div>;
 if (line.match(/^\d+\.\s/)) return <div key={i} style={{ paddingLeft: 20, position: 'relative', marginBottom: 3 }}><span style={{ position: 'absolute', left: 0, color: C.energy, fontWeight: 700 }}>{line.match(/^\d+/)[0]}.</span><span dangerouslySetInnerHTML={{ __html: processed.replace(/^\d+\.\s/, '') }} /></div>;
 // Empty line
 if (!line.trim()) return <div key={i} style={{ height: 8 }} />;
 // Normal
 return <div key={i} style={{ marginBottom: 2 }} dangerouslySetInnerHTML={{ __html: processed }} />;
 });
 };

 return (
 <div style={{ display: "flex", flexDirection: "column", height: "calc(100vh - 120px)", maxHeight: 900 }}>
 {/* Header */}
 <div style={{ marginBottom: 16 }}>
 <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 8 }}>
 <div style={{
 width: 44, height: 44, borderRadius: 12,
 background: `linear-gradient(135deg, #8B5CF6, #3B82F6, #06B6D4)`,
 display: "flex", alignItems: "center", justifyContent: "center", fontSize: 22,
 boxShadow: "0 4px 20px #8B5CF633",
 }}></div>
 <div>
 <div style={{ fontSize: 18, fontWeight: 700, color: C.text, fontFamily: "'Inter', sans-serif" }}>Utility AI Analyst</div>
 <div style={{ fontSize: 12, color: C.textDim }}>Analisi intelligente dei tuoi dati utility · Powered by Claude</div>
 </div>
 {messages.length > 0 && (
 <button onClick={clearChat} style={{ marginLeft: "auto", padding: "6px 14px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.textMuted, fontSize: 12, cursor: "pointer", fontFamily: "inherit" }}>
 Nuova chat
 </button>
 )}
 </div>
 <div style={{
 background: `linear-gradient(135deg, #8B5CF611, #3B82F611)`,
 borderRadius: 10, padding: "10px 14px", border: `1px solid #8B5CF622`,
 fontSize: 12, color: C.textMuted, lineHeight: 1.5,
 }}>
 L'AI ha accesso completo ai dati di tutte le utility: <strong style={{ color: C.energy }}>energia</strong>, <strong style={{ color: C.gas }}>gas</strong>, <strong style={{ color: C.mobile }}>telefonia mobile</strong>, <strong style={{ color: C.fixed }}>fissa</strong> e <strong style={{ color: C.conn }}>connettività</strong>. Puoi chiedere analisi, confronti, identificare anomalie, e ottenere suggerimenti di ottimizzazione.
 </div>
 </div>

 {/* Messages area */}
 <div id="ai-chat-scroll" style={{
 flex: 1, overflowY: "auto", display: "flex", flexDirection: "column", gap: 12,
 paddingRight: 8, minHeight: 0,
 }}>
 {showSuggestions && messages.length === 0 && (
 <div>
 <div style={{ fontSize: 13, fontWeight: 600, color: C.textMuted, marginBottom: 12 }}> Domande suggerite</div>
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
 {SUGGESTED_PROMPTS.map((sp, i) => (
 <button key={i} onClick={() => sendMessage(sp.prompt)} style={{
 background: C.card, border: `1px solid ${C.border}`, borderRadius: 10,
 padding: "12px 14px", cursor: "pointer", textAlign: "left",
 transition: "all 0.15s", fontFamily: "inherit",
 }}
 onMouseEnter={e => { e.currentTarget.style.borderColor = '#8B5CF666'; e.currentTarget.style.background = '#8B5CF611'; }}
 onMouseLeave={e => { e.currentTarget.style.borderColor = C.border; e.currentTarget.style.background = C.card; }}
 >
 <div style={{ fontSize: 14, marginBottom: 4 }}><span style={{ fontWeight: 600, color: C.text, fontSize: 12 }}>{sp.label}</span></div>
 <div style={{ fontSize: 11, color: C.textDim, lineHeight: 1.4 }}>{sp.prompt.slice(0, 90)}...</div>
 </button>
 ))}
 </div>
 </div>
 )}

 {messages.map((msg, i) => (
 <div key={i} style={{
 display: "flex", gap: 10, flexDirection: msg.role === "user" ? "row-reverse" : "row",
 alignItems: "flex-start",
 }}>
 <div style={{
 width: 30, height: 30, borderRadius: 8, flexShrink: 0,
 background: msg.role === "user" ? C.accent : `linear-gradient(135deg, #8B5CF6, #3B82F6)`,
 display: "flex", alignItems: "center", justifyContent: "center",
 fontSize: 14, color: "#fff",
 }}>
 {msg.role === "user" ? "" : ""}
 </div>
 <div style={{
 maxWidth: "80%", padding: "12px 16px", borderRadius: 14,
 background: msg.role === "user" ? `${C.accent}22` : C.card,
 border: `1px solid ${msg.role === "user" ? C.accent + "33" : C.border}`,
 fontSize: 13, lineHeight: 1.6, color: C.text,
 borderTopRightRadius: msg.role === "user" ? 4 : 14,
 borderTopLeftRadius: msg.role === "user" ? 14 : 4,
 }}>
 {msg.role === "user" ? msg.content : renderContent(msg.content)}
 </div>
 </div>
 ))}

 {loading && (
 <div style={{ display: "flex", gap: 10, alignItems: "flex-start" }}>
 <div style={{
 width: 30, height: 30, borderRadius: 8, flexShrink: 0,
 background: `linear-gradient(135deg, #8B5CF6, #3B82F6)`,
 display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14,
 }}></div>
 <div style={{
 padding: "14px 20px", borderRadius: 14, borderTopLeftRadius: 4,
 background: C.card, border: `1px solid ${C.border}`,
 }}>
 <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
 {[0, 1, 2].map(d => (
 <div key={d} style={{
 width: 8, height: 8, borderRadius: "50%", background: "#8B5CF6",
 animation: `pulse 1.2s ease-in-out ${d * 0.2}s infinite`,
 opacity: 0.5,
 }} />
 ))}
 <span style={{ fontSize: 12, color: C.textDim, marginLeft: 8 }}>Analisi in corso...</span>
 </div>
 </div>
 </div>
 )}

 </div>

 {/* Input area */}
 <div style={{ marginTop: 12, position: "relative" }}>
 {messages.length > 0 && !loading && (
 <div style={{ display: "flex", gap: 6, marginBottom: 8, flexWrap: "wrap" }}>
 {[
 "Approfondisci l'ultimo punto",
 "Mostra i numeri in dettaglio",
 "Confronta con l'anno precedente",
 "Quali azioni suggerisci?",
 ].map((q, i) => (
 <button key={i} onClick={() => sendMessage(q)} style={{
 padding: "5px 10px", borderRadius: 14, border: `1px solid ${C.border}`,
 background: "transparent", color: C.textMuted, fontSize: 11,
 cursor: "pointer", fontFamily: "inherit", transition: "all 0.15s",
 }}
 onMouseEnter={e => { e.currentTarget.style.borderColor = '#8B5CF666'; e.currentTarget.style.color = C.text; }}
 onMouseLeave={e => { e.currentTarget.style.borderColor = C.border; e.currentTarget.style.color = C.textMuted; }}
 >
 {q}
 </button>
 ))}
 </div>
 )}
 <div style={{
 display: "flex", gap: 10, background: C.card, borderRadius: 14,
 border: `1px solid ${C.border}`, padding: "6px 6px 6px 16px",
 alignItems: "flex-end",
 }}>
 <textarea
 value={input}
 onChange={e => setInput(e.target.value)}
 onKeyDown={handleKeyDown}
 placeholder="Chiedi qualsiasi cosa sui dati utility..."
 disabled={loading}
 rows={1}
 style={{
 flex: 1, background: "transparent", border: "none", color: C.text,
 fontSize: 13, fontFamily: "inherit", resize: "none", outline: "none",
 padding: "8px 0", lineHeight: 1.5, maxHeight: 120, overflowY: "auto",
 }}
 onInput={e => { e.target.style.height = "auto"; e.target.style.height = Math.min(e.target.scrollHeight, 120) + "px"; }}
 />
 <button
 onClick={() => sendMessage(input)}
 disabled={loading || !input.trim()}
 style={{
 width: 40, height: 40, borderRadius: 10, border: "none", cursor: loading || !input.trim() ? "not-allowed" : "pointer",
 background: loading || !input.trim() ? C.border : `linear-gradient(135deg, #8B5CF6, #3B82F6)`,
 color: "#fff", fontSize: 16, display: "flex", alignItems: "center", justifyContent: "center",
 transition: "all 0.2s", flexShrink: 0,
 boxShadow: loading || !input.trim() ? "none" : "0 2px 10px #8B5CF633",
 }}
 >
 ↑
 </button>
 </div>
 <div style={{ textAlign: "center", marginTop: 6, fontSize: 10, color: C.textDim }}>
 Invio per inviare · Shift+Invio per nuova riga · L'AI analizza i dati reali del tuo portafoglio utility
 </div>
 </div>

 <style>{`
 @keyframes pulse {
 0%, 100% { opacity: 0.3; transform: scale(0.8); }
 50% { opacity: 1; transform: scale(1.1); }
 }
 `}</style>
 </div>
 );
}

// ─── MAIN APP ─────────────────────────────────────────────────────────────────

// ─── SITE AGGREGATED VIEW ─────────────────────────────────────────────────

function BuildingDashboard() {
 const { co, isAll, companyName, energyData, gasData, mobileData, fixedData, connData } = useCompanyFilter();
 const [selectedBuilding, setSelectedBuilding] = useState(null);
 const [tab, setTab] = useState("panoramica");
 const [searchQuery, setSearchQuery] = useState("");
 const [buildingsState, setBuildingsState] = useState(() => BUILDINGS.map(b => ({ ...b, devices: { ...b.devices, pods: [...b.devices.pods], pdrs: [...b.devices.pdrs], fixedLines: [...b.devices.fixedLines], connectivity: [...b.devices.connectivity], mobileLines: [...b.devices.mobileLines] } })));

 // Assign device to building
 const assignDevice = useCallback((deviceType, deviceId, targetBuildingId) => {
 setBuildingsState(prev => prev.map(bld => {
 const devs = { ...bld.devices, [deviceType]: [...bld.devices[deviceType]] };
 // Remove from this building if it has it
 devs[deviceType] = devs[deviceType].filter(id => id !== deviceId);
 // Add to target building
 if (bld.id === targetBuildingId) devs[deviceType] = [...devs[deviceType], deviceId];
 return { ...bld, devices: devs };
 }));
 }, []);

 // Unassign device from all buildings
 const unassignDevice = useCallback((deviceType, deviceId) => {
 setBuildingsState(prev => prev.map(bld => ({
 ...bld, devices: { ...bld.devices, [deviceType]: bld.devices[deviceType].filter(id => id !== deviceId) }
 })));
 }, []);

 const buildings = useMemo(() => {
 const filtered = isAll ? buildingsState : buildingsState.filter(b => b.company === co);
 return filtered.map(bld => {
 const eCost = energyData.filter(d => bld.devices.pods.includes(d.pod)).reduce((s, d) => s + d.totaleFattura, 0);
 const eKwh = energyData.filter(d => bld.devices.pods.includes(d.pod)).reduce((s, d) => s + d.consumoTotale, 0);
 const gCost = gasData.filter(d => bld.devices.pdrs.includes(d.pdr)).reduce((s, d) => s + d.totaleFattura, 0);
 const gSmc = gasData.filter(d => bld.devices.pdrs.includes(d.pdr)).reduce((s, d) => s + d.consumoSmc, 0);
 const fCost = FIXED_LINES.filter(l => bld.devices.fixedLines.includes(l.id)).reduce((s, l) => s + l.monthlyCost * 12, 0);
 const cCost = CONNECTIVITY.filter(c => bld.devices.connectivity.includes(c.id)).reduce((s, c) => s + c.monthlyCost * 12, 0);
 const mCost = MOBILE_LINES.filter(l => bld.devices.mobileLines.includes(l.id)).reduce((s, l) => s + l.fixedCost * 12, 0);
 const totalCost = eCost + gCost + fCost + cCost + mCost;
 const numDevices = bld.devices.pods.length + bld.devices.pdrs.length + bld.devices.fixedLines.length + bld.devices.connectivity.length + bld.devices.mobileLines.length;
 const companyObj = COMPANIES.find(c => c.id === bld.company);
 const monthly = Array.from({ length: 12 }, (_, m) => {
 const me = energyData.filter(d => bld.devices.pods.includes(d.pod) && d.meseConsumi === m).reduce((s, d) => s + d.totaleFattura, 0);
 const mg = gasData.filter(d => bld.devices.pdrs.includes(d.pdr) && d.meseConsumi === m).reduce((s, d) => s + d.totaleFattura, 0);
 const mf = FIXED_LINES.filter(l => bld.devices.fixedLines.includes(l.id)).reduce((s, l) => s + l.monthlyCost, 0);
 const mc = CONNECTIVITY.filter(c => bld.devices.connectivity.includes(c.id)).reduce((s, c) => s + c.monthlyCost, 0);
 const mm = MOBILE_LINES.filter(l => bld.devices.mobileLines.includes(l.id)).reduce((s, l) => s + l.fixedCost, 0);
 return { name: MONTHS[m], energia: +me.toFixed(0), gas: +mg.toFixed(0), fisso: +mf.toFixed(0), conn: +mc.toFixed(0), mobile: +mm.toFixed(0), totale: +(me + mg + mf + mc + mm).toFixed(0) };
 });
 return { ...bld, eCost, eKwh, gCost, gSmc, fCost, cCost, mCost, totalCost, numDevices, companyObj, monthly };
 }).sort((a, b) => b.totalCost - a.totalCost);
 }, [co, isAll, energyData, gasData, buildingsState]);

 const grandTotal = buildings.reduce((s, b) => s + b.totalCost, 0);
 const totalDevices = buildings.reduce((s, b) => s + b.numDevices, 0);
 const sel = selectedBuilding ? buildings.find(b => b.id === selectedBuilding) : null;

 const tabs = [
 { key: "panoramica", label: "Panoramica" },
 { key: "dispositivi", label: "Gestione Dispositivi" },
 ];

 return (
 <div>
 {/* When a site is selected, show ONLY its detail scheda */}
 {sel ? (
 <BuildingDetail building={sel} onClose={() => setSelectedBuilding(null)} />
 ) : (
 <>
 <SectionTitle sub={`Costi utility aggregati per sito — ${companyName}`}>
 Vista per Sito
 </SectionTitle>

 {/* Tab bar */}
 <div style={{ display: "flex", gap: 4, marginBottom: 20, background: C.card, borderRadius: 10, padding: 4, border: `1px solid ${C.border}`, width: "fit-content" }}>
 {tabs.map(t => (
 <button key={t.key} onClick={() => setTab(t.key)} style={{
 padding: "8px 18px", borderRadius: 8, border: "none", cursor: "pointer",
 fontSize: 12, fontWeight: 600, fontFamily: "inherit",
 background: tab === t.key ? C.accent : "transparent",
 color: tab === t.key ? "#fff" : C.textMuted,
 transition: "all 0.15s",
 }}>{t.label}</button>
 ))}
 </div>

 {tab === "panoramica" && (
 <>
 {/* KPI row */}
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(190px, 1fr))", gap: 14, marginBottom: 24 }}>
 <KPICard label="N. Siti" value={buildings.length} color="#8B5CF6" />
 <KPICard label="Costo Totale Annuo" value={fmtEuro(grandTotal, 0)} color={C.accent} />
 <KPICard label="Dispositivi Associati" value={totalDevices} color={C.conn} />
 </div>

 {/* Horizontal bar chart */}
 <ChartCard title="Costo Annuo per Sito" style={{ marginBottom: 20 }}>
 <ResponsiveContainer width="100%" height={Math.max(180, buildings.length * 48)}>
 <BarChart data={buildings} layout="vertical" margin={{ left: 180 }}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis type="number" tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${(v / 1000).toFixed(0)}k`} />
 <YAxis type="category" dataKey="name" tick={{ fill: C.textMuted, fontSize: 11 }} width={170} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v, 0)} />
 <Legend wrapperStyle={{ fontSize: 11 }} />
 <Bar dataKey="eCost" stackId="a" fill={C.energy} name="Energia" />
 <Bar dataKey="gCost" stackId="a" fill={C.gas} name="Gas" />
 <Bar dataKey="fCost" stackId="a" fill={C.fixed} name="Fisso" />
 <Bar dataKey="cCost" stackId="a" fill={C.conn} name="Connettività" />
 <Bar dataKey="mCost" stackId="a" fill={C.mobile} name="Mobile" radius={[0, 4, 4, 0]} />
 </BarChart>
 </ResponsiveContainer>
 </ChartCard>

 {/* Sites cards grid */}
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
 <SectionTitle sub="Seleziona un sito per aprire la scheda di dettaglio" style={{ marginBottom: 0 }}>Elenco Siti</SectionTitle>
 <div style={{ position: "relative" }}>
 <input
 type="text"
 value={searchQuery}
 onChange={e => setSearchQuery(e.target.value)}
 placeholder=" Cerca sito, città, indirizzo..."
 style={{
 padding: "9px 14px 9px 14px", borderRadius: 10,
 border: `1px solid ${searchQuery ? C.accent : C.border}`,
 background: searchQuery ? `${C.accent}08` : C.card,
 color: C.text, fontSize: 12, fontFamily: "inherit",
 width: 280, outline: "none", transition: "all 0.2s",
 }}
 />
 {searchQuery && (
 <button onClick={() => setSearchQuery("")} style={{
 position: "absolute", right: 8, top: "50%", transform: "translateY(-50%)",
 border: "none", background: "transparent", color: C.textDim,
 fontSize: 14, cursor: "pointer", padding: 2,
 }}></button>
 )}
 </div>
 </div>
 {(() => {
 const q = searchQuery.toLowerCase().trim();
 const filtered = q ? buildings.filter(b =>
 b.name.toLowerCase().includes(q) ||
 b.address.toLowerCase().includes(q) ||
 b.city.toLowerCase().includes(q) ||
 (b.companyObj?.name || "").toLowerCase().includes(q) ||
 (b.companyObj?.short || "").toLowerCase().includes(q) ||
 b.id.toLowerCase().includes(q)
 ) : buildings;
 return filtered.length === 0 ? (
 <div style={{ textAlign: "center", padding: 40, color: C.textDim, fontSize: 13 }}>
 Nessun sito trovato per "{searchQuery}". Prova con un altro termine.
 </div>
 ) : (
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(340px, 1fr))", gap: 14 }}>
 {filtered.map(bld => (
 <div key={bld.id} onClick={() => setSelectedBuilding(bld.id)} style={{
 background: C.card, borderRadius: 14, border: `1px solid ${C.border}`,
 padding: 18, cursor: "pointer", transition: "all 0.2s",
 position: "relative", overflow: "hidden",
 }}
 onMouseEnter={e => { e.currentTarget.style.borderColor = bld.companyObj?.color || C.accent; e.currentTarget.style.transform = "translateY(-2px)"; }}
 onMouseLeave={e => { e.currentTarget.style.borderColor = C.border; e.currentTarget.style.transform = "translateY(0)"; }}
 >
 {/* Top color stripe */}
 <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 3, background: `linear-gradient(90deg, ${C.energy}, ${C.gas}, ${C.fixed}, ${C.conn}, ${C.mobile})` }} />

 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 10 }}>
 <div>
 <div style={{ fontSize: 14, fontWeight: 700, color: C.text }}> {bld.name}</div>
 <div style={{ fontSize: 11, color: C.textDim, marginTop: 2 }}>{bld.address}</div>
 </div>
 <Badge color={bld.companyObj?.color || C.accent}>{bld.companyObj?.short || "—"}</Badge>
 </div>

 {/* Cost highlight */}
 <div style={{ fontSize: 22, fontWeight: 700, color: C.accentLight, marginBottom: 10 }}>
 {fmtEuro(bld.totalCost, 0)}
 <span style={{ fontSize: 11, fontWeight: 400, color: C.textDim, marginLeft: 6 }}>/anno</span>
 </div>

 {/* Mini utility breakdown */}
 <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 10 }}>
 {bld.eCost > 0 && <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 5, background: `${C.energy}15`, color: C.energy, fontWeight: 600 }}> {fmtEuro(bld.eCost, 0)}</span>}
 {bld.gCost > 0 && <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 5, background: `${C.gas}15`, color: C.gas, fontWeight: 600 }}> {fmtEuro(bld.gCost, 0)}</span>}
 {(bld.fCost + bld.cCost + bld.mCost) > 0 && <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 5, background: `${C.fixed}15`, color: C.fixed, fontWeight: 600 }}> {fmtEuro(bld.fCost + bld.cCost + bld.mCost, 0)}</span>}
 </div>

 {/* Device counts row */}
 <div style={{ display: "flex", gap: 8, flexWrap: "wrap", paddingTop: 8, borderTop: `1px solid ${C.border}` }}>
 {bld.devices.pods.length > 0 && <span style={{ fontSize: 10, color: C.energy }}> {bld.devices.pods.length} POD</span>}
 {bld.devices.pdrs.length > 0 && <span style={{ fontSize: 10, color: C.gas }}> {bld.devices.pdrs.length} PDR</span>}
 {bld.devices.fixedLines.length > 0 && <span style={{ fontSize: 10, color: C.fixed }}> {bld.devices.fixedLines.length} fisso</span>}
 {bld.devices.connectivity.length > 0 && <span style={{ fontSize: 10, color: C.conn }}> {bld.devices.connectivity.length} conn.</span>}
 {bld.devices.mobileLines.length > 0 && <span style={{ fontSize: 10, color: C.mobile }}> {bld.devices.mobileLines.length} SIM</span>}
 <span style={{ marginLeft: "auto", fontSize: 10, color: C.accentLight, fontWeight: 600 }}>Apri scheda →</span>
 </div>
 </div>
 ))}
 </div>
 );
 })()}
 </>
 )}

 {tab === "dispositivi" && (
 <DeviceAssignmentPanel buildings={buildingsState} onAssign={assignDevice} onUnassign={unassignDevice} companyFilter={co} isAll={isAll} />
 )}
 </>
 )}
 </div>
 );
}

function DeviceAssignmentPanel({ buildings, onAssign, onUnassign, companyFilter, isAll }) {
 const [filter, setFilter] = useState("all"); // all | pods | pdrs | fixedLines | connectivity | mobileLines | unassigned

 const availableBuildings = isAll ? buildings : buildings.filter(b => b.company === companyFilter);

 // Build device-to-building map
 const deviceBuildingMap = useMemo(() => {
 const map = {};
 buildings.forEach(bld => {
 Object.entries(bld.devices).forEach(([type, ids]) => {
 ids.forEach(id => { map[`${type}:${id}`] = bld.id; });
 });
 });
 return map;
 }, [buildings]);

 // All devices (unfiltered by type)
 const allDevicesRaw = useMemo(() => {
 const devices = [];
 const filteredPods = isAll ? PODS : PODS.filter(p => p.company === companyFilter);
 const filteredPdrs = isAll ? PDRS : PDRS.filter(p => p.company === companyFilter);
 const filteredMobile = isAll ? MOBILE_LINES : MOBILE_LINES.filter(l => l.company === companyFilter);
 const filteredFixed = isAll ? FIXED_LINES : FIXED_LINES.filter(l => l.company === companyFilter);
 const filteredConn = isAll ? CONNECTIVITY : CONNECTIVITY.filter(c => c.company === companyFilter);

 filteredPods.forEach(p => devices.push({ type: "pods", typeLabel: " POD", typeColor: C.energy, id: p.id, label: p.id, detail: `${p.site} · ${p.power} kW`, person: p.person, company: p.company }));
 filteredPdrs.forEach(p => devices.push({ type: "pdrs", typeLabel: " PDR", typeColor: C.gas, id: p.id, label: p.id, detail: `${p.site} · ${p.distributor}`, person: p.person, company: p.company }));
 filteredFixed.forEach(l => devices.push({ type: "fixedLines", typeLabel: " Fisso", typeColor: C.fixed, id: l.id, label: l.id, detail: `${l.site} · ${l.service}`, person: l.person, company: l.company }));
 filteredConn.forEach(c => devices.push({ type: "connectivity", typeLabel: " Conn.", typeColor: C.conn, id: c.id, label: `${c.id} — ${c.type} ${c.band}`, detail: `${c.site} · SLA ${c.sla}`, person: "", company: c.company }));
 filteredMobile.forEach(l => devices.push({ type: "mobileLines", typeLabel: " Mobile", typeColor: C.mobile, id: l.id, label: l.id, detail: `${l.person} · ${l.profile}`, person: l.person, company: l.company }));
 return devices;
 }, [companyFilter, isAll]);

 // Apply filter
 const allDevices = useMemo(() => {
 if (filter === "all") return allDevicesRaw;
 if (filter === "unassigned") return allDevicesRaw.filter(d => !deviceBuildingMap[`${d.type}:${d.id}`]);
 return allDevicesRaw.filter(d => d.type === filter);
 }, [allDevicesRaw, filter, deviceBuildingMap]);

 const assigned = allDevicesRaw.filter(d => deviceBuildingMap[`${d.type}:${d.id}`]);
 const unassigned = allDevicesRaw.filter(d => !deviceBuildingMap[`${d.type}:${d.id}`]);

 const filterOpts = [
 { key: "all", label: "Tutti" },
 { key: "unassigned", label: ` Non associati (${unassigned.length})` },
 { key: "pods", label: "POD" },
 { key: "pdrs", label: "PDR" },
 { key: "fixedLines", label: "Fisso" },
 { key: "connectivity", label: "Conn." },
 { key: "mobileLines", label: "Mobile" },
 ];

 const selectStyle = {
 padding: "5px 8px", borderRadius: 6, border: `1px solid ${C.border}`,
 background: C.bg, color: C.text, fontSize: 11, fontFamily: "inherit", cursor: "pointer",
 minWidth: 140,
 };

 return (
 <div>
 <div style={{
 background: `linear-gradient(135deg, #8B5CF611, #06B6D411)`,
 borderRadius: 12, padding: "12px 16px", border: `1px solid #8B5CF622`,
 fontSize: 12, color: C.textMuted, lineHeight: 1.6, marginBottom: 20,
 }}>
 Elenco completo di tutti i dispositivi. Usa il menu a tendina per associare o spostare un dispositivo in un sito. I costi vengono ricalcolati automaticamente nella panoramica.
 </div>

 {/* Filter pills */}
 <div style={{ display: "flex", gap: 4, marginBottom: 16, flexWrap: "wrap" }}>
 {filterOpts.map(f => (
 <button key={f.key} onClick={() => setFilter(f.key)} style={{
 padding: "6px 14px", borderRadius: 20,
 border: `1px solid ${filter === f.key ? (f.key === "unassigned" ? C.warn : C.accent) : C.border}`,
 background: filter === f.key ? (f.key === "unassigned" ? `${C.warn}22` : `${C.accent}22`) : C.card,
 color: filter === f.key ? (f.key === "unassigned" ? C.warn : C.accentLight) : C.textMuted,
 fontSize: 11, fontWeight: 500, cursor: "pointer", fontFamily: "inherit",
 }}>{f.label}</button>
 ))}
 <span style={{ marginLeft: 12, fontSize: 11, color: C.textDim, alignSelf: "center" }}>
 {filter !== "all" ? `${allDevices.length} filtrati · ` : ""}{allDevicesRaw.length} totali · {assigned.length} associati · {unassigned.length} non associati
 </span>
 </div>

 {/* Devices table */}
 <div style={{ background: C.card, borderRadius: 12, border: `1px solid ${C.border}`, overflow: "hidden" }}>
 {/* Header */}
 <div style={{ display: "grid", gridTemplateColumns: "90px 1fr 1.2fr 140px 200px 80px", padding: "10px 14px", borderBottom: `1px solid ${C.border}`, fontSize: 11, fontWeight: 600, color: C.textDim, textTransform: "uppercase", letterSpacing: 0.5 }}>
 <span>Tipo</span>
 <span>ID Dispositivo</span>
 <span>Dettaglio</span>
 <span>Azienda</span>
 <span>Sito Associato</span>
 <span></span>
 </div>

 {/* Rows */}
 <div style={{ maxHeight: 520, overflowY: "auto" }}>
 {allDevices.map((dev, i) => {
 const currentBldId = deviceBuildingMap[`${dev.type}:${dev.id}`];
 const currentBld = buildings.find(b => b.id === currentBldId);
 const companyObj = COMPANIES.find(c => c.id === dev.company);

 return (
 <div key={`${dev.type}-${dev.id}`} style={{
 display: "grid", gridTemplateColumns: "90px 1fr 1.2fr 140px 200px 80px",
 padding: "9px 14px", borderBottom: `1px solid ${C.border}08`,
 fontSize: 12, alignItems: "center",
 background: i % 2 === 0 ? "transparent" : `${C.bg}40`,
 }}>
 <span>
 <span style={{
 display: "inline-block", padding: "2px 8px", borderRadius: 6,
 background: `${dev.typeColor}18`, color: dev.typeColor,
 fontSize: 10, fontWeight: 700,
 }}>{dev.typeLabel}</span>
 </span>
 <span style={{ fontWeight: 600, color: C.text, fontSize: 11 }}>{dev.label}</span>
 <span style={{ fontSize: 11, color: C.textMuted }}>{dev.detail}</span>
 <span><Badge color={companyObj?.color || C.textDim}>{companyObj?.short || "—"}</Badge></span>
 <span>
 <select
 value={currentBldId || "__none__"}
 onChange={e => {
 const val = e.target.value;
 if (val === "__none__") { onUnassign(dev.type, dev.id); }
 else { onAssign(dev.type, dev.id, val); }
 }}
 style={{
 ...selectStyle,
 borderColor: currentBldId ? `${C.accent}66` : `${C.warn}44`,
 background: currentBldId ? `${C.accent}08` : `${C.warn}08`,
 }}
 >
 <option value="__none__">— Non associato —</option>
 {availableBuildings.map(b => (
 <option key={b.id} value={b.id}>{b.name}</option>
 ))}
 </select>
 </span>
 <span style={{ textAlign: "center" }}>
 {currentBldId && (
 <button onClick={() => onUnassign(dev.type, dev.id)} title="Rimuovi associazione" style={{
 padding: "3px 8px", borderRadius: 6, border: `1px solid ${C.danger}44`,
 background: `${C.danger}11`, color: C.danger,
 fontSize: 10, cursor: "pointer", fontFamily: "inherit",
 }}></button>
 )}
 </span>
 </div>
 );
 })}
 </div>
 </div>
 </div>
 );
}

function BuildingDetail({ building: b, onClose }) {
 const { energyData, gasData } = useCompanyFilter();
 const [detailTab, setDetailTab] = useState("overview");

 // Period filter for this building
 const bldEnergyAll = useMemo(() => energyData.filter(d => b.devices.pods.includes(d.pod)), [energyData, b.devices.pods]);
 const bldGasAll = useMemo(() => gasData.filter(d => b.devices.pdrs.includes(d.pdr)), [gasData, b.devices.pdrs]);
 const { preset, setPreset, filtered: filtEnergy, customFrom, setCustomFrom, customTo, setCustomTo } = usePeriodFilter(bldEnergyAll);
 const filtGas = useMemo(() => {
  if (preset === "all") return bldGasAll;
  if (preset === "custom") {
   return bldGasAll.filter(d => {
    const ym = d.anno * 100 + d.meseConsumi;
    const from = customFrom ? parseInt(customFrom.split("-")[0]) * 100 + parseInt(customFrom.split("-")[1]) - 1 : 0;
    const to = customTo ? parseInt(customTo.split("-")[0]) * 100 + parseInt(customTo.split("-")[1]) - 1 : 999999;
    return ym >= from && ym <= to;
   });
  }
  const now = new Date();
  const nowY = now.getFullYear();
  const presetFilters = {
   "2022": d => d.anno === 2022, "2023": d => d.anno === 2023, "2024": d => d.anno === 2024,
   "2025": d => d.anno === 2025, "2026": d => d.anno === 2026,
   "last12": d => { const dm = d.anno * 12 + d.meseConsumi; const nm = nowY * 12 + now.getMonth(); return dm >= nm - 11 && dm <= nm; },
   "last24": d => { const dm = d.anno * 12 + d.meseConsumi; const nm = nowY * 12 + now.getMonth(); return dm >= nm - 23 && dm <= nm; },
  };
  const fn = presetFilters[preset];
  return fn ? bldGasAll.filter(fn) : bldGasAll;
 }, [bldGasAll, preset, customFrom, customTo]);

 // Recompute all costs from filtered data
 const eCost = filtEnergy.reduce((s, d) => s + d.totaleFattura, 0);
 const eKwh = filtEnergy.reduce((s, d) => s + d.consumoTotale, 0);
 const gCost = filtGas.reduce((s, d) => s + d.totaleFattura, 0);
 const gSmc = filtGas.reduce((s, d) => s + d.consumoSmc, 0);
 const fCost = FIXED_LINES.filter(l => b.devices.fixedLines.includes(l.id)).reduce((s, l) => s + l.monthlyCost * 12, 0);
 const cCost = CONNECTIVITY.filter(c => b.devices.connectivity.includes(c.id)).reduce((s, c) => s + c.monthlyCost * 12, 0);
 const mCost = MOBILE_LINES.filter(l => b.devices.mobileLines.includes(l.id)).reduce((s, l) => s + l.fixedCost * 12, 0);
 const totalCost = eCost + gCost + fCost + cCost + mCost;

 // Monthly data from filtered period
 const monthly = useMemo(() => {
  const months = {};
  filtEnergy.forEach(d => {
   const k = `${d.anno}-${d.meseConsumi}`;
   if (!months[k]) months[k] = { anno: d.anno, m: d.meseConsumi, name: `${MONTHS[d.meseConsumi]} ${String(d.anno).slice(2)}`, energia: 0, gas: 0, fisso: 0, conn: 0, mobile: 0, totale: 0 };
   months[k].energia += d.totaleFattura;
  });
  filtGas.forEach(d => {
   const k = `${d.anno}-${d.meseConsumi}`;
   if (!months[k]) months[k] = { anno: d.anno, m: d.meseConsumi, name: `${MONTHS[d.meseConsumi]} ${String(d.anno).slice(2)}`, energia: 0, gas: 0, fisso: 0, conn: 0, mobile: 0, totale: 0 };
   months[k].gas += d.totaleFattura;
  });
  const mf = FIXED_LINES.filter(l => b.devices.fixedLines.includes(l.id)).reduce((s, l) => s + l.monthlyCost, 0);
  const mc = CONNECTIVITY.filter(c => b.devices.connectivity.includes(c.id)).reduce((s, c) => s + c.monthlyCost, 0);
  const mm = MOBILE_LINES.filter(l => b.devices.mobileLines.includes(l.id)).reduce((s, l) => s + l.fixedCost, 0);
  Object.values(months).forEach(d => { d.fisso = +mf.toFixed(0); d.conn = +mc.toFixed(0); d.mobile = +mm.toFixed(0); d.totale = +(d.energia + d.gas + d.fisso + d.conn + d.mobile).toFixed(0); d.energia = +d.energia.toFixed(0); d.gas = +d.gas.toFixed(0); });
  return Object.values(months).sort((a, b) => a.anno * 12 + a.m - (b.anno * 12 + b.m));
 }, [filtEnergy, filtGas, b.devices]);

 const utilBreakdown = [
 { name: "Energia Elettrica", value: +eCost.toFixed(0), color: C.energy, detail: `${fmt(eKwh)} kWh · ${b.devices.pods.length} POD` },
 { name: "Gas Naturale", value: +gCost.toFixed(0), color: C.gas, detail: `${fmt(gSmc)} Smc · ${b.devices.pdrs.length} PDR` },
 { name: "Telefonia Fissa", value: +fCost.toFixed(0), color: C.fixed, detail: `${b.devices.fixedLines.length} linee` },
 { name: "Connettività", value: +cCost.toFixed(0), color: C.conn, detail: `${b.devices.connectivity.length} circuiti` },
 { name: "Telefonia Mobile", value: +mCost.toFixed(0), color: C.mobile, detail: `${b.devices.mobileLines.length} SIM` },
 ].filter(u => u.value > 0);

 const podDetails = useMemo(() => b.devices.pods.map(podId => {
 const pod = PODS.find(p => p.id === podId);
 const rows = filtEnergy.filter(d => d.pod === podId);
 const totKwh = rows.reduce((s, d) => s + d.consumoTotale, 0);
 const totEuro = rows.reduce((s, d) => s + d.totaleFattura, 0);
 const monthlyPod = Array.from({ length: 12 }, (_, m) => {
 const mr = rows.filter(d => d.meseConsumi === m);
 return { name: MONTHS[m], kwh: mr.reduce((s, d) => s + d.consumoTotale, 0), euro: +mr.reduce((s, d) => s + d.totaleFattura, 0).toFixed(0) };
 });
 return { pod, podId, totKwh, totEuro, monthly: monthlyPod };
 }), [filtEnergy, b.devices.pods]);

 const pdrDetails = useMemo(() => b.devices.pdrs.map(pdrId => {
 const pdr = PDRS.find(p => p.id === pdrId);
 const rows = filtGas.filter(d => d.pdr === pdrId);
 const totSmc = rows.reduce((s, d) => s + d.consumoSmc, 0);
 const totEuro = rows.reduce((s, d) => s + d.totaleFattura, 0);
 const monthlyPdr = Array.from({ length: 12 }, (_, m) => {
 const mr = rows.filter(d => d.meseConsumi === m);
 return { name: MONTHS[m], smc: mr.reduce((s, d) => s + d.consumoSmc, 0), euro: +mr.reduce((s, d) => s + d.totaleFattura, 0).toFixed(0) };
 });
 return { pdr, pdrId, totSmc, totEuro, monthly: monthlyPdr };
 }), [filtGas, b.devices.pdrs]);

 const companyObj = COMPANIES.find(c => c.id === b.company);
 const detailTabs = [
 { key: "overview", label: "Panoramica" },
 { key: "energia", label: "Energia" },
 { key: "gas", label: "Gas" },
 { key: "tlc", label: "TLC & Conn." },
 { key: "dispositivi", label: "Dispositivi" },
 ];

 return (
 <div style={{ marginTop: 20 }}>
 {/* Header bar */}
 <div style={{
 background: `linear-gradient(135deg, ${companyObj?.color || C.accent}15, ${C.card})`,
 borderRadius: 14, border: `1px solid ${companyObj?.color || C.accent}33`,
 padding: "18px 22px", marginBottom: 20,
 }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
 <div>
 <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 6 }}>
 <span style={{ fontSize: 28 }}></span>
 <div>
 <div style={{ fontSize: 20, fontWeight: 700, color: C.text }}>{b.name}</div>
 <div style={{ fontSize: 12, color: C.textDim }}>{b.address}</div>
 </div>
 </div>
 <div style={{ display: "flex", gap: 12, marginTop: 8, flexWrap: "wrap" }}>
 <span style={{ fontSize: 11, color: C.textMuted, background: C.bg, padding: "3px 10px", borderRadius: 6 }}> {fmt(b.sqm)} m²</span>
 <span style={{ fontSize: 11, color: C.textMuted, background: C.bg, padding: "3px 10px", borderRadius: 6 }}> {b.floors} piani</span>
 <span style={{ fontSize: 11, color: C.textMuted, background: C.bg, padding: "3px 10px", borderRadius: 6 }}> {b.numDevices} dispositivi</span>
 <span style={{ fontSize: 11, color: C.textMuted, background: C.bg, padding: "3px 10px", borderRadius: 6 }}> {b.city}</span>
 <Badge color={companyObj?.color || C.accent}>{companyObj?.short || b.company}</Badge>
 </div>
 </div>
 <button onClick={onClose} style={{
 padding: "8px 16px", borderRadius: 8, border: `1px solid ${C.border}`,
 background: C.card, color: C.textMuted, fontSize: 12, cursor: "pointer", fontFamily: "inherit",
 display: "flex", alignItems: "center", gap: 6,
 }}>← Torna alla lista</button>
 </div>
 </div>

 {/* KPIs */}
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))", gap: 14, marginBottom: 20 }}>
 <KPICard label="Costo Totale" value={fmtEuro(totalCost, 0)} color={C.accent} />
 <KPICard label="Costo Medio Mese" value={fmtEuro(monthly.length > 0 ? totalCost / monthly.length : 0, 0)} color="#8B5CF6" />
 <KPICard label="Energia" value={fmtEuro(eCost, 0)} color={C.energy} sub={`${fmt(eKwh)} kWh`} />
 <KPICard label="Gas" value={fmtEuro(gCost, 0)} color={C.gas} sub={`${fmt(gSmc)} Smc`} />
 <KPICard label="TLC & Conn." value={fmtEuro(fCost + cCost + mCost, 0)} color={C.fixed} />
 </div>

 {/* Detail tabs */}
 <div style={{ display: "flex", gap: 2, marginBottom: 14, borderBottom: `1px solid ${C.border}`, paddingBottom: 0 }}>
 {detailTabs.map(t => (
 <button key={t.key} onClick={() => setDetailTab(t.key)} style={{
 padding: "10px 16px", border: "none", borderBottom: detailTab === t.key ? `2px solid ${C.accent}` : "2px solid transparent",
 cursor: "pointer", fontSize: 12, fontWeight: 600, fontFamily: "inherit",
 background: "transparent", color: detailTab === t.key ? C.accentLight : C.textMuted,
 transition: "all 0.15s",
 }}>{t.label}</button>
 ))}
 </div>

 {/* Period filter */}
 <PeriodFilterBar preset={preset} setPreset={setPreset} customFrom={customFrom} setCustomFrom={setCustomFrom} customTo={customTo} setCustomTo={setCustomTo} />

 {/* OVERVIEW TAB */}
 {detailTab === "overview" && (
 <div>
 <div style={{ display: "grid", gridTemplateColumns: "1fr 2fr", gap: 16, marginBottom: 20 }}>
 <ChartCard title="Ripartizione Costi per Utility">
 <ResponsiveContainer width="100%" height={220}>
 <PieChart>
 <Pie data={utilBreakdown} dataKey="value" nameKey="name" cx="50%" cy="50%" innerRadius={50} outerRadius={85} paddingAngle={3} strokeWidth={0}>
 {utilBreakdown.map((u, i) => <Cell key={i} fill={u.color} />)}
 </Pie>
 <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v, 0)} />
 </PieChart>
 </ResponsiveContainer>
 <div style={{ display: "flex", flexDirection: "column", gap: 6, padding: "0 8px" }}>
 {utilBreakdown.map(u => (
 <div key={u.name} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", fontSize: 11 }}>
 <span style={{ color: C.textMuted }}>
 <span style={{ display: "inline-block", width: 8, height: 8, borderRadius: 2, background: u.color, marginRight: 6, verticalAlign: "middle" }} />
 {u.name}
 </span>
 <span style={{ fontWeight: 600, color: u.color }}>{fmtEuro(u.value, 0)}</span>
 </div>
 ))}
 </div>
 </ChartCard>
 <ChartCard title="Trend Mensile — Tutte le Utility">
 <ResponsiveContainer width="100%" height={280}>
 <ComposedChart data={monthly}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 11 }} />
 <YAxis tick={{ fill: C.textDim, fontSize: 11 }} tickFormatter={v => `€${(v / 1000).toFixed(0)}k`} />
 <Tooltip contentStyle={customTooltipStyle} formatter={v => fmtEuro(v, 0)} />
 <Legend wrapperStyle={{ fontSize: 10 }} />
 <Bar dataKey="energia" stackId="a" fill={C.energy} name="Energia" />
 <Bar dataKey="gas" stackId="a" fill={C.gas} name="Gas" />
 <Bar dataKey="fisso" stackId="a" fill={C.fixed} name="Fisso" />
 <Bar dataKey="conn" stackId="a" fill={C.conn} name="Conn." />
 <Bar dataKey="mobile" stackId="a" fill={C.mobile} name="Mobile" radius={[4, 4, 0, 0]} />
 <Line dataKey="totale" stroke={C.text} strokeWidth={2} dot={false} name="Totale" />
 </ComposedChart>
 </ResponsiveContainer>
 </ChartCard>
 </div>
 {/* Monthly cost table */}
 <ChartCard title="Dettaglio Mensile per Utility (€)" style={{ marginBottom: 20 }}>
 <div style={{ overflowX: "auto" }}>
 <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11 }}>
 <thead>
 <tr style={{ borderBottom: `1px solid ${C.border}` }}>
 <th style={{ textAlign: "left", padding: "6px 8px", color: C.textDim, fontWeight: 600 }}>Utility</th>
 {monthly.map((m, i) => <th key={i} style={{ textAlign: "right", padding: "6px 6px", color: C.textDim, fontWeight: 600 }}>{m.name}</th>)}
 <th style={{ textAlign: "right", padding: "6px 8px", color: C.accentLight, fontWeight: 700 }}>TOTALE</th>
 </tr>
 </thead>
 <tbody>
 {[
 { key: "energia", label: "Energia", color: C.energy },
 { key: "gas", label: "Gas", color: C.gas },
 { key: "fisso", label: "Fisso", color: C.fixed },
 { key: "conn", label: "Conn.", color: C.conn },
 { key: "mobile", label: "Mobile", color: C.mobile },
 ].map(row => (
 <tr key={row.key} style={{ borderBottom: `1px solid ${C.border}08` }}>
 <td style={{ padding: "6px 8px", fontWeight: 600, color: row.color }}>{row.label}</td>
 {monthly.map((m, i) => <td key={i} style={{ textAlign: "right", padding: "6px 6px", color: C.textMuted }}>{m[row.key] > 0 ? fmtEuro(m[row.key], 0) : "—"}</td>)}
 <td style={{ textAlign: "right", padding: "6px 8px", fontWeight: 700, color: row.color }}>{fmtEuro(monthly.reduce((s, m) => s + m[row.key], 0), 0)}</td>
 </tr>
 ))}
 <tr style={{ borderTop: `2px solid ${C.border}` }}>
 <td style={{ padding: "8px 8px", fontWeight: 700, color: C.text }}>TOTALE</td>
 {monthly.map((m, i) => <td key={i} style={{ textAlign: "right", padding: "8px 6px", fontWeight: 700, color: C.accentLight }}>{fmtEuro(m.totale, 0)}</td>)}
 <td style={{ textAlign: "right", padding: "8px 8px", fontWeight: 700, fontSize: 13, color: C.accentLight }}>{fmtEuro(totalCost, 0)}</td>
 </tr>
 </tbody>
 </table>
 </div>
 </ChartCard>
 </div>
 )}

 {/* ENERGIA TAB */}
 {detailTab === "energia" && (
 <div>
 {podDetails.length === 0 ? (
 <div style={{ textAlign: "center", padding: 40, color: C.textDim }}>Nessun POD associato a questo sito.</div>
 ) : podDetails.map(({ pod, podId, totKwh, totEuro, monthly }) => (
 <div key={podId} style={{ background: C.card, borderRadius: 12, border: `1px solid ${C.energy}22`, padding: 16, marginBottom: 16 }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
 <div>
 <div style={{ fontSize: 14, fontWeight: 700, color: C.energy }}> POD: {podId}</div>
 <div style={{ fontSize: 11, color: C.textDim }}>{pod?.site} · {pod?.power} kW · {pod?.person} · {pod?.cdc}</div>
 </div>
 <div style={{ textAlign: "right" }}>
 <div style={{ fontSize: 16, fontWeight: 700, color: C.energy }}>{fmtEuro(totEuro, 0)}</div>
 <div style={{ fontSize: 11, color: C.textDim }}>{fmt(totKwh)} kWh</div>
 </div>
 </div>
 <ResponsiveContainer width="100%" height={180}>
 <ComposedChart data={monthly}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 10 }} />
 <YAxis yAxisId="kwh" tick={{ fill: C.textDim, fontSize: 10 }} tickFormatter={v => `${(v/1000).toFixed(0)}k`} />
 <YAxis yAxisId="eur" orientation="right" tick={{ fill: C.energy, fontSize: 10 }} tickFormatter={v => `€${(v/1000).toFixed(0)}k`} />
 <Tooltip contentStyle={customTooltipStyle} />
 <Bar yAxisId="kwh" dataKey="kwh" fill={`${C.energy}44`} name="kWh" radius={[3,3,0,0]} />
 <Line yAxisId="eur" dataKey="euro" stroke={C.energy} strokeWidth={2} dot={{ r: 3 }} name="€" />
 </ComposedChart>
 </ResponsiveContainer>
 </div>
 ))}
 </div>
 )}

 {/* GAS TAB */}
 {detailTab === "gas" && (
 <div>
 {pdrDetails.length === 0 ? (
 <div style={{ textAlign: "center", padding: 40, color: C.textDim }}>Nessun PDR associato a questo sito.</div>
 ) : pdrDetails.map(({ pdr, pdrId, totSmc, totEuro, monthly }) => (
 <div key={pdrId} style={{ background: C.card, borderRadius: 12, border: `1px solid ${C.gas}22`, padding: 16, marginBottom: 16 }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
 <div>
 <div style={{ fontSize: 14, fontWeight: 700, color: C.gas }}> PDR: {pdrId}</div>
 <div style={{ fontSize: 11, color: C.textDim }}>{pdr?.site} · {pdr?.distributor} · {pdr?.person} · {pdr?.cdc}</div>
 </div>
 <div style={{ textAlign: "right" }}>
 <div style={{ fontSize: 16, fontWeight: 700, color: C.gas }}>{fmtEuro(totEuro, 0)}</div>
 <div style={{ fontSize: 11, color: C.textDim }}>{fmt(totSmc)} Smc</div>
 </div>
 </div>
 <ResponsiveContainer width="100%" height={180}>
 <ComposedChart data={monthly}>
 <CartesianGrid strokeDasharray="3 3" stroke={C.border} />
 <XAxis dataKey="name" tick={{ fill: C.textDim, fontSize: 10 }} />
 <YAxis yAxisId="smc" tick={{ fill: C.textDim, fontSize: 10 }} />
 <YAxis yAxisId="eur" orientation="right" tick={{ fill: C.gas, fontSize: 10 }} tickFormatter={v => `€${v}`} />
 <Tooltip contentStyle={customTooltipStyle} />
 <Bar yAxisId="smc" dataKey="smc" fill={`${C.gas}44`} name="Smc" radius={[3,3,0,0]} />
 <Line yAxisId="eur" dataKey="euro" stroke={C.gas} strokeWidth={2} dot={{ r: 3 }} name="€" />
 </ComposedChart>
 </ResponsiveContainer>
 </div>
 ))}
 </div>
 )}

 {/* TLC & CONN TAB */}
 {detailTab === "tlc" && (
 <div>
 {b.devices.fixedLines.length > 0 && (<>
 <SectionTitle sub={`${b.devices.fixedLines.length} linee`}> Telefonia Fissa</SectionTitle>
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(320px, 1fr))", gap: 12, marginBottom: 20 }}>
 {b.devices.fixedLines.map(id => { const line = FIXED_LINES.find(l => l.id === id); if (!line) return null; return (
 <div key={id} style={{ background: C.card, borderRadius: 10, padding: 14, border: `1px solid ${C.fixed}22` }}>
 <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
 <span style={{ fontSize: 13, fontWeight: 700, color: C.fixed }}> {id}</span>
 <span style={{ fontSize: 14, fontWeight: 700, color: C.text }}>{fmtEuro(line.monthlyCost)}/mese</span>
 </div>
 <div style={{ fontSize: 11, color: C.textMuted, marginBottom: 4 }}>Servizio: {line.service}</div>
 <div style={{ fontSize: 11, color: C.textDim }}>Sede: {line.site} · CdC: {line.cdc} · Ref: {line.person}</div>
 <div style={{ marginTop: 8, padding: "6px 10px", background: C.bg, borderRadius: 6, fontSize: 12 }}>
 Costo annuo: <strong style={{ color: C.fixed }}>{fmtEuro(line.monthlyCost * 12, 0)}</strong>
 </div>
 </div>
 ); })}
 </div>
 </>)}
 {b.devices.connectivity.length > 0 && (<>
 <SectionTitle sub={`${b.devices.connectivity.length} circuiti`}> Connettività</SectionTitle>
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(320px, 1fr))", gap: 12, marginBottom: 20 }}>
 {b.devices.connectivity.map(id => { const cir = CONNECTIVITY.find(c => c.id === id); if (!cir) return null; return (
 <div key={id} style={{ background: C.card, borderRadius: 10, padding: 14, border: `1px solid ${C.conn}22` }}>
 <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
 <span style={{ fontSize: 13, fontWeight: 700, color: C.conn }}> {id}</span>
 <Badge color={cir.sla === "Platinum" ? C.energy : cir.sla === "Gold" ? C.energyLight : C.textMuted}>{cir.sla}</Badge>
 </div>
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, fontSize: 11, marginBottom: 8 }}>
 <div><span style={{ color: C.textDim }}>Tipo:</span> <strong>{cir.type}</strong></div>
 <div><span style={{ color: C.textDim }}>Banda:</span> <strong>{cir.band}</strong></div>
 <div><span style={{ color: C.textDim }}>BMG:</span> <strong>{cir.bmg}</strong></div>
 <div><span style={{ color: C.textDim }}>Canone:</span> <strong style={{ color: C.conn }}>{fmtEuro(cir.monthlyCost)}/mese</strong></div>
 </div>
 <div style={{ padding: "6px 10px", background: C.bg, borderRadius: 6, fontSize: 12 }}>
 Costo annuo: <strong style={{ color: C.conn }}>{fmtEuro(cir.monthlyCost * 12, 0)}</strong>
 </div>
 </div>
 ); })}
 </div>
 </>)}
 {b.devices.mobileLines.length > 0 && (<>
 <SectionTitle sub={`${b.devices.mobileLines.length} SIM`}> Telefonia Mobile</SectionTitle>
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(320px, 1fr))", gap: 12, marginBottom: 20 }}>
 {b.devices.mobileLines.map(id => { const sim = MOBILE_LINES.find(l => l.id === id); if (!sim) return null; return (
 <div key={id} style={{ background: C.card, borderRadius: 10, padding: 14, border: `1px solid ${C.mobile}22` }}>
 <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
 <span style={{ fontSize: 13, fontWeight: 700, color: C.mobile }}> {id}</span>
 <span style={{ fontSize: 14, fontWeight: 700, color: C.text }}>{fmtEuro(sim.fixedCost)}/mese</span>
 </div>
 <div style={{ fontSize: 11, color: C.textMuted, marginBottom: 4 }}>Profilo: {sim.profile}</div>
 <div style={{ fontSize: 11, color: C.textDim }}>Utente: {sim.person} · Dept: {sim.dept} · CdC: {sim.cdc}</div>
 <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginTop: 6 }}>
 {sim.services.map(s => <span key={s} style={{ padding: "2px 6px", borderRadius: 4, background: `${C.mobile}15`, color: C.mobile, fontSize: 9, fontWeight: 600 }}>{s}</span>)}
 </div>
 <div style={{ marginTop: 8, padding: "6px 10px", background: C.bg, borderRadius: 6, fontSize: 12 }}>
 Costo annuo: <strong style={{ color: C.mobile }}>{fmtEuro(sim.fixedCost * 12, 0)}</strong>
 </div>
 </div>
 ); })}
 </div>
 </>)}
 {b.devices.fixedLines.length === 0 && b.devices.connectivity.length === 0 && b.devices.mobileLines.length === 0 && (
 <div style={{ textAlign: "center", padding: 40, color: C.textDim }}>Nessun dispositivo TLC/Connettività associato.</div>
 )}
 </div>
 )}

 {/* DISPOSITIVI TAB */}
 {detailTab === "dispositivi" && (
 <div>
 <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(300px, 1fr))", gap: 12 }}>
 {b.devices.pods.map(id => { const pod = PODS.find(p => p.id === id); const cost = energyData.filter(d => d.pod === id).reduce((s, d) => s + d.totaleFattura, 0); const kwh = energyData.filter(d => d.pod === id).reduce((s, d) => s + d.consumoTotale, 0); return pod ? (
 <div key={id} style={{ background: C.bg, borderRadius: 12, padding: 14, border: `1px solid ${C.energy}22` }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
 <span style={{ fontSize: 11, fontWeight: 700, color: C.energy, background: `${C.energy}15`, padding: "2px 8px", borderRadius: 4 }}> POD</span>
 <span style={{ fontSize: 14, fontWeight: 700, color: C.energy }}>{fmtEuro(cost, 0)}</span>
 </div>
 <div style={{ fontSize: 13, fontWeight: 600, color: C.text, marginTop: 6 }}>{id}</div>
 <div style={{ fontSize: 11, color: C.textDim, marginTop: 2 }}>{pod.site}</div>
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginTop: 8, fontSize: 11 }}>
 <div><span style={{ color: C.textDim }}>Potenza:</span> <strong>{pod.power} kW</strong></div>
 <div><span style={{ color: C.textDim }}>Consumo:</span> <strong>{fmt(kwh)} kWh</strong></div>
 <div><span style={{ color: C.textDim }}>Referente:</span> {pod.person}</div>
 <div><span style={{ color: C.textDim }}>CdC:</span> {pod.cdc}</div>
 </div>
 </div>
 ) : null; })}
 {b.devices.pdrs.map(id => { const pdr = PDRS.find(p => p.id === id); const cost = gasData.filter(d => d.pdr === id).reduce((s, d) => s + d.totaleFattura, 0); const smc = gasData.filter(d => d.pdr === id).reduce((s, d) => s + d.consumoSmc, 0); return pdr ? (
 <div key={id} style={{ background: C.bg, borderRadius: 12, padding: 14, border: `1px solid ${C.gas}22` }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
 <span style={{ fontSize: 11, fontWeight: 700, color: C.gas, background: `${C.gas}15`, padding: "2px 8px", borderRadius: 4 }}> PDR</span>
 <span style={{ fontSize: 14, fontWeight: 700, color: C.gas }}>{fmtEuro(cost, 0)}</span>
 </div>
 <div style={{ fontSize: 13, fontWeight: 600, color: C.text, marginTop: 6 }}>{id}</div>
 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginTop: 8, fontSize: 11 }}>
 <div><span style={{ color: C.textDim }}>Consumo:</span> <strong>{fmt(smc)} Smc</strong></div>
 <div><span style={{ color: C.textDim }}>Distrib.:</span> {pdr.distributor}</div>
 <div><span style={{ color: C.textDim }}>Referente:</span> {pdr.person}</div>
 <div><span style={{ color: C.textDim }}>CdC:</span> {pdr.cdc}</div>
 </div>
 </div>
 ) : null; })}
 {b.devices.fixedLines.map(id => { const line = FIXED_LINES.find(l => l.id === id); return line ? (
 <div key={id} style={{ background: C.bg, borderRadius: 12, padding: 14, border: `1px solid ${C.fixed}22` }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
 <span style={{ fontSize: 11, fontWeight: 700, color: C.fixed, background: `${C.fixed}15`, padding: "2px 8px", borderRadius: 4 }}> Fisso</span>
 <span style={{ fontSize: 14, fontWeight: 700, color: C.fixed }}>{fmtEuro(line.monthlyCost * 12, 0)}</span>
 </div>
 <div style={{ fontSize: 13, fontWeight: 600, color: C.text, marginTop: 6 }}>{id}</div>
 <div style={{ fontSize: 11, color: C.textDim, marginTop: 2 }}>{line.service}</div>
 </div>
 ) : null; })}
 {b.devices.connectivity.map(id => { const cir = CONNECTIVITY.find(c => c.id === id); return cir ? (
 <div key={id} style={{ background: C.bg, borderRadius: 12, padding: 14, border: `1px solid ${C.conn}22` }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
 <span style={{ fontSize: 11, fontWeight: 700, color: C.conn, background: `${C.conn}15`, padding: "2px 8px", borderRadius: 4 }}> Conn.</span>
 <span style={{ fontSize: 14, fontWeight: 700, color: C.conn }}>{fmtEuro(cir.monthlyCost * 12, 0)}</span>
 </div>
 <div style={{ fontSize: 13, fontWeight: 600, color: C.text, marginTop: 6 }}>{id} — {cir.type} {cir.band}</div>
 <div style={{ fontSize: 11, color: C.textDim, marginTop: 2 }}>SLA: {cir.sla} · BMG: {cir.bmg}</div>
 </div>
 ) : null; })}
 {b.devices.mobileLines.map(id => { const sim = MOBILE_LINES.find(l => l.id === id); return sim ? (
 <div key={id} style={{ background: C.bg, borderRadius: 12, padding: 14, border: `1px solid ${C.mobile}22` }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
 <span style={{ fontSize: 11, fontWeight: 700, color: C.mobile, background: `${C.mobile}15`, padding: "2px 8px", borderRadius: 4 }}> Mobile</span>
 <span style={{ fontSize: 14, fontWeight: 700, color: C.mobile }}>{fmtEuro(sim.fixedCost * 12, 0)}</span>
 </div>
 <div style={{ fontSize: 13, fontWeight: 600, color: C.text, marginTop: 6 }}>{id}</div>
 <div style={{ fontSize: 11, color: C.textDim, marginTop: 2 }}>{sim.person} · {sim.profile}</div>
 </div>
 ) : null; })}
 </div>
 {b.numDevices === 0 && <div style={{ textAlign: "center", padding: 40, color: C.textDim }}>Nessun dispositivo associato.</div>}
 </div>
 )}
 </div>
 );
}

const NAV_ITEMS = [
 { key: "overview", label: "Dashboard Generale" },
 { key: "energia", label: "Energia Elettrica" },
 { key: "gas", label: "Gas Naturale" },
 { key: "mobile", label: "Telefonia Mobile" },
 { key: "fisso", label: "Telefonia Fissa" },
 { key: "connettivita", label: "Connettività" },
 { key: "siti", label: "Vista per Sito" },
 { key: "dispositivi", label: "Anagrafica Dispositivi" },
 { key: "budget", label: "Budget Complessivo" },
 { key: "forecast", label: "Forecast E&G" },
 { key: "tickets", label: "Ticket & Assistenza" },
];

function App() {
 const [page, setPage] = useState("overview");
 const [collapsed, setCollapsed] = useState(false);
 const [selectedCompany, setSelectedCompany] = useState("all");
 const [showShortcuts, setShowShortcuts] = useState(false);
 const [showAI, setShowAI] = useState(false);

 const currentCompany = COMPANIES.find(c => c.id === selectedCompany);

 // Keyboard shortcuts
 const SHORTCUTS = useMemo(() => [
 { keys: "1", label: "Dashboard Generale", action: () => setPage("overview") },
 { keys: "2", label: "Energia Elettrica", action: () => setPage("energia") },
 { keys: "3", label: "Gas Naturale", action: () => setPage("gas") },
 { keys: "4", label: "Telefonia Mobile", action: () => setPage("mobile") },
 { keys: "5", label: "Telefonia Fissa", action: () => setPage("fisso") },
 { keys: "6", label: "Connettività", action: () => setPage("connettivita") },
 { keys: "7", label: "Vista Sito", action: () => setPage("siti") },
 { keys: "8", label: "Anagrafica Dispositivi", action: () => setPage("dispositivi") },
 { keys: "9", label: "Budget Complessivo", action: () => setPage("budget") },
 { keys: "0", label: "Forecast E&G", action: () => setPage("forecast") },
 { keys: "B", label: "Sidebar on/off", action: () => setCollapsed(c => !c) },
 { keys: "A", label: "Vista Aggregato", action: () => setSelectedCompany("all") },
 { keys: "?", label: "Mostra scorciatoie", action: () => setShowShortcuts(s => !s) },
 ], []);

 useEffect(() => {
 const handler = (e) => {
 if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT") return;
 if (e.key === "Escape" && showAI) { setShowAI(false); return; }
 const key = e.key.toUpperCase();
 const shortcut = SHORTCUTS.find(s => s.keys.toUpperCase() === key);
 if (shortcut) { e.preventDefault(); shortcut.action(); }
 };
 window.addEventListener("keydown", handler);
 return () => window.removeEventListener("keydown", handler);
 }, [SHORTCUTS, showAI]);

 const renderPage = () => {
 switch (page) {
 case "overview": return <OverviewDashboard />;
 case "energia": return <EnergyDashboard />;
 case "gas": return <GasDashboard />;
 case "mobile": return <MobileDashboard />;
 case "fisso": return <FixedDashboard />;
 case "connettivita": return <ConnDashboard />;
 case "siti": return <BuildingDashboard />;
 case "dispositivi": return <DeviceRegistry />;
 case "budget": return <BudgetOverview />;
 case "forecast": return <ForecastDashboard />;
 case "tickets": return <TicketCenter />;
 default: return <OverviewDashboard />;
 }
 };

 return (
 <CompanyContext.Provider value={{ selectedCompany }}>
 <div style={{ display: "flex", minHeight: "100vh", background: C.bg, color: C.text, fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif" }}>
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

 {/* SIDEBAR */}
 <nav style={{
 width: collapsed ? 60 : 230, minWidth: collapsed ? 60 : 230, transition: "all 0.25s ease",
 background: "linear-gradient(180deg, #3a3b45 0%, #212529 100%)", borderRight: "none", display: "flex", flexDirection: "column",
 padding: "16px 0", position: "sticky", top: 0, height: "100vh", overflow: "hidden",
 boxShadow: "2px 0 6px rgba(0,0,0,0.15)",
 }}>
 {/* Logo */}
 <div style={{ padding: "0 12px", marginBottom: 20, display: "flex", alignItems: "center", gap: 10, cursor: "pointer" }} onClick={() => setCollapsed(c => !c)}>
 {collapsed ? (
 <div style={{ width: 36, height: 36, borderRadius: 8, background: `linear-gradient(135deg, ${C.accent}, #224abe)`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, flexShrink: 0, color: "#fff" }}></div>
 ) : (
 <div style={{ width: "100%", padding: "4px 4px" }}>
 <img src={LOGO_SRC} alt="Logo" style={{ width: "100%", height: 28, objectFit: "contain", objectPosition: "left", filter: "brightness(0) invert(1)" }} />
 </div>
 )}
 </div>

 {/* Shortcut hint */}
 {!collapsed && (
 <div onClick={() => setShowShortcuts(s => !s)} style={{
 margin: "0 12px 12px", padding: "6px 10px", borderRadius: 6,
 background: "rgba(255,255,255,0.05)", border: "1px solid rgba(255,255,255,0.1)",
 fontSize: 10, color: "#adb5bd", cursor: "pointer",
 display: "flex", alignItems: "center", justifyContent: "space-between",
 }}>
 <span>⌨ Scorciatoie</span>
 <span style={{ padding: "1px 6px", borderRadius: 4, background: "rgba(255,255,255,0.1)", fontSize: 9, fontWeight: 700, color: "#fff" }}>?</span>
 </div>
 )}

 <div style={{ flex: 1, overflowY: "auto" }}>
 {NAV_ITEMS.map((item, idx) => (
 <button key={item.key} onClick={() => setPage(item.key)} style={{
 display: "flex", alignItems: "center", gap: 10, width: "100%",
 padding: collapsed ? "10px 0" : "10px 16px", justifyContent: collapsed ? "center" : "flex-start",
 border: "none", cursor: "pointer", fontSize: 13, fontFamily: "inherit", fontWeight: 500,
 background: page === item.key ? "rgba(255,255,255,0.12)" : "transparent",
 color: page === item.key ? "#fff" : "#adb5bd",
 borderLeft: page === item.key ? `3px solid ${C.accent}` : "3px solid transparent",
 transition: "all 0.15s", textAlign: "left",
 }}>
 {collapsed && <span style={{ fontSize: 9, fontWeight: 700 }}>{idx < 9 ? idx + 1 : "0"}</span>}
 {!collapsed && <>
 <span style={{ whiteSpace: "nowrap", flex: 1, textAlign: "left" }}>{item.label}</span>
 <span style={{ fontSize: 9, padding: "1px 5px", borderRadius: 3, background: "rgba(255,255,255,0.08)", color: "#adb5bd", fontWeight: 700, flexShrink: 0 }}>{idx < 9 ? idx + 1 : "0"}</span>
 </>}
 </button>
 ))}
 </div>

 {!collapsed && (
 <div style={{ padding: "12px 16px", borderTop: "1px solid rgba(255,255,255,0.1)", fontSize: 10, color: "#6c757d" }}>
 Periodo: 2025 · Demo Data<br/>
 {currentCompany?.short || "Aggregato"}
 </div>
 )}
 </nav>

 {/* SHORTCUTS OVERLAY */}
 {showShortcuts && (
 <div style={{
 position: "fixed", inset: 0, background: "rgba(0,0,0,0.6)", zIndex: 9999,
 display: "flex", alignItems: "center", justifyContent: "center",
 }} onClick={() => setShowShortcuts(false)}>
 <div onClick={e => e.stopPropagation()} style={{
 background: "#fff", borderRadius: 12, border: `1px solid ${C.border}`,
 padding: 28, width: 420, maxHeight: "80vh", overflowY: "auto",
 boxShadow: "0 10px 40px rgba(0,0,0,0.2)",
 }}>
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
 <div style={{ fontSize: 16, fontWeight: 700, color: C.text }}>⌨ Scorciatoie da tastiera</div>
 <button onClick={() => setShowShortcuts(false)} style={{ border: "none", background: "transparent", color: C.textMuted, fontSize: 18, cursor: "pointer" }}></button>
 </div>
 <div style={{ fontSize: 11, color: C.textDim, marginBottom: 16 }}>Premi un tasto per navigare. Le scorciatoie funzionano quando il cursore non è in un campo di input.</div>
 <div style={{ display: "flex", flexDirection: "column", gap: 2 }}>
 {[
 { cat: "Navigazione", items: SHORTCUTS.filter(s => !isNaN(s.keys)) },
 { cat: "Azioni", items: SHORTCUTS.filter(s => isNaN(s.keys)) },
 ].map(group => (
 <div key={group.cat}>
 <div style={{ fontSize: 10, fontWeight: 700, color: C.accent, textTransform: "uppercase", letterSpacing: 1, padding: "10px 0 4px" }}>{group.cat}</div>
 {group.items.map(s => (
 <div key={s.keys} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "7px 0", borderBottom: `1px solid ${C.border}08` }}>
 <span style={{ fontSize: 12, color: C.textMuted }}>{s.label}</span>
 <kbd style={{
 display: "inline-block", padding: "3px 10px", borderRadius: 6,
 background: C.bg, border: `1px solid ${C.border}`,
 fontSize: 12, fontWeight: 700, color: C.text, fontFamily: "'Inter', monospace",
 minWidth: 28, textAlign: "center",
 }}>{s.keys}</kbd>
 </div>
 ))}
 </div>
 ))}
 </div>
 </div>
 </div>
 )}

 {/* MAIN */}
 <div style={{ flex: 1, display: "flex", flexDirection: "column", minWidth: 0, background: C.bg }}>
 {/* TOP BAR - fixed */}
 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", background: "#fff", padding: "16px 28px", borderBottom: `1px solid ${C.border}`, boxShadow: "0 1px 4px rgba(0,0,0,0.05)", flexShrink: 0 }}>
 <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
 {/* COMPANY SELECTOR */}
 <div style={{ position: "relative" }}>
 <select
 value={selectedCompany}
 onChange={e => setSelectedCompany(e.target.value)}
 style={{
 padding: "8px 32px 8px 12px", borderRadius: 10,
 border: `1.5px solid ${selectedCompany === "all" ? C.accent : (currentCompany?.color || C.accent)}`,
 background: selectedCompany === "all" ? `${C.accent}15` : `${currentCompany?.color || C.accent}15`,
 color: C.text, fontSize: 13, fontWeight: 600, fontFamily: "inherit",
 cursor: "pointer", appearance: "none", minWidth: 220,
 backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E")`,
 backgroundRepeat: "no-repeat", backgroundPosition: "right 10px center",
 }}
 >
 {COMPANIES.map(c => (
 <option key={c.id} value={c.id}>{c.id === "all" ? " Aggregato (tutte)" : c.name}</option>
 ))}
 </select>
 </div>
 <div>
 <h1 style={{ margin: 0, fontSize: 22, fontWeight: 700, fontFamily: "'Inter', sans-serif", letterSpacing: -0.5 }}>
 {NAV_ITEMS.find(n => n.key === page)?.label}
 </h1>
 <div style={{ fontSize: 12, color: C.textDim, marginTop: 2 }}>
 2022–2026 · {selectedCompany === "all" ? "Tutte le aziende" : currentCompany?.name} · {selectedCompany === "all" ? `${COMPANIES.length - 1} società` : "Drill-down"}
 </div>
 </div>
 </div>
 <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
 <select style={{ padding: "8px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 12, fontFamily: "inherit" }}>
 <option>Dati dal 2022</option>
 </select>
 <select style={{ padding: "8px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 12, fontFamily: "inherit" }}>
 <option>Tutti i siti</option>
 <option>Torino</option>
 <option>Milano</option>
 <option>Roma</option>
 </select>
 <div onClick={() => setShowShortcuts(true)} style={{ padding: "8px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.textMuted, fontSize: 12, cursor: "pointer", display: "flex", alignItems: "center", gap: 4 }}>
 ⌨ <kbd style={{ fontSize: 10, padding: "1px 5px", borderRadius: 3, background: C.bg, border: `1px solid ${C.border}`, fontWeight: 600 }}>?</kbd>
 </div>
 <div style={{ padding: "8px 12px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.card, color: C.textMuted, fontSize: 12, cursor: "pointer" }}> Export</div>
 </div>
 </div>

 {/* SCROLLABLE CONTENT AREA */}
 <main style={{ flex: 1, overflowY: "auto", padding: "24px 28px" }}>
 {/* Company indicator bar */}
 {selectedCompany !== "all" && (
 <div style={{
 display: "flex", alignItems: "center", gap: 10, padding: "8px 14px", marginBottom: 16,
 borderRadius: 8, background: `${currentCompany?.color || C.accent}11`,
 border: `1px solid ${currentCompany?.color || C.accent}33`,
 }}>
 <div style={{ width: 8, height: 8, borderRadius: "50%", background: currentCompany?.color || C.accent }} />
 <span style={{ fontSize: 12, fontWeight: 600, color: currentCompany?.color || C.accent }}>
 Drill-down: {currentCompany?.name}
 </span>
 <span style={{ fontSize: 11, color: C.textDim, marginLeft: 4 }}>
 — Stai visualizzando solo i dati di questa azienda
 </span>
 <button onClick={() => setSelectedCompany("all")} style={{
 marginLeft: "auto", padding: "4px 10px", borderRadius: 6,
 border: `1px solid ${C.border}`, background: C.card,
 color: C.textMuted, fontSize: 11, cursor: "pointer", fontFamily: "inherit",
 }}> Torna ad Aggregato</button>
 </div>
 )}

 {renderPage()}
 </main>

 {/* FLOATING AI BUTTON */}
 <button onClick={() => setShowAI(true)} style={{
  position: "fixed", bottom: 24, left: collapsed ? 72 : 242, zIndex: 900,
  width: 48, height: 48, borderRadius: "50%", border: "none", cursor: "pointer",
  background: "linear-gradient(135deg, #4e73df, #224abe)", color: "#fff",
  boxShadow: "0 4px 16px rgba(78,115,223,0.45)", display: "flex", alignItems: "center", justifyContent: "center",
  fontSize: 20, fontWeight: 700, transition: "all 0.25s ease",
 }} title="AI Analyst (premi 0)">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
   <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1.27A7 7 0 0 1 13 22h-2a7 7 0 0 1-6.73-3H3a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
   <circle cx="10" cy="15" r="1"/><circle cx="14" cy="15" r="1"/>
  </svg>
 </button>

 {/* AI MODAL */}
 {showAI && (
  <div onClick={() => setShowAI(false)} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.45)", zIndex: 1000, display: "flex", alignItems: "center", justifyContent: "center" }}>
   <div onClick={e => e.stopPropagation()} style={{ width: "70vw", maxWidth: 900, height: "80vh", background: "#fff", borderRadius: 16, border: `1px solid ${C.border}`, boxShadow: "0 20px 60px rgba(0,0,0,0.25)", display: "flex", flexDirection: "column", overflow: "hidden" }}>
    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "14px 20px", borderBottom: `1px solid ${C.border}`, background: "linear-gradient(135deg, #4e73df11, #224abe08)" }}>
     <div style={{ fontSize: 15, fontWeight: 700, color: C.text }}>AI Analyst — Utility Intelligence</div>
     <button onClick={() => setShowAI(false)} style={{ background: "none", border: "none", fontSize: 18, color: C.textMuted, cursor: "pointer", padding: "4px 8px", borderRadius: 4 }}>✕</button>
    </div>
    <div style={{ flex: 1, overflow: "auto" }}>
     <AIAssistant />
    </div>
   </div>
  </div>
 )}
 </div>
 </div>
 </CompanyContext.Provider>
 );
}

const container = document.getElementById('root');
const root = ReactDOM.createRoot(container);
root.render(React.createElement(App));
  </script>
</body>
</html>

